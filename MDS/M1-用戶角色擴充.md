# M1 - ç”¨æˆ¶è§’è‰²æ“´å……ï¼ˆStaff æ¥­å‹™å“¡ï¼‰

## ğŸ“Œ æ¨¡å¡Šæ¦‚è¿°
**æ™‚é–“**: 0.5 å¤© | **ä¾è³´**: M0

**ç›®æ¨™**: æ·»åŠ  staff è§’è‰²ï¼Œå¯¦ç¾æ¥­å‹™å“¡å¸³è™Ÿç®¡ç†

## ğŸ”§ åœ¨ __init__.py ä¸­æ·»åŠ  APIï¼ˆä¸ä¿®æ”¹ç¾æœ‰ä»£ç¢¼ï¼‰

åœ¨ __init__.py æ–‡ä»¶**æœ«å°¾**æ·»åŠ ä»¥ä¸‹è·¯ç”±ï¼š

```python
# ==================== æ–°å¢ï¼šç”¨æˆ¶ç®¡ç† APIï¼ˆM1ï¼‰====================

@tracking_bp.route('/api/admin/users', methods=['GET'])
@admin_required
def get_users_api():
    """ç²å–ç”¨æˆ¶åˆ—è¡¨ï¼ˆä¸»ç®¡å°ˆç”¨ï¼‰"""
    conn = get_db()
    cursor = conn.cursor()
    
    role = request.args.get('role')
    search = request.args.get('search')
    
    query = 'SELECT * FROM users WHERE 1=1'
    params = []
    
    if role:
        query += ' AND role = ?'
        params.append(role)
    
    if search:
        query += ' AND (username LIKE ? OR display_name LIKE ? OR real_name LIKE ?)'
        params.extend([f'%{search}%'] * 3)
    
    cursor.execute(query, params)
    users = cursor.fetchall()
    
    result = []
    for user in users:
        # çµ±è¨ˆè©²ç”¨æˆ¶è² è²¬çš„ç”¢å“æ•¸
        cursor.execute('SELECT COUNT(*) as count FROM products WHERE handler_id = ?', (user['id'],))
        product_count = cursor.fetchone()['count']
        
        result.append({
            'user_id': user['id'],
            'username': user['username'],
            'display_name': user['display_name'],
            'real_name': user.get('real_name') or user['display_name'],
            'role': user['role'],
            'created_at': user['created_at'],
            'product_count': product_count
        })
    
    conn.close()
    return jsonify({'success': True, 'data': result})


@tracking_bp.route('/api/admin/users', methods=['POST'])
@admin_required
def create_user_api():
    """å‰µå»ºç”¨æˆ¶ï¼ˆä¸»ç®¡å°ˆç”¨ï¼‰"""
    data = request.get_json()
    
    if not data.get('username') or not data.get('password'):
        return jsonify({'success': False, 'error': 'ç”¨æˆ¶åå’Œå¯†ç¢¼ä¸èƒ½ç‚ºç©º'}), 400
    
    conn = get_db()
    cursor = conn.cursor()
    
    # æª¢æŸ¥ç”¨æˆ¶åæ˜¯å¦å·²å­˜åœ¨
    cursor.execute('SELECT id FROM users WHERE username = ?', (data['username'],))
    if cursor.fetchone():
        conn.close()
        return jsonify({'success': False, 'error': 'ç”¨æˆ¶åå·²å­˜åœ¨'}), 400
    
    # å‰µå»ºç”¨æˆ¶
    from werkzeug.security import generate_password_hash
    password_hash = generate_password_hash(data['password'])
    
    cursor.execute('''
        INSERT INTO users (username, password_hash, display_name, real_name, role)
        VALUES (?, ?, ?, ?, ?)
    ''', (
        data['username'],
        password_hash,
        data.get('display_name', data['username']),
        data.get('real_name', data.get('display_name', data['username'])),
        data.get('role', 'staff')
    ))
    
    user_id = cursor.lastrowid
    conn.commit()
    conn.close()
    
    return jsonify({
        'success': True,
        'data': {
            'user_id': user_id,
            'username': data['username'],
            'role': data.get('role', 'staff')
        }
    })


@tracking_bp.route('/api/admin/users/<int:user_id>', methods=['PUT'])
@admin_required
def update_user_api(user_id):
    """æ›´æ–°ç”¨æˆ¶è³‡æ–™ï¼ˆä¸»ç®¡å°ˆç”¨ï¼‰"""
    data = request.get_json()
    
    conn = get_db()
    cursor = conn.cursor()
    
    # æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å­˜åœ¨
    cursor.execute('SELECT * FROM users WHERE id = ?', (user_id,))
    user = cursor.fetchone()
    if not user:
        conn.close()
        return jsonify({'success': False, 'error': 'ç”¨æˆ¶ä¸å­˜åœ¨'}), 404
    
    # æ›´æ–°æ¬„ä½
    updates = []
    params = []
    
    if 'display_name' in data:
        updates.append('display_name = ?')
        params.append(data['display_name'])
    
    if 'real_name' in data:
        updates.append('real_name = ?')
        params.append(data['real_name'])
    
    if 'role' in data:
        updates.append('role = ?')
        params.append(data['role'])
    
    if updates:
        query = f"UPDATE users SET {', '.join(updates)} WHERE id = ?"
        params.append(user_id)
        cursor.execute(query, params)
        conn.commit()
    
    conn.close()
    return jsonify({'success': True, 'message': 'ç”¨æˆ¶è³‡æ–™å·²æ›´æ–°'})


@tracking_bp.route('/api/admin/users/<int:user_id>/reset-password', methods=['POST'])
@admin_required
def reset_user_password_api(user_id):
    """é‡è¨­ç”¨æˆ¶å¯†ç¢¼ï¼ˆä¸»ç®¡å°ˆç”¨ï¼‰"""
    data = request.get_json()
    new_password = data.get('new_password')
    
    if not new_password or len(new_password) < 6:
        return jsonify({'success': False, 'error': 'å¯†ç¢¼è‡³å°‘6ä½'}), 400
    
    conn = get_db()
    cursor = conn.cursor()
    
    from werkzeug.security import generate_password_hash
    password_hash = generate_password_hash(new_password)
    
    cursor.execute('UPDATE users SET password_hash = ? WHERE id = ?', (password_hash, user_id))
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'message': f'å¯†ç¢¼å·²é‡è¨­'})


@tracking_bp.route('/api/user/change-password', methods=['POST'])
@login_required
def change_own_password_api():
    """ç”¨æˆ¶ä¿®æ”¹è‡ªå·±çš„å¯†ç¢¼"""
    data = request.get_json()
    
    old_password = data.get('old_password')
    new_password = data.get('new_password')
    confirm_password = data.get('confirm_password')
    
    if not all([old_password, new_password, confirm_password]):
        return jsonify({'success': False, 'error': 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½'}), 400
    
    if new_password != confirm_password:
        return jsonify({'success': False, 'error': 'å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´'}), 400
    
    if len(new_password) < 6:
        return jsonify({'success': False, 'error': 'å¯†ç¢¼è‡³å°‘6ä½'}), 400
    
    conn = get_db()
    cursor = conn.cursor()
    
    # é©—è­‰èˆŠå¯†ç¢¼
    cursor.execute('SELECT password_hash FROM users WHERE id = ?', (session['user_id'],))
    user = cursor.fetchone()
    
    from werkzeug.security import check_password_hash, generate_password_hash
    if not check_password_hash(user['password_hash'], old_password):
        conn.close()
        return jsonify({'success': False, 'error': 'åŸå¯†ç¢¼éŒ¯èª¤'}), 400
    
    # æ›´æ–°å¯†ç¢¼
    password_hash = generate_password_hash(new_password)
    cursor.execute('UPDATE users SET password_hash = ? WHERE id = ?', (password_hash, session['user_id']))
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'message': 'å¯†ç¢¼ä¿®æ”¹æˆåŠŸ'})
```

## ğŸ¨ å‰ç«¯ï¼šç”¨æˆ¶ç®¡ç†é é¢

å‰µå»º `templates/tracking/admin/users.html`:

```html
{% extends "../base.html" %}

{% block title %}ç”¨æˆ¶ç®¡ç†{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2>ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h2>
        <button class="btn btn-primary" onclick="openNewUserModal()">+ æ–°å¢ç”¨æˆ¶</button>
    </div>
    
    <div id="users-list"></div>
</div>

<!-- æ–°å¢ç”¨æˆ¶ Modal -->
<div id="newUserModal" class="modal">
    <div class="modal-content">
        <h3>æ–°å¢ç”¨æˆ¶</h3>
        <form id="newUserForm">
            <div class="form-group">
                <label>ç”¨æˆ¶åï¼ˆç™»å…¥å¸³è™Ÿï¼‰*</label>
                <input type="text" name="username" required>
            </div>
            <div class="form-group">
                <label>å¯†ç¢¼ *</label>
                <input type="password" name="password" required minlength="6">
            </div>
            <div class="form-group">
                <label>å§“å *</label>
                <input type="text" name="real_name" required>
            </div>
            <div class="form-group">
                <label>è§’è‰² *</label>
                <select name="role">
                    <option value="staff">æ¥­å‹™å“¡</option>
                    <option value="admin">ä¸»ç®¡</option>
                </select>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="button" class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">å‰µå»º</button>
            </div>
        </form>
    </div>
</div>

<link rel="stylesheet" href="{{ url_for('tracking_bp.static', filename='css/modules/user-management.css') }}">
<script src="{{ url_for('tracking_bp.static', filename='js/modules/user-management.js') }}"></script>
{% endblock %}
```

## ğŸ“ å‰µå»ºå‰ç«¯æ–‡ä»¶

### `static/js/modules/user-management.js`:

```javascript
// ç”¨æˆ¶ç®¡ç†æ¨¡å¡Š
let users = [];

async function loadUsers() {
    const response = await fetch('/tracking/api/admin/users');
    const data = await response.json();
    
    if (data.success) {
        users = data.data;
        renderUsers();
    }
}

function renderUsers() {
    const container = document.getElementById('users-list');
    container.innerHTML = users.map(user => `
        <div class="user-card">
            <div class="user-info">
                <h4>${user.real_name}</h4>
                <p>å¸³è™Ÿï¼š${user.username} | è§’è‰²ï¼š${user.role === 'admin' ? 'ä¸»ç®¡' : 'æ¥­å‹™å“¡'}</p>
                <p>è² è²¬ç”¢å“ï¼š${user.product_count} å€‹</p>
            </div>
            <div class="user-actions">
                <button onclick="editUser(${user.user_id})">ç·¨è¼¯</button>
                <button onclick="resetPassword(${user.user_id})">é‡è¨­å¯†ç¢¼</button>
            </div>
        </div>
    `).join('');
}

function openNewUserModal() {
    document.getElementById('newUserModal').classList.add('show');
}

function closeModal() {
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
}

document.getElementById('newUserForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    const response = await fetch('/tracking/api/admin/users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    
    if (response.ok) {
        alert('ç”¨æˆ¶å‰µå»ºæˆåŠŸï¼');
        closeModal();
        loadUsers();
    }
});

loadUsers();
```

### `static/css/modules/user-management.css`:

```css
.user-card {
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.user-info h4 {
    margin: 0 0 0.5rem 0;
}

.user-actions {
    display: flex;
    gap: 0.5rem;
}
```

## âœ… é©—æ”¶æ¸…å–®
- [ ] ä¸»ç®¡å¯ä»¥çœ‹åˆ°ç”¨æˆ¶åˆ—è¡¨
- [ ] å¯ä»¥å‰µå»ºæ¥­å‹™å“¡å¸³è™Ÿ
- [ ] å¯ä»¥é‡è¨­å¯†ç¢¼
- [ ] ç”¨æˆ¶å¯ä»¥ä¿®æ”¹è‡ªå·±å¯†ç¢¼

**å®Œæˆå¾Œé€²å…¥ M2** ğŸš€
