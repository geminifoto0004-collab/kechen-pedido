# M5 - æ“ä½œæ—¥èªŒç³»çµ±

## ğŸ“Œ æ¨¡å¡Šæ¦‚è¿°
**æ™‚é–“**: 1 å¤© | **ä¾è³´**: M2, M4

## ğŸ”§ åœ¨ models.py æ·»åŠ æ—¥èªŒå‡½æ•¸

```python
# ==================== æ–°å¢ï¼šæ“ä½œæ—¥èªŒå·¥å…·ï¼ˆM5ï¼‰====================

def log_operation(user_id, operation_type, operation_desc, **kwargs):
    """è¨˜éŒ„æ“ä½œæ—¥èªŒ"""
    from flask import request
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        INSERT INTO operation_logs (
            user_id, operation_type, operation_desc, 
            order_number, product_id, target_user_id,
            details, ip_address, user_agent
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    ''', (
        user_id, operation_type, operation_desc,
        kwargs.get('order_number'), kwargs.get('product_id'), kwargs.get('target_user_id'),
        kwargs.get('details'), request.remote_addr, request.headers.get('User-Agent')
    ))
    
    conn.commit()
    conn.close()
```

## ğŸ”§ åœ¨ __init__.py æ·»åŠ æŸ¥è©¢ API

```python
# ==================== æ–°å¢ï¼šæ“ä½œæ—¥èªŒ APIï¼ˆM5ï¼‰====================

@tracking_bp.route('/api/admin/logs', methods=['GET'])
@admin_required
def get_operation_logs_api():
    """æŸ¥è©¢æ“ä½œæ—¥èªŒï¼ˆä¸»ç®¡å°ˆç”¨ï¼‰"""
    conn = get_db()
    cursor = conn.cursor()
    
    # ç²å–æœ€è¿‘100æ¢æ—¥èªŒ
    cursor.execute('''
        SELECT l.*, u.real_name as operator_name
        FROM operation_logs l
        LEFT JOIN users u ON l.user_id = u.id
        ORDER BY l.created_at DESC
        LIMIT 100
    ''', ())
    
    logs = cursor.fetchall()
    conn.close()
    
    return jsonify({'success': True, 'data': [dict(log) for log in logs]})
```

## ä½¿ç”¨ç¯„ä¾‹

åœ¨å‰µå»ºè¨‚å–®æ™‚è¨˜éŒ„ï¼š

```python
# åœ¨å‰µå»ºè¨‚å–®çš„ API ä¸­æ·»åŠ 
log_operation(
    user_id=session['user_id'],
    operation_type='create_order',
    operation_desc=f'å‰µå»ºè¨‚å–® #{order_number}',
    order_number=order_number
)
```

**å®Œæˆå¾Œé€²å…¥ M6** ğŸš€
