# M6 - é€šçŸ¥ç³»çµ±

## ğŸ“Œ æ¨¡å¡Šæ¦‚è¿°
**æ™‚é–“**: 1-2 å¤© | **ä¾è³´**: M2, M4

## ğŸ”§ åœ¨ models.py æ·»åŠ é€šçŸ¥å‡½æ•¸

```python
# ==================== æ–°å¢ï¼šé€šçŸ¥ç³»çµ±å·¥å…·ï¼ˆM6ï¼‰====================

def send_notification(user_ids, notification_type, title, message, **kwargs):
    """ç™¼é€é€šçŸ¥"""
    if not isinstance(user_ids, list):
        user_ids = [user_ids]
    
    conn = get_db()
    cursor = conn.cursor()
    
    for user_id in user_ids:
        cursor.execute('''
            INSERT INTO notifications (user_id, type, title, message, order_number, product_id)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (user_id, notification_type, title, message, kwargs.get('order_number'), kwargs.get('product_id')))
    
    conn.commit()
    conn.close()


def check_overdue_products():
    """å®šæ™‚ä»»å‹™ï¼šæª¢æŸ¥é€¾æœŸç”¢å“"""
    from datetime import datetime, timedelta
    
    conn = get_db()
    cursor = conn.cursor()
    
    # æŸ¥æ‰¾é€¾æœŸç”¢å“
    cursor.execute('''
        SELECT * FROM products 
        WHERE current_status != 'completed' AND current_status != 'cancelled'
    ''')
    
    products = cursor.fetchall()
    
    for product in products:
        if product['status_updated_at']:
            days = (datetime.now() - datetime.fromisoformat(product['status_updated_at'])).days
            
            # 7å¤©è®Šç´…ç‡ˆ
            if days >= 7:
                send_notification(
                    user_ids=[product['handler_id']],
                    notification_type='overdue_alert',
                    title='è¨‚å–®åš´é‡é€¾æœŸ',
                    message=f'è¨‚å–® #{product["order_number"]} çš„ç”¢å“å·²é€¾æœŸ {days} å¤©',
                    product_id=product['product_id']
                )
    
    conn.close()
```

## ğŸ”§ åœ¨ __init__.py æ·»åŠ é€šçŸ¥ API

```python
# ==================== æ–°å¢ï¼šé€šçŸ¥ç³»çµ± APIï¼ˆM6ï¼‰====================

@tracking_bp.route('/api/notifications', methods=['GET'])
@login_required
def get_notifications_api():
    """ç²å–é€šçŸ¥åˆ—è¡¨"""
    conn = get_db()
    cursor = conn.cursor()
    
    # ç²å–æœªè®€æ•¸
    cursor.execute('SELECT COUNT(*) as count FROM notifications WHERE user_id = ? AND is_read = 0', (session['user_id'],))
    unread_count = cursor.fetchone()['count']
    
    # ç²å–æœ€è¿‘20æ¢é€šçŸ¥
    cursor.execute('''
        SELECT * FROM notifications 
        WHERE user_id = ?
        ORDER BY created_at DESC
        LIMIT 20
    ''', (session['user_id'],))
    
    notifications = cursor.fetchall()
    conn.close()
    
    return jsonify({
        'success': True,
        'unread_count': unread_count,
        'data': [dict(n) for n in notifications]
    })


@tracking_bp.route('/api/notifications/<int:notification_id>/read', methods=['POST'])
@login_required
def mark_notification_read_api(notification_id):
    """æ¨™è¨˜é€šçŸ¥å·²è®€"""
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        UPDATE notifications 
        SET is_read = 1, read_at = ?
        WHERE id = ? AND user_id = ?
    ''', (datetime.now(), notification_id, session['user_id']))
    
    conn.commit()
    conn.close()
    
    return jsonify({'success': True})


@tracking_bp.route('/api/notifications/read-all', methods=['POST'])
@login_required
def mark_all_notifications_read_api():
    """æ¨™è¨˜æ‰€æœ‰é€šçŸ¥å·²è®€"""
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        UPDATE notifications 
        SET is_read = 1, read_at = ?
        WHERE user_id = ? AND is_read = 0
    ''', (datetime.now(), session['user_id']))
    
    conn.commit()
    conn.close()
    
    return jsonify({'success': True})
```

## ğŸ¨ å‰ç«¯ï¼šé€šçŸ¥éˆ´éº

åœ¨ `base.html` ä¸­æ·»åŠ ï¼ˆé ‚éƒ¨å°èˆªï¼‰:

```html
<div class="notification-bell" onclick="toggleNotifications()">
    ğŸ”” <span id="unread-count"></span>
</div>

<div id="notification-dropdown" style="display: none;">
    <!-- é€šçŸ¥åˆ—è¡¨ -->
</div>

<script src="{{ url_for('tracking_bp.static', filename='js/modules/notifications.js') }}"></script>
```

**å®Œæˆå¾Œé€²å…¥ M7** ğŸš€
