# M0 - é …ç›®æº–å‚™èˆ‡çµæ§‹èª¿æ•´

## ğŸ“Œ æ¨¡å¡Šæ¦‚è¿°

**ç›®æ¨™**: å‰µå»ºæ–°æ–‡ä»¶å¤¾çµæ§‹ï¼Œç†è§£ç¾æœ‰ä»£ç¢¼ï¼Œæº–å‚™æ”¹é€ ç’°å¢ƒ

**é ä¼°æ™‚é–“**: 0.5 å¤©

**ä¾è³´**: ç„¡ï¼ˆç¬¬ä¸€å€‹åŸ·è¡Œï¼‰

**å®Œæˆæ¨™æº–**:
- [ ] æ–°æ–‡ä»¶å¤¾çµæ§‹å‰µå»ºå®Œæˆ
- [ ] ç¾æœ‰ä»£ç¢¼å‚™ä»½
- [ ] ä¾è³´åŒ…å®‰è£å®Œæˆ
- [ ] æ•¸æ“šåº«é·ç§»è…³æœ¬æº–å‚™å¥½

---

## ğŸ—‚ï¸ ç¾æœ‰é …ç›®çµæ§‹åˆ†æ

### **ä½ ç›®å‰æœ‰çš„æ–‡ä»¶**:

```
order_tracking/
â”œâ”€â”€ __init__.py              # ä¸» Blueprint (1673è¡Œ)
â”œâ”€â”€ models.py                # æ•¸æ“šåº«æ¨¡å‹ (467è¡Œ)
â”œâ”€â”€ config.py                # é…ç½®æ–‡ä»¶
â”œâ”€â”€ status_config.py         # ç‹€æ…‹é…ç½®
â”œâ”€â”€ status_definitions.py    # ç‹€æ…‹å®šç¾©
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”œâ”€â”€ tracking.js      # âš ï¸ 5473è¡Œï¼ˆä¸å‹•ï¼‰
â”‚   â”‚   â”œâ”€â”€ STATUS_SYSTEM.js # 376è¡Œï¼ˆä¸å‹•ï¼‰
â”‚   â”‚   â””â”€â”€ new_order.js     # 137è¡Œï¼ˆä¸å‹•ï¼‰
â”‚   â””â”€â”€ css/
â”‚       â”œâ”€â”€ tracking.css     # âš ï¸ 4739è¡Œï¼ˆä¸å‹•ï¼‰
â”‚       â””â”€â”€ login.css        # 539è¡Œï¼ˆä¸å‹•ï¼‰
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ tracking/
â”‚       â”œâ”€â”€ base.html
â”‚       â”œâ”€â”€ index.html
â”‚       â”œâ”€â”€ order_detail.html
â”‚       â”œâ”€â”€ reports.html
â”‚       â”œâ”€â”€ login.html
â”‚       â””â”€â”€ login_R.html
â”œâ”€â”€ data/
â”‚   â””â”€â”€ tracking.db          # SQLite æ•¸æ“šåº«
â””â”€â”€ uploads/                 # ä¸Šå‚³æ–‡ä»¶å¤¾ï¼ˆé ç•™ï¼‰
```

### **ä½ ç›®å‰çš„æ•¸æ“šè¡¨**:

```sql
-- å·²æœ‰çš„è¡¨
users                    -- ç”¨æˆ¶è¡¨
orders                   -- è¨‚å–®è¡¨ï¼ˆå–®å±¤ï¼‰
status_history           -- ç‹€æ…‹æ­·å²
notes                    -- å‚™è¨»
revisions                -- ä¿®åœ–éœ€æ±‚
settings                 -- ç³»çµ±è¨­å®š
images                   -- åœ–ç‰‡è¡¨ï¼ˆé ç•™ï¼‰
audit_log                -- æ“ä½œæ—¥èªŒ
```

---

## ğŸ“ å‰µå»ºæ–°æ–‡ä»¶å¤¾çµæ§‹

### **Step 1: å‰µå»ºæ¨¡å¡ŠåŒ– JS/CSS æ–‡ä»¶å¤¾**

```bash
# åœ¨ static/js/ ä¸‹å‰µå»º modules æ–‡ä»¶å¤¾
mkdir -p static/js/modules

# åœ¨ static/css/ ä¸‹å‰µå»º modules æ–‡ä»¶å¤¾
mkdir -p static/css/modules
```

**ç”¨é€”**:
- æ‰€æœ‰æ–°åŠŸèƒ½çš„ JS éƒ½æ”¾åœ¨ `static/js/modules/`
- æ‰€æœ‰æ–°åŠŸèƒ½çš„ CSS éƒ½æ”¾åœ¨ `static/css/modules/`
- ä¿æŒ tracking.js å’Œ tracking.css ä¸å‹•

---

### **Step 2: å‰µå»ºç”¢å“ç›¸é—œæ¨¡æ¿æ–‡ä»¶å¤¾**

```bash
# å‰µå»ºç”¢å“æ¨¡æ¿æ–‡ä»¶å¤¾
mkdir -p templates/tracking/products

# å‰µå»ºç®¡ç†å“¡æ¨¡æ¿æ–‡ä»¶å¤¾
mkdir -p templates/tracking/admin
```

**ç”¨é€”**:
- `templates/tracking/products/` - ç”¢å“åˆ—è¡¨ç­‰é é¢
- `templates/tracking/admin/` - ç”¨æˆ¶ç®¡ç†ã€å„€è¡¨æ¿ç­‰é é¢

---

### **Step 3: ç¢ºä¿ä¸Šå‚³æ–‡ä»¶å¤¾å­˜åœ¨**

```bash
# ç¢ºä¿ uploads æ–‡ä»¶å¤¾å­˜åœ¨
mkdir -p uploads

# å‰µå»ºä¸€å€‹ .gitkeep æ–‡ä»¶ï¼ˆå¦‚æœä½¿ç”¨ Gitï¼‰
touch uploads/.gitkeep
```

---

## ğŸ“¦ ä¾è³´åŒ…æª¢æŸ¥èˆ‡å®‰è£

### **æª¢æŸ¥ç¾æœ‰ä¾è³´**

```bash
pip list | grep -E "Flask|werkzeug|jwt"
```

### **éœ€è¦çš„æ–°ä¾è³´**

```python
# requirements.txt ä¸­æ·»åŠ ï¼ˆå¦‚æœé‚„æ²’æœ‰ï¼‰
openpyxl==3.1.2          # Excel åŒ¯å‡º
APScheduler==3.10.1      # å®šæ™‚ä»»å‹™ï¼ˆé€šçŸ¥ç³»çµ±ç”¨ï¼‰
Pillow==10.0.0           # åœ–ç‰‡è™•ç†ï¼ˆå¯é¸ï¼‰
```

### **å®‰è£å‘½ä»¤**

```bash
pip install openpyxl APScheduler Pillow --break-system-packages
```

**æ³¨æ„**: 
- `openpyxl` ç”¨æ–¼ M7ï¼ˆæ•¸æ“šåŒ¯å‡ºï¼‰
- `APScheduler` ç”¨æ–¼ M6ï¼ˆé€šçŸ¥ç³»çµ±çš„å®šæ™‚æª¢æŸ¥ï¼‰
- `Pillow` ç”¨æ–¼ M8ï¼ˆåœ–ç‰‡è™•ç†ï¼Œå¯é¸ï¼‰

---

## ğŸ’¾ å‚™ä»½ç¾æœ‰ä»£ç¢¼

### **å‰µå»ºå‚™ä»½æ–‡ä»¶å¤¾**

```bash
# å‰µå»ºå‚™ä»½æ–‡ä»¶å¤¾
mkdir -p backups

# å‚™ä»½é—œéµæ–‡ä»¶
cp __init__.py backups/__init__.py.backup_$(date +%Y%m%d)
cp models.py backups/models.py.backup_$(date +%Y%m%d)
cp static/js/tracking.js backups/tracking.js.backup_$(date +%Y%m%d)
cp static/css/tracking.css backups/tracking.css.backup_$(date +%Y%m%d)

# å‚™ä»½æ•¸æ“šåº«
cp data/tracking.db backups/tracking.db.backup_$(date +%Y%m%d)
```

**æˆ–è€…ä½¿ç”¨ Git**:

```bash
git add .
git commit -m "æ”¹é€ å‰çš„å‚™ä»½é» - $(date +%Y-%m-%d)"
git tag "pre-refactor-$(date +%Y%m%d)"
```

---

## ğŸ—„ï¸ æ•¸æ“šåº«é·ç§»è…³æœ¬æº–å‚™

### **å‰µå»ºé·ç§»å·¥å…·å‡½æ•¸**

åœ¨ `models.py` ä¸­æ·»åŠ ä»¥ä¸‹å‡½æ•¸ï¼ˆ**ä¸å½±éŸ¿ç¾æœ‰ä»£ç¢¼**ï¼‰:

```python
# ==================== æ–°å¢ï¼šæ•¸æ“šåº«é·ç§»å·¥å…· ====================
# æ·»åŠ åœ¨ models.py æ–‡ä»¶æœ«å°¾

def migrate_database():
    """
    åŸ·è¡Œæ•¸æ“šåº«é·ç§»
    æ·»åŠ æ–°è¡¨å’Œæ–°æ¬„ä½ï¼Œä¸å½±éŸ¿ç¾æœ‰æ•¸æ“š
    """
    conn = get_db()
    cursor = conn.cursor()
    
    print("=" * 50)
    print("é–‹å§‹æ•¸æ“šåº«é·ç§»...")
    print("=" * 50)
    
    # ===== æª¢æŸ¥ä¸¦æ·»åŠ  users è¡¨çš„æ–°æ¬„ä½ =====
    try:
        cursor.execute("SELECT real_name FROM users LIMIT 1")
        print("âœ… users.real_name æ¬„ä½å·²å­˜åœ¨")
    except:
        try:
            cursor.execute("ALTER TABLE users ADD COLUMN real_name VARCHAR(100)")
            print("âœ… æˆåŠŸæ·»åŠ  users.real_name æ¬„ä½")
            
            # ç‚ºç¾æœ‰ç”¨æˆ¶è¨­ç½®é»˜èªå€¼
            cursor.execute("UPDATE users SET real_name = display_name WHERE real_name IS NULL")
            conn.commit()
        except Exception as e:
            print(f"âš ï¸  æ·»åŠ  users.real_name å¤±æ•—: {e}")
    
    # ===== å‰µå»º products è¡¨ï¼ˆM2 æœƒç”¨åˆ°ï¼‰=====
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS products (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            product_id VARCHAR(20) UNIQUE NOT NULL,
            order_number VARCHAR(50) NOT NULL,
            
            product_name VARCHAR(200),
            product_code VARCHAR(50),
            quantity VARCHAR(50),
            factory VARCHAR(100),
            production_type VARCHAR(100),
            expected_delivery_date DATE,
            
            current_status VARCHAR(50) DEFAULT 'new_order',
            status_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            status_days INTEGER DEFAULT 0,
            
            created_by_id INTEGER,
            handler_id INTEGER,
            
            folder_path VARCHAR(500),
            notes TEXT,
            
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            
            FOREIGN KEY (created_by_id) REFERENCES users(id),
            FOREIGN KEY (handler_id) REFERENCES users(id)
        )
    ''')
    print("âœ… products è¡¨å·²å‰µå»ºï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰")
    
    # ===== å‰µå»º product_status_history è¡¨ =====
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS product_status_history (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            product_id VARCHAR(20) NOT NULL,
            order_number VARCHAR(50),
            
            from_status VARCHAR(50),
            to_status VARCHAR(50) NOT NULL,
            action_date DATE NOT NULL,
            
            operator_id INTEGER,
            notes TEXT,
            
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            
            FOREIGN KEY (operator_id) REFERENCES users(id)
        )
    ''')
    print("âœ… product_status_history è¡¨å·²å‰µå»º")
    
    # ===== å‰µå»º files è¡¨ï¼ˆM3 æœƒç”¨åˆ°ï¼‰=====
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS files (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            file_id VARCHAR(20) UNIQUE NOT NULL,
            order_number VARCHAR(50),
            product_id VARCHAR(20),
            
            filename VARCHAR(500) NOT NULL,
            file_path VARCHAR(1000) NOT NULL,
            file_size INTEGER,
            file_type VARCHAR(100),
            
            uploaded_by_id INTEGER,
            uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            
            is_deleted BOOLEAN DEFAULT 0,
            deleted_by_id INTEGER,
            deleted_at TIMESTAMP,
            
            FOREIGN KEY (uploaded_by_id) REFERENCES users(id),
            FOREIGN KEY (deleted_by_id) REFERENCES users(id)
        )
    ''')
    print("âœ… files è¡¨å·²å‰µå»º")
    
    # ===== å‰µå»º product_handover_log è¡¨ï¼ˆM4 æœƒç”¨åˆ°ï¼‰=====
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS product_handover_log (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            product_id VARCHAR(20) NOT NULL,
            order_number VARCHAR(50),
            
            from_handler_id INTEGER,
            to_handler_id INTEGER,
            handover_by_id INTEGER,
            
            handover_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            reason TEXT,
            
            FOREIGN KEY (from_handler_id) REFERENCES users(id),
            FOREIGN KEY (to_handler_id) REFERENCES users(id),
            FOREIGN KEY (handover_by_id) REFERENCES users(id)
        )
    ''')
    print("âœ… product_handover_log è¡¨å·²å‰µå»º")
    
    # ===== å‰µå»º operation_logs è¡¨ï¼ˆM5 æœƒç”¨åˆ°ï¼‰=====
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS operation_logs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            
            operation_type VARCHAR(50) NOT NULL,
            operation_desc VARCHAR(500),
            
            order_number VARCHAR(50),
            product_id VARCHAR(20),
            target_user_id INTEGER,
            
            details TEXT,
            ip_address VARCHAR(50),
            user_agent VARCHAR(500),
            
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    print("âœ… operation_logs è¡¨å·²å‰µå»º")
    
    # ===== å‰µå»º notifications è¡¨ï¼ˆM6 æœƒç”¨åˆ°ï¼‰=====
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS notifications (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            
            type VARCHAR(50) NOT NULL,
            title VARCHAR(200) NOT NULL,
            message TEXT,
            
            order_number VARCHAR(50),
            product_id VARCHAR(20),
            
            is_read BOOLEAN DEFAULT 0,
            read_at TIMESTAMP,
            
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    ''')
    print("âœ… notifications è¡¨å·²å‰µå»º")
    
    # ===== å‰µå»ºç´¢å¼• =====
    indexes = [
        "CREATE INDEX IF NOT EXISTS idx_products_order ON products(order_number)",
        "CREATE INDEX IF NOT EXISTS idx_products_handler ON products(handler_id)",
        "CREATE INDEX IF NOT EXISTS idx_products_status ON products(current_status)",
        "CREATE INDEX IF NOT EXISTS idx_files_product ON files(product_id)",
        "CREATE INDEX IF NOT EXISTS idx_files_deleted ON files(is_deleted)",
        "CREATE INDEX IF NOT EXISTS idx_notifications_user ON notifications(user_id)",
        "CREATE INDEX IF NOT EXISTS idx_notifications_read ON notifications(is_read)",
    ]
    
    for index_sql in indexes:
        cursor.execute(index_sql)
    
    print("âœ… ç´¢å¼•å·²å‰µå»º")
    
    conn.commit()
    conn.close()
    
    print("=" * 50)
    print("âœ… æ•¸æ“šåº«é·ç§»å®Œæˆï¼")
    print("=" * 50)


def check_migration_status():
    """æª¢æŸ¥é·ç§»ç‹€æ…‹"""
    conn = get_db()
    cursor = conn.cursor()
    
    # æª¢æŸ¥æ–°è¡¨æ˜¯å¦å­˜åœ¨
    cursor.execute("""
        SELECT name FROM sqlite_master 
        WHERE type='table' 
        AND name IN ('products', 'files', 'product_handover_log', 'operation_logs', 'notifications')
    """)
    
    existing_tables = [row['name'] for row in cursor.fetchall()]
    
    print("\næª¢æŸ¥é·ç§»ç‹€æ…‹:")
    print("-" * 30)
    
    required_tables = ['products', 'files', 'product_handover_log', 'operation_logs', 'notifications']
    for table in required_tables:
        if table in existing_tables:
            print(f"âœ… {table} è¡¨å­˜åœ¨")
        else:
            print(f"âŒ {table} è¡¨ä¸å­˜åœ¨")
    
    conn.close()
```

---

## âœ… åŸ·è¡Œé·ç§»

### **Step 1: åœ¨ Python ç’°å¢ƒä¸­åŸ·è¡Œ**

```python
# åœ¨é …ç›®æ ¹ç›®éŒ„ä¸‹åŸ·è¡Œ
python

>>> from order_tracking.models import migrate_database, check_migration_status
>>> migrate_database()
>>> check_migration_status()
```

### **Step 2: æˆ–è€…å‰µå»ºé·ç§»è…³æœ¬**

å‰µå»ºæ–‡ä»¶ `migrate.py`:

```python
#!/usr/bin/env python
"""
æ•¸æ“šåº«é·ç§»è…³æœ¬
ç”¨æ³•ï¼špython migrate.py
"""
import sys
from pathlib import Path

# æ·»åŠ é …ç›®æ ¹ç›®éŒ„åˆ°è·¯å¾‘
current_dir = Path(__file__).parent
sys.path.insert(0, str(current_dir))

from order_tracking.models import migrate_database, check_migration_status

if __name__ == '__main__':
    print("é–‹å§‹é·ç§»...")
    migrate_database()
    print("\næª¢æŸ¥é·ç§»çµæœ...")
    check_migration_status()
    print("\né·ç§»å®Œæˆï¼")
```

ç„¶å¾ŒåŸ·è¡Œ:

```bash
python migrate.py
```

---

## ğŸ“‹ é©—æ”¶æ¸…å–®

å®Œæˆ M0 å¾Œï¼Œæª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š

- [ ] æ–‡ä»¶å¤¾çµæ§‹å‰µå»ºå®Œæˆ
  - [ ] `static/js/modules/` å­˜åœ¨
  - [ ] `static/css/modules/` å­˜åœ¨
  - [ ] `templates/tracking/products/` å­˜åœ¨
  - [ ] `templates/tracking/admin/` å­˜åœ¨

- [ ] ä¾è³´åŒ…å®‰è£å®Œæˆ
  - [ ] `pip list | grep openpyxl` æœ‰çµæœ
  - [ ] `pip list | grep APScheduler` æœ‰çµæœ

- [ ] å‚™ä»½å®Œæˆ
  - [ ] é—œéµæ–‡ä»¶å·²å‚™ä»½
  - [ ] æ•¸æ“šåº«å·²å‚™ä»½

- [ ] æ•¸æ“šåº«é·ç§»å®Œæˆ
  - [ ] `products` è¡¨å­˜åœ¨
  - [ ] `files` è¡¨å­˜åœ¨
  - [ ] `product_handover_log` è¡¨å­˜åœ¨
  - [ ] `operation_logs` è¡¨å­˜åœ¨
  - [ ] `notifications` è¡¨å­˜åœ¨

- [ ] ç¾æœ‰åŠŸèƒ½æ­£å¸¸
  - [ ] å¯ä»¥æ­£å¸¸ç™»å…¥
  - [ ] å¯ä»¥æŸ¥çœ‹è¨‚å–®åˆ—è¡¨
  - [ ] ç¾æœ‰åŠŸèƒ½æ²’æœ‰è¢«ç ´å£

---

## ğŸ”§ çµ¦ Cursor çš„æç¤ºè©

```
è«‹å¹«æˆ‘å®Œæˆ M0-é …ç›®æº–å‚™ æ¨¡å¡Šï¼š

ä»»å‹™ 1ï¼šå‰µå»ºæ–‡ä»¶å¤¾çµæ§‹
- åœ¨ static/js/ ä¸‹å‰µå»º modules æ–‡ä»¶å¤¾
- åœ¨ static/css/ ä¸‹å‰µå»º modules æ–‡ä»¶å¤¾
- åœ¨ templates/tracking/ ä¸‹å‰µå»º products å’Œ admin æ–‡ä»¶å¤¾

ä»»å‹™ 2ï¼šåœ¨ models.py æœ«å°¾æ·»åŠ é·ç§»å‡½æ•¸
- æ·»åŠ  migrate_database() å‡½æ•¸
- æ·»åŠ  check_migration_status() å‡½æ•¸
ï¼ˆä»£ç¢¼åœ¨æ–‡æª”ä¸­å·²æä¾›ï¼Œç›´æ¥è¤‡è£½å³å¯ï¼‰

ä»»å‹™ 3ï¼šåŸ·è¡Œé·ç§»
- é‹è¡Œ migrate_database()
- ç¢ºèªæ‰€æœ‰æ–°è¡¨éƒ½å‰µå»ºæˆåŠŸ

è¦æ±‚ï¼š
- ä¸è¦ä¿®æ”¹ models.py ä¸­çš„ä»»ä½•ç¾æœ‰ä»£ç¢¼
- åªåœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ–°å‡½æ•¸
- ç¢ºä¿æ‰€æœ‰æ–°è¡¨éƒ½æœ‰å‰µå»º

å®Œæˆå¾Œå‘Šè¨´æˆ‘é©—æ”¶çµæœã€‚
```

---

## ğŸ“ æ³¨æ„äº‹é …

1. **ä¸è¦ä¿®æ”¹ç¾æœ‰ä»£ç¢¼**
   - models.py åªåœ¨æœ«å°¾æ·»åŠ 
   - __init__.py å®Œå…¨ä¸å‹•
   - tracking.js/css å®Œå…¨ä¸å‹•

2. **é·ç§»è…³æœ¬å¯é‡è¤‡åŸ·è¡Œ**
   - ä½¿ç”¨ `CREATE TABLE IF NOT EXISTS`
   - ä½¿ç”¨ `CREATE INDEX IF NOT EXISTS`
   - ä¸æœƒå½±éŸ¿ç¾æœ‰æ•¸æ“š

3. **å‚™ä»½å¾ˆé‡è¦**
   - è¬ä¸€å‡ºå•é¡Œå¯ä»¥å›æ»¾
   - Git commit æ˜¯æœ€å¥½çš„å‚™ä»½

---

## ğŸ¯ å®Œæˆæ¨™èªŒ

- âœ… æ‰€æœ‰æ–°æ–‡ä»¶å¤¾å‰µå»ºå®Œæˆ
- âœ… æ‰€æœ‰æ–°è¡¨å‰µå»ºå®Œæˆ
- âœ… ç¾æœ‰åŠŸèƒ½æ­£å¸¸é‹è¡Œ
- âœ… ä¾è³´åŒ…å®‰è£å®Œæˆ

**å®Œæˆå¾Œå¯ä»¥é€²å…¥ M1-ç”¨æˆ¶è§’è‰²æ“´å…….md** ğŸš€
