# M4 - ç”¢å“è½‰ç§»åŠŸèƒ½

## ğŸ“Œ æ¨¡å¡Šæ¦‚è¿°
**æ™‚é–“**: 1 å¤© | **ä¾è³´**: M2

**ç›®æ¨™**: ä¸»ç®¡å¯ä»¥è½‰ç§»ç”¢å“çµ¦å…¶ä»–æ¥­å‹™å“¡

## ğŸ”§ åœ¨ __init__.py æ·»åŠ è½‰ç§» API

```python
# ==================== æ–°å¢ï¼šç”¢å“è½‰ç§» APIï¼ˆM4ï¼‰====================

@tracking_bp.route('/api/admin/products/<product_id>/transfer', methods=['POST'])
@admin_required
def transfer_product_api(product_id):
    """è½‰ç§»ç”¢å“ï¼ˆä¸»ç®¡å°ˆç”¨ï¼‰"""
    data = request.get_json()
    new_handler_id = data.get('new_handler_id')
    reason = data.get('reason', '')
    
    conn = get_db()
    cursor = conn.cursor()
    
    # ç²å–ç”¢å“
    cursor.execute('SELECT * FROM products WHERE product_id = ?', (product_id,))
    product = cursor.fetchone()
    if not product:
        conn.close()
        return jsonify({'success': False, 'error': 'ç”¢å“ä¸å­˜åœ¨'}), 404
    
    old_handler_id = product['handler_id']
    
    # æ›´æ–°è² è²¬äºº
    cursor.execute('UPDATE products SET handler_id = ? WHERE product_id = ?', (new_handler_id, product_id))
    
    # è¨˜éŒ„è½‰ç§»æ—¥èªŒ
    cursor.execute('''
        INSERT INTO product_handover_log (product_id, order_number, from_handler_id, to_handler_id, handover_by_id, reason)
        VALUES (?, ?, ?, ?, ?, ?)
    ''', (product_id, product['order_number'], old_handler_id, new_handler_id, session['user_id'], reason))
    
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'message': 'ç”¢å“å·²è½‰ç§»'})


@tracking_bp.route('/api/admin/products/batch-transfer', methods=['POST'])
@admin_required
def batch_transfer_products_api():
    """æ‰¹é‡è½‰ç§»ç”¢å“ï¼ˆä¸»ç®¡å°ˆç”¨ï¼‰"""
    data = request.get_json()
    from_handler_id = data.get('from_handler_id')
    to_handler_id = data.get('to_handler_id')
    product_ids = data.get('product_ids')  # å¯é¸ï¼Œå¦‚æœä¸æä¾›å‰‡è½‰ç§»è©²ç”¨æˆ¶æ‰€æœ‰ç”¢å“
    reason = data.get('reason', '')
    
    conn = get_db()
    cursor = conn.cursor()
    
    # ç²å–è¦è½‰ç§»çš„ç”¢å“
    if product_ids:
        placeholders = ','.join('?' * len(product_ids))
        cursor.execute(f'SELECT * FROM products WHERE product_id IN ({placeholders})', product_ids)
    else:
        cursor.execute('SELECT * FROM products WHERE handler_id = ?', (from_handler_id,))
    
    products = cursor.fetchall()
    
    # é€å€‹è½‰ç§»
    for product in products:
        cursor.execute('UPDATE products SET handler_id = ? WHERE product_id = ?', (to_handler_id, product['product_id']))
        
        cursor.execute('''
            INSERT INTO product_handover_log (product_id, order_number, from_handler_id, to_handler_id, handover_by_id, reason)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (product['product_id'], product['order_number'], from_handler_id, to_handler_id, session['user_id'], reason))
    
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'transferred_count': len(products)})
```

**å®Œæˆå¾Œé€²å…¥ M5** ğŸš€
