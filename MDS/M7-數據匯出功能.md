# M7 - æ•¸æ“šåŒ¯å‡ºåŠŸèƒ½

## ğŸ“Œ æ¨¡å¡Šæ¦‚è¿°
**æ™‚é–“**: 1 å¤© | **ä¾è³´**: M2, M3

## ğŸ”§ åœ¨ __init__.py æ·»åŠ åŒ¯å‡º API

```python
# ==================== æ–°å¢ï¼šæ•¸æ“šåŒ¯å‡º APIï¼ˆM7ï¼‰====================

@tracking_bp.route('/api/admin/export/orders', methods=['GET'])
@admin_required
def export_orders_api():
    """åŒ¯å‡ºè¨‚å–®åˆ—è¡¨ï¼ˆExcelï¼‰"""
    import openpyxl
    import io
    from flask import send_file
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM orders ORDER BY order_date DESC')
    orders = cursor.fetchall()
    
    # å‰µå»º Excel
    wb = openpyxl.Workbook()
    ws = wb.active
    ws.title = "è¨‚å–®åˆ—è¡¨"
    
    # è¡¨é ­
    ws.append(['è¨‚å–®è™Ÿ', 'å®¢æˆ¶åç¨±', 'è¨‚å–®æ—¥æœŸ', 'ç”¢å“æ•¸', 'ç‹€æ…‹'])
    
    # æ•¸æ“š
    for order in orders:
        cursor.execute('SELECT COUNT(*) as count FROM products WHERE order_number = ?', (order['order_number'],))
        product_count = cursor.fetchone()['count']
        
        ws.append([
            order['order_number'],
            order['customer_name'],
            order['order_date'],
            product_count,
            order['current_status']
        ])
    
    conn.close()
    
    # ä¿å­˜åˆ°å…§å­˜
    output = io.BytesIO()
    wb.save(output)
    output.seek(0)
    
    return send_file(
        output,
        mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        as_attachment=True,
        download_name=f'è¨‚å–®åˆ—è¡¨_{datetime.now().strftime("%Y%m%d")}.xlsx'
    )


@tracking_bp.route('/api/orders/<order_number>/download-all', methods=['GET'])
@login_required
def download_all_files_api(order_number):
    """æ‰¹é‡ä¸‹è¼‰è¨‚å–®æ‰€æœ‰æª”æ¡ˆï¼ˆZIPï¼‰"""
    import zipfile
    import io
    from flask import send_file
    
    conn = get_db()
    cursor = conn.cursor()
    
    # ç²å–æ‰€æœ‰æª”æ¡ˆ
    cursor.execute('''
        SELECT * FROM files 
        WHERE order_number = ? AND is_deleted = 0
    ''', (order_number,))
    files = cursor.fetchall()
    
    conn.close()
    
    # å‰µå»º ZIP
    memory_file = io.BytesIO()
    with zipfile.ZipFile(memory_file, 'w', zipfile.ZIP_DEFLATED) as zf:
        for file in files:
            zf.write(file['file_path'], file['filename'])
    
    memory_file.seek(0)
    
    return send_file(
        memory_file,
        mimetype='application/zip',
        as_attachment=True,
        download_name=f'{order_number}_æ‰€æœ‰æª”æ¡ˆ.zip'
    )


@tracking_bp.route('/api/customers/suggestions', methods=['GET'])
@login_required
def get_customers_api():
    """ç²å–å®¢æˆ¶åç¨±åˆ—è¡¨ï¼ˆè‡ªå‹•å®Œæˆï¼‰"""
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT DISTINCT customer_name FROM orders ORDER BY customer_name')
    customers = cursor.fetchall()
    
    conn.close()
    
    return jsonify({
        'success': True,
        'data': {'customers': [c['customer_name'] for c in customers]}
    })
```

**å®Œæˆå¾Œé€²å…¥ M8** ğŸš€
