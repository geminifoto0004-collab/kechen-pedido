# M2 - ç”¢å“å±¤ç´šï¼ˆæ ¸å¿ƒæ”¹é€ ï¼‰â­

## ğŸ“Œ æ¨¡å¡Šæ¦‚è¿°
**æ™‚é–“**: 2-3 å¤© | **ä¾è³´**: M0, M1

**ç›®æ¨™**: å¯¦ç¾è¨‚å–®â†’ç”¢å“é›™å±¤çµæ§‹ï¼Œé€™æ˜¯æ•´å€‹æ”¹é€ çš„æ ¸å¿ƒï¼

## ğŸ—„ï¸ æ•¸æ“šåº«ï¼ˆM0 å·²å‰µå»ºï¼‰

products å’Œ product_status_history è¡¨å·²åœ¨ M0 å‰µå»ºï¼Œé€™è£¡ä¸ç”¨å†å»ºã€‚

## ğŸ”§ åœ¨ __init__.py æ·»åŠ ç”¢å“ API

åœ¨ __init__.py **æœ«å°¾**æ·»åŠ ï¼š

```python
# ==================== æ–°å¢ï¼šç”¢å“ç®¡ç† APIï¼ˆM2ï¼‰====================

@tracking_bp.route('/api/orders/<order_number>/products', methods=['POST'])
@login_required
def create_product_api(order_number):
    """å‰µå»ºç”¢å“ï¼ˆæ¥­å‹™å“¡ï¼‰"""
    data = request.get_json()
    
    # æª¢æŸ¥è¨‚å–®æ˜¯å¦å­˜åœ¨
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT id FROM orders WHERE order_number = ?', (order_number,))
    order = cursor.fetchone()
    if not order:
        conn.close()
        return jsonify({'success': False, 'error': 'è¨‚å–®ä¸å­˜åœ¨'}), 404
    
    # ç”Ÿæˆç”¢å“IDï¼ˆPR001, PR002...ï¼‰
    cursor.execute('SELECT COUNT(*) as count FROM products WHERE order_number = ?', (order_number,))
    count = cursor.fetchone()['count'] + 1
    product_id = f'PR{count:03d}'
    
    # å‰µå»ºè³‡æ–™å¤¾è·¯å¾‘
    import os
    folder_path = f'uploads/{order_number}/{product_id}/'
    os.makedirs(folder_path, exist_ok=True)
    
    # æ’å…¥ç”¢å“
    cursor.execute('''
        INSERT INTO products (
            product_id, order_number, product_name, product_code, quantity,
            factory, production_type, expected_delivery_date,
            current_status, status_updated_at, created_by_id, handler_id,
            folder_path, notes
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    ''', (
        product_id, order_number,
        data.get('product_name'), data.get('product_code'), data.get('quantity'),
        data.get('factory'), data.get('production_type'), data.get('expected_delivery_date'),
        STATUS_KEYS['NEW_ORDER'], datetime.now(), session['user_id'], session['user_id'],
        folder_path, data.get('notes')
    ))
    
    # è¨˜éŒ„ç‹€æ…‹æ­·å²
    cursor.execute('''
        INSERT INTO product_status_history (product_id, order_number, from_status, to_status, action_date, operator_id, notes)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    ''', (product_id, order_number, None, STATUS_KEYS['NEW_ORDER'], date.today(), session['user_id'], 'ç”¢å“å‰µå»º'))
    
    conn.commit()
    conn.close()
    
    return jsonify({
        'success': True,
        'data': {
            'product_id': product_id,
            'order_number': order_number,
            'product_name': data.get('product_name'),
            'folder_path': folder_path
        }
    })


@tracking_bp.route('/api/orders/<order_number>/products', methods=['GET'])
@login_required
def get_products_api(order_number):
    """ç²å–ç”¢å“åˆ—è¡¨ï¼ˆæŒ‰æ¬Šé™éæ¿¾ï¼‰"""
    conn = get_db()
    cursor = conn.cursor()
    
    # æ ¹æ“šè§’è‰²éæ¿¾
    if session.get('role') == 'admin':
        # ä¸»ç®¡çœ‹æ‰€æœ‰ç”¢å“
        cursor.execute('''
            SELECT p.*, u.real_name as handler_name, u2.real_name as creator_name
            FROM products p
            LEFT JOIN users u ON p.handler_id = u.id
            LEFT JOIN users u2 ON p.created_by_id = u2.id
            WHERE p.order_number = ?
            ORDER BY p.created_at DESC
        ''', (order_number,))
    else:
        # æ¥­å‹™å“¡åªçœ‹è‡ªå·±è² è²¬çš„
        cursor.execute('''
            SELECT p.*, u.real_name as handler_name, u2.real_name as creator_name
            FROM products p
            LEFT JOIN users u ON p.handler_id = u.id
            LEFT JOIN users u2 ON p.created_by_id = u2.id
            WHERE p.order_number = ? AND p.handler_id = ?
            ORDER BY p.created_at DESC
        ''', (order_number, session['user_id']))
    
    products = cursor.fetchall()
    
    # è¨ˆç®—ç‹€æ…‹å¤©æ•¸å’Œæª”æ¡ˆæ•¸
    result = []
    for product in products:
        # è¨ˆç®—å¤©æ•¸
        if product['status_updated_at']:
            from datetime import datetime, date
            updated = datetime.fromisoformat(product['status_updated_at'])
            days = (datetime.now() - updated).days
        else:
            days = 0
        
        # çµ±è¨ˆæª”æ¡ˆæ•¸
        cursor.execute('SELECT COUNT(*) as count FROM files WHERE product_id = ? AND is_deleted = 0', (product['product_id'],))
        file_count = cursor.fetchone()['count']
        
        result.append({
            'product_id': product['product_id'],
            'product_name': product['product_name'],
            'product_code': product['product_code'],
            'current_status': product['current_status'],
            'status_label': get_status_label(product['current_status'], 'zh_tw'),
            'handler': product['handler_name'],
            'creator': product['creator_name'],
            'status_days': days,
            'file_count': file_count,
            'created_at': product['created_at']
        })
    
    conn.close()
    return jsonify({'success': True, 'data': result})


@tracking_bp.route('/api/products/<product_id>', methods=['GET'])
@login_required
def get_product_detail_api(product_id):
    """ç²å–ç”¢å“è©³æƒ…"""
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT p.*, u.real_name as handler_name, u2.real_name as creator_name
        FROM products p
        LEFT JOIN users u ON p.handler_id = u.id
        LEFT JOIN users u2 ON p.created_by_id = u2.id
        WHERE p.product_id = ?
    ''', (product_id,))
    
    product = cursor.fetchone()
    if not product:
        conn.close()
        return jsonify({'success': False, 'error': 'ç”¢å“ä¸å­˜åœ¨'}), 404
    
    # æ¬Šé™æª¢æŸ¥
    if session.get('role') != 'admin' and product['handler_id'] != session['user_id']:
        conn.close()
        return jsonify({'success': False, 'error': 'æ¬Šé™ä¸è¶³'}), 403
    
    # ç²å–ç‹€æ…‹æ­·å²
    cursor.execute('''
        SELECT h.*, u.real_name as operator_name
        FROM product_status_history h
        LEFT JOIN users u ON h.operator_id = u.id
        WHERE h.product_id = ?
        ORDER BY h.action_date DESC
    ''', (product_id,))
    history = cursor.fetchall()
    
    conn.close()
    
    return jsonify({
        'success': True,
        'data': {
            'product': dict(product),
            'history': [dict(h) for h in history]
        }
    })


@tracking_bp.route('/api/products/<product_id>/status', methods=['PUT'])
@login_required
def update_product_status_api(product_id):
    """æ›´æ–°ç”¢å“ç‹€æ…‹"""
    data = request.get_json()
    new_status = data.get('new_status')
    notes = data.get('notes', '')
    
    conn = get_db()
    cursor = conn.cursor()
    
    # ç²å–ç”¢å“
    cursor.execute('SELECT * FROM products WHERE product_id = ?', (product_id,))
    product = cursor.fetchone()
    if not product:
        conn.close()
        return jsonify({'success': False, 'error': 'ç”¢å“ä¸å­˜åœ¨'}), 404
    
    # æ¬Šé™æª¢æŸ¥
    if session.get('role') != 'admin' and product['handler_id'] != session['user_id']:
        conn.close()
        return jsonify({'success': False, 'error': 'æ¬Šé™ä¸è¶³ï¼Œåªèƒ½ä¿®æ”¹è‡ªå·±è² è²¬çš„ç”¢å“'}), 403
    
    old_status = product['current_status']
    
    # æ›´æ–°ç”¢å“ç‹€æ…‹
    cursor.execute('''
        UPDATE products 
        SET current_status = ?, status_updated_at = ?, status_days = 0, updated_at = ?
        WHERE product_id = ?
    ''', (new_status, datetime.now(), datetime.now(), product_id))
    
    # è¨˜éŒ„ç‹€æ…‹æ­·å²
    cursor.execute('''
        INSERT INTO product_status_history (product_id, order_number, from_status, to_status, action_date, operator_id, notes)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    ''', (product_id, product['order_number'], old_status, new_status, date.today(), session['user_id'], notes))
    
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'message': 'ç‹€æ…‹å·²æ›´æ–°'})


@tracking_bp.route('/api/orders/<order_number>/full', methods=['GET'])
@login_required
def get_order_full_data_api(order_number):
    """ç²å–å®Œæ•´è¨‚å–®æ•¸æ“šï¼ˆè¨‚å–®+ç”¢å“+æª”æ¡ˆï¼Œç”¨æ–¼åœ–ç‰‡ç®¡ç†UIï¼‰"""
    conn = get_db()
    cursor = conn.cursor()
    
    # ç²å–è¨‚å–®
    cursor.execute('SELECT * FROM orders WHERE order_number = ?', (order_number,))
    order = cursor.fetchone()
    if not order:
        conn.close()
        return jsonify({'success': False, 'error': 'è¨‚å–®ä¸å­˜åœ¨'}), 404
    
    # ç²å–ç”¢å“ï¼ˆæŒ‰æ¬Šé™ï¼‰
    if session.get('role') == 'admin':
        cursor.execute('SELECT * FROM products WHERE order_number = ?', (order_number,))
    else:
        cursor.execute('SELECT * FROM products WHERE order_number = ? AND handler_id = ?', 
                      (order_number, session['user_id']))
    
    products = cursor.fetchall()
    
    # ç‚ºæ¯å€‹ç”¢å“ç²å–æª”æ¡ˆ
    products_data = []
    total_files = 0
    
    for product in products:
        cursor.execute('''
            SELECT * FROM files 
            WHERE product_id = ? AND is_deleted = 0
            ORDER BY uploaded_at DESC
        ''', (product['product_id'],))
        files = cursor.fetchall()
        
        products_data.append({
            'product_id': product['product_id'],
            'product_name': product['product_name'],
            'current_status': product['current_status'],
            'files': [dict(f) for f in files]
        })
        
        total_files += len(files)
    
    conn.close()
    
    return jsonify({
        'success': True,
        'data': {
            'order': {
                'order_number': order['order_number'],
                'customer_name': order['customer_name'],
                'order_date': order['order_date']
            },
            'products': products_data,
            'stats': {
                'total_products': len(products_data),
                'total_files': total_files
            }
        }
    })
```

## ğŸ¨ å‰ç«¯ï¼šç”¢å“ç®¡ç†æ¨¡å¡Š

### `static/js/modules/product-manager.js`:

```javascript
// ç”¢å“ç®¡ç†æ¨¡å¡Š
class ProductManager {
    constructor() {
        this.currentOrderNumber = null;
        this.products = [];
    }
    
    async loadProducts(orderNumber) {
        this.currentOrderNumber = orderNumber;
        const response = await fetch(`/tracking/api/orders/${orderNumber}/products`);
        const data = await response.json();
        
        if (data.success) {
            this.products = data.data;
            this.render();
        }
    }
    
    render() {
        const container = document.getElementById('products-container');
        if (!container) return;
        
        container.innerHTML = this.products.map(p => `
            <div class="product-card">
                <h4>${p.product_name || p.product_id}</h4>
                <p>ç‹€æ…‹ï¼š${p.status_label || p.current_status}</p>
                <p>è² è²¬äººï¼š${p.handler}</p>
                <p>ç­‰å¾…ï¼š${p.status_days} å¤©</p>
                <p>æª”æ¡ˆï¼š${p.file_count} å€‹</p>
                <button onclick="productManager.viewDetail('${p.product_id}')">æŸ¥çœ‹</button>
            </div>
        `).join('');
    }
    
    async viewDetail(productId) {
        const response = await fetch(`/tracking/api/products/${productId}`);
        const data = await response.json();
        
        if (data.success) {
            // é¡¯ç¤ºç”¢å“è©³æƒ…ï¼ˆå¯ä»¥åœ¨å³å´æŠ½å±œæˆ– Modalï¼‰
            console.log('ç”¢å“è©³æƒ…:', data.data);
        }
    }
    
    async createProduct(orderNumber, productData) {
        const response = await fetch(`/tracking/api/orders/${orderNumber}/products`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(productData)
        });
        
        if (response.ok) {
            alert('ç”¢å“å‰µå»ºæˆåŠŸï¼');
            this.loadProducts(orderNumber);
        }
    }
}

// å…¨å±€å¯¦ä¾‹
const productManager = new ProductManager();
```

### `static/css/modules/products.css`:

```css
.product-card {
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.product-card h4 {
    margin: 0 0 0.5rem 0;
    color: #2c3e50;
}

.product-card p {
    margin: 0.25rem 0;
    font-size: 0.9rem;
    color: #666;
}

.product-card button {
    margin-top: 0.5rem;
}
```

## ğŸ“„ åœ¨ base.html ä¸­å¼•å…¥æ–°æ¨¡å¡Š

åœ¨ `templates/tracking/base.html` çš„ `</body>` å‰æ·»åŠ ï¼š

```html
<!-- æ–°å¢ï¼šç”¢å“ç®¡ç†æ¨¡å¡Š -->
<script src="{{ url_for('tracking_bp.static', filename='js/modules/product-manager.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('tracking_bp.static', filename='css/modules/products.css') }}">
```

## âœ… é©—æ”¶æ¸…å–®

- [ ] æ¥­å‹™å“¡å¯ä»¥å‰µå»ºç”¢å“
- [ ] ç”¢å“IDè‡ªå‹•ç”Ÿæˆï¼ˆPR001, PR002...ï¼‰
- [ ] è³‡æ–™å¤¾è‡ªå‹•å‰µå»ºï¼ˆ/uploads/è¨‚å–®è™Ÿ/ç”¢å“ID/ï¼‰
- [ ] æ¥­å‹™å“¡åªèƒ½çœ‹åˆ°è‡ªå·±è² è²¬çš„ç”¢å“
- [ ] ä¸»ç®¡å¯ä»¥çœ‹åˆ°æ‰€æœ‰ç”¢å“
- [ ] å¯ä»¥æ›´æ–°ç”¢å“ç‹€æ…‹
- [ ] ç‹€æ…‹æ­·å²è¢«è¨˜éŒ„
- [ ] ç²å–å®Œæ•´è¨‚å–®æ•¸æ“šæ­£å¸¸

## ğŸ”§ çµ¦ Cursor çš„æç¤ºè©

```
è«‹å¹«æˆ‘å¯¦æ–½ M2-ç”¢å“å±¤ç´šæ ¸å¿ƒï¼š

æ­¥é©Ÿ1ï¼šåœ¨ __init__.py æœ«å°¾æ·»åŠ æ‰€æœ‰ç”¢å“APIï¼ˆæ–‡æª”ä¸­çš„ä»£ç¢¼ï¼‰
æ­¥é©Ÿ2ï¼šå‰µå»º static/js/modules/product-manager.js
æ­¥é©Ÿ3ï¼šå‰µå»º static/css/modules/products.css
æ­¥é©Ÿ4ï¼šåœ¨ base.html å¼•å…¥æ–°æ–‡ä»¶

è¦æ±‚ï¼š
- åš´æ ¼æŒ‰ç…§æ–‡æª”ä»£ç¢¼
- ä¸ä¿®æ”¹ç¾æœ‰çš„ __init__.py ä»£ç¢¼
- åªåœ¨æœ«å°¾æ·»åŠ 

å®Œæˆå¾Œå‘Šè¨´æˆ‘ã€‚
```

**å®Œæˆå¾Œé€²å…¥ M3** ğŸš€
