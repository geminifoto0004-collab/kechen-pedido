# å‰ç«¯æ¬Šé™æ§åˆ¶è£œå……èªªæ˜

## ğŸ“Œ æ¦‚è¿°

é€™ä»½æ–‡æª”è£œå……èªªæ˜å¦‚ä½•åœ¨**å‰ç«¯ HTML æ¨¡æ¿**å’Œ **JavaScript** ä¸­æ ¹æ“šç”¨æˆ¶è§’è‰²é¡¯ç¤ºä¸åŒçš„å…§å®¹ã€‚

---

## ğŸ­ ç”¨æˆ¶è§’è‰²

ç³»çµ±ä¸­æœ‰ 3 ç¨®è§’è‰²ï¼š

| è§’è‰² | session['role'] | æ¬Šé™ |
|------|----------------|------|
| ä¸»ç®¡ | `'admin'` | æŸ¥çœ‹æ‰€æœ‰è¨‚å–®/ç”¢å“ã€å‰µå»ºè¨‚å–®ã€è½‰ç§»ç”¢å“ã€ç®¡ç†ç”¨æˆ¶ |
| æ¥­å‹™å“¡ | `'staff'` | åªæŸ¥çœ‹è‡ªå·±è² è²¬çš„ç”¢å“ã€å‰µå»ºç”¢å“ã€ä¸Šå‚³æª”æ¡ˆ |
| æŸ¥çœ‹è€… | `'viewer'` | åªèƒ½æŸ¥çœ‹ï¼ˆèˆŠç³»çµ±ï¼Œå¯èƒ½ä¸ç”¨ï¼‰ |

---

## ğŸ¨ åœ¨ HTML æ¨¡æ¿ä¸­åˆ¤æ–·æ¬Šé™

### **æ–¹æ³• 1ï¼šä½¿ç”¨ Jinja2 æ¢ä»¶åˆ¤æ–·**

#### **ç¯„ä¾‹ 1ï¼šä¸»ç®¡å°ˆç”¨æŒ‰éˆ•**

```html
<!-- templates/tracking/products/list.html -->
{% extends "../base.html" %}

{% block content %}
<div class="products-page">
    <h2>ç”¢å“åˆ—è¡¨</h2>
    
    <!-- åªæœ‰ä¸»ç®¡æ‰èƒ½çœ‹åˆ°ã€Œå‰µå»ºè¨‚å–®ã€æŒ‰éˆ• -->
    {% if session.role == 'admin' %}
        <button class="btn btn-primary" onclick="openNewOrderModal()">
            + å‰µå»ºè¨‚å–®
        </button>
    {% endif %}
    
    <!-- æ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°ç”¢å“åˆ—è¡¨ -->
    <div id="products-list"></div>
    
    <!-- ä¸»ç®¡æ‰èƒ½çœ‹åˆ°ã€Œè½‰ç§»ç”¢å“ã€æŒ‰éˆ• -->
    {% if session.role == 'admin' %}
        <button onclick="openTransferModal()">è½‰ç§»ç”¢å“</button>
    {% endif %}
</div>
{% endblock %}
```

#### **ç¯„ä¾‹ 2ï¼šæ ¹æ“šè§’è‰²é¡¯ç¤ºä¸åŒæç¤º**

```html
<div class="page-header">
    {% if session.role == 'admin' %}
        <p>æ‚¨æ˜¯ä¸»ç®¡ï¼Œå¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¢å“</p>
    {% elif session.role == 'staff' %}
        <p>æ‚¨æ˜¯æ¥­å‹™å“¡ï¼Œåªèƒ½æŸ¥çœ‹è‡ªå·±è² è²¬çš„ç”¢å“</p>
    {% endif %}
</div>
```

#### **ç¯„ä¾‹ 3ï¼šå…±ç”¨ base.html ä¸­çš„å°èˆª**

åœ¨ `templates/tracking/base.html` ä¸­ï¼š

```html
<nav class="navbar">
    <div class="container">
        <a href="{{ url_for('tracking_bp.index') }}">è¨‚å–®ç³»çµ±</a>
        
        <div class="nav-right">
            <!-- æ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°é€šçŸ¥ -->
            <div class="notification-bell" onclick="toggleNotifications()">
                ğŸ”” <span id="unread-count"></span>
            </div>
            
            <!-- ç”¨æˆ¶ä¸‹æ‹‰èœå–® -->
            <div class="user-menu">
                <span>{{ session.display_name or session.username }}</span>
                <div class="dropdown">
                    <a href="#" onclick="openChangePasswordModal()">ğŸ”‘ ä¿®æ”¹å¯†ç¢¼</a>
                    
                    <!-- åªæœ‰ä¸»ç®¡æ‰èƒ½çœ‹åˆ°é€™äº›é¸é … -->
                    {% if session.role == 'admin' %}
                        <a href="{{ url_for('tracking_bp.admin_dashboard') }}">ğŸ“Š å„€è¡¨æ¿</a>
                        <a href="{{ url_for('tracking_bp.admin_users') }}">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</a>
                        <a href="#" onclick="openExportModal()">ğŸ“¥ æ•¸æ“šåŒ¯å‡º</a>
                    {% endif %}
                    
                    <a href="{{ url_for('tracking_bp.logout') }}">ğŸšª ç™»å‡º</a>
                </div>
            </div>
        </div>
    </div>
</nav>
```

---

## ğŸ“œ åœ¨ JavaScript ä¸­åˆ¤æ–·æ¬Šé™

### **æ–¹æ³• 1ï¼šå¾å¾Œç«¯å‚³éè§’è‰²åˆ°å‰ç«¯**

åœ¨æ¨¡æ¿ä¸­åµŒå…¥ JavaScript è®Šé‡ï¼š

```html
<!-- åœ¨ base.html æˆ–å„é é¢çš„ <script> ä¸­ -->
<script>
    // å°‡ç”¨æˆ¶ä¿¡æ¯å‚³éåˆ°å‰ç«¯ JavaScript
    window.currentUser = {
        userId: {{ session.user_id | tojson }},
        username: {{ session.username | tojson }},
        displayName: {{ session.display_name | tojson }},
        role: {{ session.role | tojson }},
        isAdmin: {{ 'true' if session.role == 'admin' else 'false' }}
    };
</script>
```

ç„¶å¾Œåœ¨ä½ çš„ JS æ–‡ä»¶ä¸­ä½¿ç”¨ï¼š

```javascript
// static/js/modules/product-manager.js

class ProductManager {
    renderProducts() {
        const container = document.getElementById('products-container');
        
        container.innerHTML = this.products.map(p => `
            <div class="product-card">
                <h4>${p.product_name}</h4>
                <p>ç‹€æ…‹ï¼š${p.status_label}</p>
                
                <!-- åªæœ‰ä¸»ç®¡æˆ–ç”¢å“è² è²¬äººæ‰èƒ½çœ‹åˆ°ã€Œç·¨è¼¯ã€æŒ‰éˆ• -->
                ${this.canEdit(p) ? `
                    <button onclick="productManager.edit('${p.product_id}')">ç·¨è¼¯</button>
                ` : ''}
                
                <!-- åªæœ‰ä¸»ç®¡æ‰èƒ½çœ‹åˆ°ã€Œè½‰ç§»ã€æŒ‰éˆ• -->
                ${window.currentUser.isAdmin ? `
                    <button onclick="productManager.transfer('${p.product_id}')">è½‰ç§»</button>
                ` : ''}
            </div>
        `).join('');
    }
    
    canEdit(product) {
        // ä¸»ç®¡å¯ä»¥ç·¨è¼¯æ‰€æœ‰ç”¢å“ï¼Œæ¥­å‹™å“¡åªèƒ½ç·¨è¼¯è‡ªå·±è² è²¬çš„
        return window.currentUser.isAdmin || 
               product.handler_id === window.currentUser.userId;
    }
    
    canDelete(product) {
        // åªæœ‰ä¸»ç®¡å¯ä»¥åˆªé™¤
        return window.currentUser.isAdmin;
    }
}
```

### **æ–¹æ³• 2ï¼šå‹•æ…‹é¡¯ç¤º/éš±è—æŒ‰éˆ•**

```javascript
// æ ¹æ“šæ¬Šé™é¡¯ç¤ºæˆ–éš±è—å…ƒç´ 
function initializePermissions() {
    // å¦‚æœä¸æ˜¯ä¸»ç®¡ï¼Œéš±è—æ‰€æœ‰ .admin-only å…ƒç´ 
    if (!window.currentUser.isAdmin) {
        document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = 'none';
        });
    }
    
    // å¦‚æœä¸æ˜¯æ¥­å‹™å“¡ï¼Œéš±è—æ¥­å‹™å“¡å°ˆç”¨åŠŸèƒ½
    if (window.currentUser.role !== 'staff') {
        document.querySelectorAll('.staff-only').forEach(el => {
            el.style.display = 'none';
        });
    }
}

// é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
document.addEventListener('DOMContentLoaded', initializePermissions);
```

ç„¶å¾Œåœ¨ HTML ä¸­ä½¿ç”¨ï¼š

```html
<button class="admin-only" onclick="transferProduct()">è½‰ç§»ç”¢å“</button>
<button class="staff-only" onclick="createProduct()">å‰µå»ºç”¢å“</button>
```

---

## ğŸ”’ å®‰å…¨æé†’

### âš ï¸ **é‡è¦ï¼šå‰ç«¯æ¬Šé™åªæ˜¯ UI æ§åˆ¶**

å‰ç«¯éš±è—æŒ‰éˆ•**ä¸èƒ½ä»£æ›¿**å¾Œç«¯æ¬Šé™æª¢æŸ¥ï¼

```python
# âœ… æ­£ç¢ºåšæ³•ï¼šå‰ç«¯ + å¾Œç«¯éƒ½è¦æª¢æŸ¥
@tracking_bp.route('/api/admin/users', methods=['POST'])
@admin_required  # â† å¾Œç«¯æª¢æŸ¥ï¼ˆå¿…é ˆï¼‰
def create_user():
    # ...
```

```html
<!-- å‰ç«¯ä¹Ÿéš±è—æŒ‰éˆ•ï¼ˆç”¨æˆ¶é«”é©—ï¼‰ -->
{% if session.role == 'admin' %}
    <button onclick="createUser()">å‰µå»ºç”¨æˆ¶</button>
{% endif %}
```

**åŸå› **ï¼š
- å‰ç«¯å¯ä»¥è¢«ç¹éï¼ˆç”¨æˆ¶å¯ä»¥æ‰“é–‹é–‹ç™¼è€…å·¥å…·ä¿®æ”¹ï¼‰
- å¾Œç«¯æª¢æŸ¥æ‰æ˜¯çœŸæ­£çš„å®‰å…¨ä¿éšœ
- å‰ç«¯éš±è—æŒ‰éˆ•åªæ˜¯ç‚ºäº†æ›´å¥½çš„ç”¨æˆ¶é«”é©—

---

## ğŸ“‹ å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹

### **ç¯„ä¾‹ 1ï¼šç”¨æˆ¶ç®¡ç†é é¢**

åªæœ‰ä¸»ç®¡èƒ½è¨ªå•ï¼Œåœ¨è·¯ç”±ä¸­æª¢æŸ¥ï¼š

```python
# __init__.py
@tracking_bp.route('/admin/users')
@admin_required  # â† å¾Œç«¯æª¢æŸ¥
def admin_users():
    """ç”¨æˆ¶ç®¡ç†é é¢ï¼ˆåªæœ‰ä¸»ç®¡å¯è¨ªå•ï¼‰"""
    return render_template('admin/users.html')
```

HTML æ¨¡æ¿ï¼š

```html
<!-- templates/tracking/admin/users.html -->
{% extends "../base.html" %}

{% block content %}
<div class="users-page">
    <h2>ç”¨æˆ¶ç®¡ç†</h2>
    
    <!-- é€™å€‹é é¢åªæœ‰ä¸»ç®¡èƒ½çœ‹åˆ°ï¼Œæ‰€ä»¥ä¸ç”¨å†åˆ¤æ–· -->
    <button onclick="openNewUserModal()">+ æ–°å¢ç”¨æˆ¶</button>
    
    <div id="users-list"></div>
</div>
{% endblock %}
```

### **ç¯„ä¾‹ 2ï¼šç”¢å“åˆ—è¡¨é é¢**

æ‰€æœ‰äººéƒ½èƒ½è¨ªå•ï¼Œä½†é¡¯ç¤ºçš„å…§å®¹ä¸åŒï¼š

```python
# __init__.py
@tracking_bp.route('/products')
@login_required  # â† åªè¦ç™»å…¥å³å¯
def products_list():
    """ç”¢å“åˆ—è¡¨ï¼ˆæ‰€æœ‰äººå¯è¨ªå•ï¼‰"""
    return render_template('products/list.html')
```

HTML æ¨¡æ¿ï¼š

```html
<!-- templates/tracking/products/list.html -->
{% extends "../base.html" %}

{% block content %}
<div class="products-page">
    <h2>ç”¢å“åˆ—è¡¨</h2>
    
    <!-- ä¸»ç®¡æ‰èƒ½å‰µå»ºè¨‚å–® -->
    {% if session.role == 'admin' %}
        <button class="btn btn-primary" onclick="openNewOrderModal()">
            + å‰µå»ºè¨‚å–®
        </button>
    {% endif %}
    
    <!-- æ¥­å‹™å“¡å¯ä»¥å‰µå»ºç”¢å“ -->
    {% if session.role in ['admin', 'staff'] %}
        <button class="btn btn-secondary" onclick="openNewProductModal()">
            + å‰µå»ºç”¢å“
        </button>
    {% endif %}
    
    <!-- é¡¯ç¤ºæç¤º -->
    {% if session.role == 'admin' %}
        <p class="info">æ‚¨å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¢å“</p>
    {% elif session.role == 'staff' %}
        <p class="info">åªé¡¯ç¤ºæ‚¨è² è²¬çš„ç”¢å“</p>
    {% endif %}
    
    <div id="products-list">
        <!-- JavaScript æœƒæ ¹æ“š API è¿”å›çš„æ•¸æ“šæ¸²æŸ“ -->
        <!-- API å·²ç¶“æ ¹æ“šæ¬Šé™éæ¿¾äº†æ•¸æ“š -->
    </div>
</div>
{% endblock %}
```

JavaScriptï¼š

```javascript
// static/js/modules/product-manager.js
async function loadProducts(orderNumber) {
    // API æœƒæ ¹æ“šç”¨æˆ¶è§’è‰²è¿”å›ä¸åŒçš„æ•¸æ“š
    // ä¸»ç®¡ï¼šè¿”å›æ‰€æœ‰ç”¢å“
    // æ¥­å‹™å“¡ï¼šåªè¿”å›è‡ªå·±è² è²¬çš„ç”¢å“
    const response = await fetch(`/tracking/api/orders/${orderNumber}/products`);
    const data = await response.json();
    
    if (data.success) {
        renderProducts(data.data);
    }
}

function renderProducts(products) {
    const container = document.getElementById('products-list');
    
    container.innerHTML = products.map(p => `
        <div class="product-card">
            <h4>${p.product_name}</h4>
            <p>è² è²¬äººï¼š${p.handler}</p>
            
            <!-- æ ¹æ“šæ¬Šé™é¡¯ç¤ºä¸åŒæŒ‰éˆ• -->
            <div class="actions">
                ${canEditProduct(p) ? `
                    <button onclick="editProduct('${p.product_id}')">ç·¨è¼¯</button>
                ` : ''}
                
                ${window.currentUser.isAdmin ? `
                    <button onclick="transferProduct('${p.product_id}')">è½‰ç§»</button>
                    <button class="btn-danger" onclick="deleteProduct('${p.product_id}')">åˆªé™¤</button>
                ` : ''}
            </div>
        </div>
    `).join('');
}

function canEditProduct(product) {
    // ä¸»ç®¡æˆ–ç”¢å“è² è²¬äººå¯ä»¥ç·¨è¼¯
    return window.currentUser.isAdmin || 
           product.handler_id === window.currentUser.userId;
}
```

---

## ğŸ¯ å¿«é€Ÿæª¢æŸ¥æ¸…å–®

### **å¾Œç«¯ API** âœ…

- [ ] ä½¿ç”¨ `@admin_required` è£é£¾å™¨ï¼ˆä¸»ç®¡å°ˆç”¨ APIï¼‰
- [ ] ä½¿ç”¨ `@login_required` è£é£¾å™¨ï¼ˆéœ€è¦ç™»å…¥çš„ APIï¼‰
- [ ] åœ¨ API å…§éƒ¨æª¢æŸ¥ `session.get('role')`
- [ ] åœ¨ API å…§éƒ¨æª¢æŸ¥ `session.get('user_id')`

### **å‰ç«¯ HTML** âœ…

- [ ] ä½¿ç”¨ `{% if session.role == 'admin' %}` éš±è—ä¸»ç®¡å°ˆç”¨æŒ‰éˆ•
- [ ] ä½¿ç”¨ `{% if session.role in ['admin', 'staff'] %}` é¡¯ç¤ºæ¥­å‹™å“¡å¯ç”¨åŠŸèƒ½
- [ ] åœ¨ base.html ä¸­æ­£ç¢ºé¡¯ç¤ºç”¨æˆ¶åå’Œè§’è‰²

### **å‰ç«¯ JavaScript** âœ…

- [ ] åœ¨æ¨¡æ¿ä¸­å®šç¾© `window.currentUser` è®Šé‡
- [ ] åœ¨æ¸²æŸ“æ™‚æ ¹æ“š `window.currentUser.isAdmin` é¡¯ç¤ºæŒ‰éˆ•
- [ ] åœ¨æ¸²æŸ“æ™‚æ ¹æ“š `window.currentUser.userId` åˆ¤æ–·æ˜¯å¦æ˜¯è² è²¬äºº

---

## ğŸ“„ éœ€è¦ä¿®æ”¹çš„ MD æ–‡ä»¶

ä»¥ä¸‹ MD æ–‡ä»¶éœ€è¦è£œå……å‰ç«¯æ¬Šé™åˆ¤æ–·çš„èªªæ˜ï¼š

1. **M1-ç”¨æˆ¶è§’è‰²æ“´å…….md** â† éœ€è¦è£œå…… base.html ä¸­çš„æ¬Šé™é¡¯ç¤º
2. **M2-ç”¢å“å±¤ç´šæ ¸å¿ƒ.md** â† éœ€è¦è£œå……ç”¢å“åˆ—è¡¨çš„æ¬Šé™æ§åˆ¶
3. **M8-åœ–ç‰‡ç®¡ç†UI.md** â† éœ€è¦è£œå……åœ–ç‰‡æŸ¥çœ‹å™¨çš„æ¬Šé™æ§åˆ¶

---

## ğŸ’¡ ç¸½çµ

### **æ¬Šé™æ§åˆ¶çš„å…©å±¤é˜²è­·**ï¼š

1. **å¾Œç«¯ï¼ˆå®‰å…¨ä¿éšœï¼‰**ï¼š
   ```python
   @admin_required
   def some_api():
       if session.get('role') != 'admin':
           return 403
   ```

2. **å‰ç«¯ï¼ˆç”¨æˆ¶é«”é©—ï¼‰**ï¼š
   ```html
   {% if session.role == 'admin' %}
       <button>ä¸»ç®¡å°ˆç”¨</button>
   {% endif %}
   ```

### **è¨˜ä½**ï¼š
- âœ… å¾Œç«¯æª¢æŸ¥æ˜¯**å¿…é ˆçš„**ï¼ˆå®‰å…¨ï¼‰
- âœ… å‰ç«¯éš±è—æ˜¯**æ‡‰è©²çš„**ï¼ˆé«”é©—ï¼‰
- âŒ åªæœ‰å‰ç«¯æª¢æŸ¥æ˜¯**å±éšªçš„**ï¼ˆå¯ç¹éï¼‰

---

**é€™ä»½è£œå……æ–‡æª”æ‡‰è©²å’Œ M0-M9 ä¸€èµ·ä½¿ç”¨ï¼**
