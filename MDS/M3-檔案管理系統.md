# M3 - æª”æ¡ˆç®¡ç†ç³»çµ±

## ğŸ“Œ æ¨¡å¡Šæ¦‚è¿°
**æ™‚é–“**: 1-2 å¤© | **ä¾è³´**: M2

**ç›®æ¨™**: å¯¦ç¾æª”æ¡ˆä¸Šå‚³ã€ä¸‹è¼‰ã€åˆªé™¤ã€æ‰¹é‡æ“ä½œ

## ğŸ”§ åœ¨ __init__.py æ·»åŠ æª”æ¡ˆ API

```python
# ==================== æ–°å¢ï¼šæª”æ¡ˆç®¡ç† APIï¼ˆM3ï¼‰====================

@tracking_bp.route('/api/products/<product_id>/files', methods=['POST'])
@login_required
def upload_file_api(product_id):
    """ä¸Šå‚³æª”æ¡ˆåˆ°ç”¢å“"""
    from werkzeug.utils import secure_filename
    import os
    
    # æª¢æŸ¥ç”¢å“
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM products WHERE product_id = ?', (product_id,))
    product = cursor.fetchone()
    
    if not product:
        conn.close()
        return jsonify({'success': False, 'error': 'ç”¢å“ä¸å­˜åœ¨'}), 404
    
    # æ¬Šé™æª¢æŸ¥
    if session.get('role') != 'admin' and product['handler_id'] != session['user_id']:
        conn.close()
        return jsonify({'success': False, 'error': 'æ¬Šé™ä¸è¶³'}), 403
    
    # æª¢æŸ¥æª”æ¡ˆ
    if 'file' not in request.files:
        conn.close()
        return jsonify({'success': False, 'error': 'æ²’æœ‰æª”æ¡ˆ'}), 400
    
    file = request.files['file']
    if file.filename == '':
        conn.close()
        return jsonify({'success': False, 'error': 'æª”æ¡ˆåç‚ºç©º'}), 400
    
    # ç”Ÿæˆæª”æ¡ˆID
    cursor.execute('SELECT COUNT(*) as count FROM files')
    count = cursor.fetchone()['count'] + 1
    file_id = f'F{count:05d}'
    
    # ä¿å­˜æª”æ¡ˆ
    filename = secure_filename(file.filename)
    file_path = os.path.join(product['folder_path'], filename)
    os.makedirs(os.path.dirname(file_path), exist_ok=True)
    file.save(file_path)
    
    # ç²å–æª”æ¡ˆå¤§å°
    file_size = os.path.getsize(file_path)
    
    # è¨˜éŒ„åˆ°æ•¸æ“šåº«
    cursor.execute('''
        INSERT INTO files (file_id, order_number, product_id, filename, file_path, file_size, file_type, uploaded_by_id)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    ''', (file_id, product['order_number'], product_id, filename, file_path, file_size, file.content_type, session['user_id']))
    
    conn.commit()
    conn.close()
    
    return jsonify({
        'success': True,
        'data': {
            'file_id': file_id,
            'filename': filename,
            'file_size': file_size
        }
    })


@tracking_bp.route('/api/products/<product_id>/files', methods=['GET'])
@login_required
def get_files_api(product_id):
    """ç²å–ç”¢å“æª”æ¡ˆåˆ—è¡¨"""
    conn = get_db()
    cursor = conn.cursor()
    
    # æª¢æŸ¥æ¬Šé™
    cursor.execute('SELECT * FROM products WHERE product_id = ?', (product_id,))
    product = cursor.fetchone()
    if not product:
        conn.close()
        return jsonify({'success': False, 'error': 'ç”¢å“ä¸å­˜åœ¨'}), 404
    
    if session.get('role') != 'admin' and product['handler_id'] != session['user_id']:
        conn.close()
        return jsonify({'success': False, 'error': 'æ¬Šé™ä¸è¶³'}), 403
    
    # ç²å–æª”æ¡ˆåˆ—è¡¨
    cursor.execute('''
        SELECT f.*, u.real_name as uploader_name
        FROM files f
        LEFT JOIN users u ON f.uploaded_by_id = u.id
        WHERE f.product_id = ? AND f.is_deleted = 0
        ORDER BY f.uploaded_at DESC
    ''', (product_id,))
    
    files = cursor.fetchall()
    
    result = []
    for f in files:
        can_delete = (session.get('role') == 'admin' or f['uploaded_by_id'] == session['user_id'])
        
        result.append({
            'file_id': f['file_id'],
            'filename': f['filename'],
            'file_size': f['file_size'],
            'uploader': f['uploader_name'],
            'uploaded_at': f['uploaded_at'],
            'can_delete': can_delete
        })
    
    conn.close()
    return jsonify({'success': True, 'data': result})


@tracking_bp.route('/api/files/<file_id>/download', methods=['GET'])
@login_required
def download_file_api(file_id):
    """ä¸‹è¼‰æª”æ¡ˆ"""
    from flask import send_file
    
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM files WHERE file_id = ? AND is_deleted = 0', (file_id,))
    file = cursor.fetchone()
    
    if not file:
        conn.close()
        return jsonify({'success': False, 'error': 'æª”æ¡ˆä¸å­˜åœ¨'}), 404
    
    # æ¬Šé™æª¢æŸ¥
    cursor.execute('SELECT * FROM products WHERE product_id = ?', (file['product_id'],))
    product = cursor.fetchone()
    
    if session.get('role') != 'admin' and product['handler_id'] != session['user_id']:
        conn.close()
        return jsonify({'success': False, 'error': 'æ¬Šé™ä¸è¶³'}), 403
    
    conn.close()
    return send_file(file['file_path'], as_attachment=True, download_name=file['filename'])


@tracking_bp.route('/api/files/<file_id>', methods=['DELETE'])
@login_required
def delete_file_api(file_id):
    """åˆªé™¤æª”æ¡ˆï¼ˆè»Ÿåˆªé™¤ï¼‰"""
    conn = get_db()
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM files WHERE file_id = ? AND is_deleted = 0', (file_id,))
    file = cursor.fetchone()
    
    if not file:
        conn.close()
        return jsonify({'success': False, 'error': 'æª”æ¡ˆä¸å­˜åœ¨'}), 404
    
    # æ¬Šé™æª¢æŸ¥ï¼šåªèƒ½åˆªè‡ªå·±ä¸Šå‚³çš„ï¼Œæˆ–è€…æ˜¯ä¸»ç®¡
    if session.get('role') != 'admin' and file['uploaded_by_id'] != session['user_id']:
        conn.close()
        return jsonify({'success': False, 'error': 'æ¬Šé™ä¸è¶³ï¼Œåªèƒ½åˆªé™¤è‡ªå·±ä¸Šå‚³çš„æª”æ¡ˆ'}), 403
    
    # è»Ÿåˆªé™¤
    cursor.execute('''
        UPDATE files 
        SET is_deleted = 1, deleted_by_id = ?, deleted_at = ?
        WHERE file_id = ?
    ''', (session['user_id'], datetime.now(), file_id))
    
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'message': 'æª”æ¡ˆå·²åˆªé™¤'})


@tracking_bp.route('/api/files/batch-delete', methods=['POST'])
@login_required
def batch_delete_files_api():
    """æ‰¹é‡åˆªé™¤æª”æ¡ˆ"""
    data = request.get_json()
    file_ids = data.get('file_ids', [])
    
    conn = get_db()
    cursor = conn.cursor()
    
    deleted_count = 0
    permission_denied = []
    failed = []
    
    for file_id in file_ids:
        cursor.execute('SELECT * FROM files WHERE file_id = ? AND is_deleted = 0', (file_id,))
        file = cursor.fetchone()
        
        if not file:
            failed.append(file_id)
            continue
        
        # æ¬Šé™æª¢æŸ¥
        if session.get('role') != 'admin' and file['uploaded_by_id'] != session['user_id']:
            permission_denied.append(file_id)
            continue
        
        # è»Ÿåˆªé™¤
        cursor.execute('''
            UPDATE files 
            SET is_deleted = 1, deleted_by_id = ?, deleted_at = ?
            WHERE file_id = ?
        ''', (session['user_id'], datetime.now(), file_id))
        
        deleted_count += 1
    
    conn.commit()
    conn.close()
    
    return jsonify({
        'success': True,
        'data': {
            'deleted_count': deleted_count,
            'failed': failed,
            'permission_denied': permission_denied
        }
    })
```

## ğŸ¨ å‰ç«¯ï¼šæª”æ¡ˆä¸Šå‚³çµ„ä»¶

### `static/js/modules/file-uploader.js`:

```javascript
// æª”æ¡ˆä¸Šå‚³æ¨¡å¡Š
class FileUploader {
    constructor(productId) {
        this.productId = productId;
        this.files = [];
    }
    
    async upload(fileInput) {
        const files = fileInput.files;
        
        for (let file of files) {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch(`/tracking/api/products/${this.productId}/files`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                console.log(`${file.name} ä¸Šå‚³æˆåŠŸ`);
            }
        }
        
        this.loadFiles();
    }
    
    async loadFiles() {
        const response = await fetch(`/tracking/api/products/${this.productId}/files`);
        const data = await response.json();
        
        if (data.success) {
            this.files = data.data;
            this.render();
        }
    }
    
    render() {
        const container = document.getElementById('files-container');
        if (!container) return;
        
        container.innerHTML = this.files.map(f => `
            <div class="file-item">
                <span>${f.filename}</span>
                <span>${this.formatSize(f.file_size)}</span>
                <button onclick="fileUploader.download('${f.file_id}')">ä¸‹è¼‰</button>
                ${f.can_delete ? `<button onclick="fileUploader.delete('${f.file_id}')">åˆªé™¤</button>` : ''}
            </div>
        `).join('');
    }
    
    formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    download(fileId) {
        window.location.href = `/tracking/api/files/${fileId}/download`;
    }
    
    async delete(fileId) {
        if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æª”æ¡ˆï¼Ÿ')) return;
        
        await fetch(`/tracking/api/files/${fileId}`, {method: 'DELETE'});
        this.loadFiles();
    }
}
```

## âœ… é©—æ”¶æ¸…å–®

- [ ] å¯ä»¥ä¸Šå‚³æª”æ¡ˆ
- [ ] æª”æ¡ˆä¿å­˜åˆ°æ­£ç¢ºè·¯å¾‘
- [ ] å¯ä»¥ä¸‹è¼‰æª”æ¡ˆ
- [ ] æ¥­å‹™å“¡åªèƒ½åˆªè‡ªå·±ä¸Šå‚³çš„
- [ ] ä¸»ç®¡å¯ä»¥åˆªä»»ä½•æª”æ¡ˆ
- [ ] æ‰¹é‡åˆªé™¤åŠŸèƒ½æ­£å¸¸

**å®Œæˆå¾Œé€²å…¥ M4** ğŸš€
