# M9 - ä¸»ç®¡å„€è¡¨æ¿

## ğŸ“Œ æ¨¡å¡Šæ¦‚è¿°
**æ™‚é–“**: 1-2 å¤© | **ä¾è³´**: M2, M5, M6

## ğŸ”§ åœ¨ __init__.py æ·»åŠ å„€è¡¨æ¿ API

```python
# ==================== æ–°å¢ï¼šä¸»ç®¡å„€è¡¨æ¿ APIï¼ˆM9ï¼‰====================

@tracking_bp.route('/api/admin/dashboard', methods=['GET'])
@admin_required
def get_dashboard_api():
    """ç²å–å„€è¡¨æ¿æ•¸æ“š"""
    from datetime import datetime
    
    conn = get_db()
    cursor = conn.cursor()
    
    # ç¸½è¦½çµ±è¨ˆ
    cursor.execute('SELECT COUNT(*) as count FROM orders')
    total_orders = cursor.fetchone()['count']
    
    cursor.execute('SELECT COUNT(*) as count FROM products')
    total_products = cursor.fetchone()['count']
    
    cursor.execute('SELECT COUNT(*) as count FROM users WHERE role = "staff"')
    total_staff = cursor.fetchone()['count']
    
    cursor.execute('SELECT COUNT(*) as count FROM files WHERE is_deleted = 0')
    total_files = cursor.fetchone()['count']
    
    # ç´…é»ƒç¶ ç‡ˆåˆ†å¸ƒ
    red_count = yellow_count = green_count = 0
    
    cursor.execute('SELECT * FROM products WHERE current_status != "completed"')
    products = cursor.fetchall()
    
    for product in products:
        if product['status_updated_at']:
            days = (datetime.now() - datetime.fromisoformat(product['status_updated_at'])).days
            if days >= 7:
                red_count += 1
            elif days >= 3:
                yellow_count += 1
            else:
                green_count += 1
    
    # æ¥­å‹™å“¡å·¥ä½œé‡
    cursor.execute('SELECT * FROM users WHERE role = "staff"')
    staff = cursor.fetchall()
    
    workload = []
    for user in staff:
        cursor.execute('SELECT COUNT(*) as count FROM products WHERE handler_id = ?', (user['id'],))
        product_count = cursor.fetchone()['count']
        
        workload.append({
            'user_id': user['id'],
            'name': user['real_name'],
            'product_count': product_count
        })
    
    # æœ€è¿‘æ´»å‹•
    cursor.execute('''
        SELECT l.*, u.real_name as operator
        FROM operation_logs l
        LEFT JOIN users u ON l.user_id = u.id
        ORDER BY l.created_at DESC
        LIMIT 10
    ''')
    recent_activities = cursor.fetchall()
    
    conn.close()
    
    return jsonify({
        'success': True,
        'data': {
            'overview': {
                'total_orders': total_orders,
                'total_products': total_products,
                'total_staff': total_staff,
                'total_files': total_files
            },
            'status_distribution': {
                'red': red_count,
                'yellow': yellow_count,
                'green': green_count
            },
            'workload': workload,
            'recent_activities': [dict(a) for a in recent_activities]
        }
    })
```

## ğŸ¨ å‰ç«¯ï¼šå„€è¡¨æ¿é é¢

å‰µå»º `templates/tracking/admin/dashboard.html`:

```html
{% extends "../base.html" %}

{% block content %}
<div class="dashboard">
    <h2>ä¸»ç®¡å„€è¡¨æ¿</h2>
    
    <div class="stats-cards">
        <div class="stat-card">
            <h3>è¨‚å–®</h3>
            <div id="total-orders">-</div>
        </div>
        <div class="stat-card">
            <h3>ç”¢å“</h3>
            <div id="total-products">-</div>
        </div>
        <div class="stat-card">
            <h3>æ¥­å‹™å“¡</h3>
            <div id="total-staff">-</div>
        </div>
        <div class="stat-card">
            <h3>æª”æ¡ˆ</h3>
            <div id="total-files">-</div>
        </div>
    </div>
    
    <div id="status-distribution"></div>
    <div id="workload-chart"></div>
    <div id="recent-activities"></div>
</div>

<script src="{{ url_for('tracking_bp.static', filename='js/modules/dashboard.js') }}"></script>
{% endblock %}
```

ğŸ‰ **æ‰€æœ‰æ¨¡å¡Šå®Œæˆï¼** ğŸ‰
