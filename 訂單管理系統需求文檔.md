# 訂單管理系統 - 完整需求文檔

**版本**: 2.0  
**日期**: 2026-01-08  
**技術棧**: Flask + SQLite + HTML/CSS/JS  
**更新內容**: 完整UI設計 + 優化數據庫結構 + 快速更新功能  

---

## 📋 目錄

1. [系統概述](#系統概述)
2. [核心需求](#核心需求)
3. [業務流程](#業務流程)
4. [UI界面設計](#ui界面設計)
5. [功能模塊](#功能模塊)
6. [頁面設計](#頁面設計)
7. [數據庫結構](#數據庫結構)
8. [快速更新功能](#快速更新功能)
9. [開發計劃](#開發計劃)

---

## 系統概述

### 背景
公司需要管理來自國外客戶的訂單，訂單流程包括：接單 → 圖稿確認 → 打樣 → 打樣確認 → 生產 → 完成。同時還需要處理客戶的修圖需求（無訂單號的簡單修圖任務）。

### 目標
- ✅ 不漏單，追蹤每個訂單的當前狀態
- ✅ 智能提醒逾期和需要跟進的訂單
- ✅ 快速更新訂單狀態
- ✅ 方便查詢和統計
- ✅ 生成客戶報表

### 使用場景
- **每日管理**: 查看今日待辦，快速更新訂單狀態
- **對外溝通**: 隨時查詢客戶的訂單狀況，生成報表
- **團隊協作**: 記錄備註和修改歷史

---

## 核心需求

### 優先級排序

#### 🔥 第一優先（必須有）
1. **訂單追蹤系統** - 完整的狀態流程管理
2. **智能提醒功能** - 自動標記逾期和需跟進的訂單
3. **快速操作** - 一鍵更新狀態
4. **今日待辦視圖** - 主頁顯示需要處理的訂單

#### ⭐ 第二優先（最好有）
5. **日期記錄** - 每個階段的完整時間記錄
6. **備註系統** - 記錄溝通內容和修改原因
7. **統計報表** - 客戶訂單狀況報表
8. **修圖需求管理** - 處理無訂單號的修圖任務

#### 💡 第三優先（未來擴展）
9. **圖片功能** - 上傳和查看各階段圖片（預留接口）
10. **微信通知** - 自動通知提醒（未來功能）

---

## 業務流程

### 訂單完整流程

```
1. 📱 接單（國外傳圖片到微信）
   └─ 記錄：訂單日期、客戶名稱、訂單號
   └─ 可選：上傳客戶原始需求圖片

2. 🎨 中國畫圖稿
   └─ 記錄：發圖稿日期
   └─ 可選：上傳設計好的圖稿
   └─ 發給國外確認

3. ✅ 國外確認圖稿
   ├─ 👍 確認OK → 進入打樣
   ├─ 🔄 要求修改 → 回到步驟2（記錄修改次數）
   └─ ❌ 取消訂單

4. 🧪 打樣
   └─ 記錄：打樣日期、生產類型
   └─ 可選：上傳打樣照片

5. ✅ 打樣確認
   ├─ 選項A：發圖片給國外確認
   │   ├─ 👍 確認OK → 安排生產
   │   ├─ 🔄 要求修改 → 回到步驟4
   │   └─ ❌ 取消訂單
   │
   └─ 選項B：中國直接確認（覺得很好）
       └─ 👍 直接進入生產

6. 🏭 生產中
   └─ 記錄：安排生產日期
   └─ 可選：上傳生產過程照片

7. ✅ 完成
   └─ 記錄：完成日期
   └─ 可選：上傳成品照片
```

### 修圖需求流程（無訂單號）

```
1. 📨 收到修圖需求
   └─ 記錄：客戶名稱、收到日期、修改要求
   └─ 狀態：已收到

2. 🔄 處理中
   └─ 修改圖稿
   └─ 狀態：處理中

3. 結果
   ├─ ✅ 完成 → 標記為已完成
   ├─ 📦 轉為訂單 → 創建正式訂單，自動帶入資料
   └─ ❌ 取消 → 標記為已取消
```

---

## UI界面設計

### 整體布局

採用**Tab大階段 + 雙層篩選**的設計方案：

```
┌─────────────────────────────────────────────────────────┐
│  🔍搜尋框           [匯入] [匯出] [新增訂單]              │  ← 頂部工具欄
├─────────────────────────────────────────────────────────┤
│  總訂單: 143  |  🔴 8  🟡 15  🟢 53                      │  ← 統計欄
├─────────────────────────────────────────────────────────┤
│  [📦全部76] [📄圖稿18] [🧪打樣28] [🏭生產25] [✅完成] [❌] │  ← Tab大階段
├─────────────────────────────────────────────────────────┤
│  細分: [全部] [新訂單] [圖稿確認中] [打樣中] ...         │  ← 第一層篩選
├─────────────────────────────────────────────────────────┤
│  階段性: [全部] [🔴逾期] [🟡需注意] [🟢正常]             │  ← 第二層篩選
├─────────────────────────────────────────────────────────┤
│  當前顯示: 全部進行中 · 全部流程 · 全部狀態 · 共76個     │  ← 篩選提示
├─────────────────────────────────────────────────────────┤
│                                                           │
│  訂單列表表格                                              │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

### Tab大階段分類

#### 主要Tab（6個）

1. **📦 全部進行中 (76)** - 預設Tab
   - 顯示所有未完成的訂單
   - 細分流程：新訂單、圖稿確認中、圖稿修改中、待打樣、打樣中、打樣確認中、待生產、生產中

2. **📄 圖稿階段 (18)**
   - 只顯示圖稿相關的訂單
   - 細分流程：圖稿確認中、圖稿修改中

3. **🧪 打樣階段 (28)**
   - 只顯示打樣相關的訂單
   - 細分流程：待打樣、打樣中、打樣確認中、打樣修改中

4. **🏭 生產階段 (25)**
   - 只顯示生產相關的訂單
   - 細分流程：待生產、生產中

5. **✅ 已完成 (267)**
   - 顯示已完成的訂單
   - 時間篩選：本週、本月、3個月、全部

6. **❌ 已取消 (18)**
   - 顯示已取消的訂單
   - 時間篩選：本月、3個月、全部

### 雙層篩選邏輯

#### 第一層：細分流程篩選
根據當前Tab動態顯示：
- 在「全部進行中」：顯示所有9個小流程
- 在「圖稿階段」：只顯示圖稿相關的2個流程
- 在「打樣階段」：只顯示打樣相關的4個流程
- 在「生產階段」：只顯示生產相關的2個流程

#### 第二層：階段性篩選（燈號）
這是核心的**階段性篩選**：
- **[全部狀態]** - 顯示所有燈號
- **[🔴 逾期]** - 只顯示紅燈訂單（跨流程）
- **[🟡 需注意]** - 只顯示黃燈訂單（跨流程）
- **🟢 正常]** - 只顯示綠燈訂單（跨流程）

**關鍵特性**：點擊「🔴 逾期」會顯示當前Tab下所有紅燈訂單，不管它們在哪個具體流程。

### 訂單狀態完整列表

#### 進行中狀態（9個）

| 狀態 | 說明 | 下一步 |
|------|------|--------|
| 新訂單 | 剛接單，還沒發圖稿 | 圖稿確認中 |
| 圖稿確認中 | 圖稿已發出，等客戶確認 | 待打樣 或 圖稿修改中 |
| 圖稿修改中 | 客戶要求修改圖稿 | 圖稿確認中 |
| 待打樣 | 圖稿確認了，準備打樣 | 打樣中 |
| 打樣中 | 正在打樣 | 打樣確認中 |
| 打樣確認中 | 樣品已完成，等客戶確認 | 待生產 或 打樣修改中 |
| 打樣修改中 | 需要重新打樣 | 打樣確認中 |
| 待生產 | 打樣確認了，準備生產 | 生產中 |
| 生產中 | 正在生產 | 已完成 |

#### 結束狀態（2個）

| 狀態 | 說明 |
|------|------|
| 已完成 | 生產完成 |
| 已取消 | 客戶取消訂單 |

### 燈號規則（階段性篩選）

#### 🔴 紅燈 - 逾期（需立即處理）

| 狀態 | 觸發條件 |
|------|---------|
| 新訂單 | 接單後 > 7天還沒發圖稿 |
| 圖稿確認中 | 發圖後 > 5天未確認 |
| 待打樣 | 確認後 > 7天還沒打樣 |
| 打樣確認中 | 打樣完成 > 3天未確認 |
| 待生產 | 確認後 > 5天還沒生產 |
| 任何階段 | 超過預計交貨日期 |

#### 🟡 黃燈 - 需注意（即將逾期）

| 狀態 | 觸發條件 |
|------|---------|
| 新訂單 | 接單後 5-7天 |
| 圖稿確認中 | 發圖後 3-5天 |
| 待打樣 | 確認後 5-7天 |
| 打樣中 | 打樣中 > 10天（可能慢了） |
| 打樣確認中 | 打樣完成 2-3天 |
| 待生產 | 確認後 3-5天 |
| 生產中 | 距離交貨 < 3天 |

#### 🟢 綠燈 - 正常

所有不符合紅燈和黃燈條件的訂單。

### 表格設計

#### 表格欄位

| 欄位 | 說明 | 寬度 |
|------|------|------|
| 訂單日期 | 接單日期 | 110px |
| 訂單號 | 可點擊查看詳情 | 120px |
| 客戶名稱 | - | 140px |
| 當前階段 | 顯示狀態 + 下一步提示 | 180px |
| 狀態 | 燈號emoji | 60px |
| 等待天數 | 當前階段等待時間 | 90px |
| 發圖日期 | - | 110px |
| 生產類型 | - | 130px |
| 預計交貨 | - | 110px |
| 備註 | - | 150px |
| 操作 | 快速更新按鈕 | 300px |

#### 表格行樣式

- **紅燈訂單**：淺紅背景 + 左側紅色邊框
- **黃燈訂單**：淺黃背景 + 左側黃色邊框
- **綠燈訂單**：無特殊背景
- **懸停效果**：背景變深 + 顯示快速操作按鈕

### 配色方案

```css
/* 背景色 */
--bg-primary: #0f172a;      /* 主背景 */
--bg-secondary: #1e293b;    /* 次背景 */
--bg-hover: #334155;        /* 懸停 */

/* 強調色 */
--accent-blue: #3b82f6;     /* 主色調 */
--accent-cyan: #06b6d4;     /* 次色調 */

/* 狀態色 */
--status-danger: #ef4444;   /* 紅燈 */
--status-warning: #f59e0b;  /* 黃燈 */
--status-success: #10b981;  /* 綠燈 */

/* 文字色 */
--text-primary: #f1f5f9;    /* 主文字 */
--text-secondary: #cbd5e1;  /* 次文字 */
--text-muted: #64748b;      /* 弱化文字 */
```

### 字體設計

- **中文**：Noto Sans SC (Google Fonts)
- **數字/代碼**：JetBrains Mono (等寬字體)
- **基礎大小**：0.9rem
- **小號**：0.85rem
- **標題**：1.2-1.5rem

---

## 功能模塊

### 1. 訂單管理模塊

#### 功能清單
- ✅ 新增訂單（手動輸入訂單號）
- ✅ 編輯訂單資料
- ✅ 刪除訂單
- ✅ 訂單列表（表格視圖）
- ✅ 訂單詳情（時間軸視圖）
- ✅ 快速更新狀態
- ✅ 添加備註

#### 訂單狀態
```
⏳ 新訂單 - 剛接單，還沒發圖稿
🎨 待圖稿確認 - 圖稿已發出，等客戶確認
🔄 圖稿修改中 - 客戶要求修改圖稿
🧪 待打樣 - 圖稿確認了，準備打樣
📦 打樣中 - 正在打樣
✅ 待打樣確認 - 樣品已發出，等客戶確認
🔧 打樣修改中 - 客戶要求修改樣品
🏭 生產中 - 已安排生產
✔️ 已完成 - 生產完成
❌ 已取消 - 客戶取消訂單
```

#### 智能提醒規則

**🔴 紅色 - 緊急**
- 圖稿發出 > 5天未確認
- 打樣發出 > 3天未確認
- 預計交貨日期 < 3天
- 任何階段逾期

**🟡 黃色 - 需注意**
- 圖稿發出 2-4天未確認
- 打樣發出 1-2天未確認
- 預計交貨日期 3-7天
- 某階段停留 > 設定天數

**🟢 綠色 - 正常**
- 進度正常，按時推進

**⚪ 灰色 - 已完成**
- 訂單完成或已取消

### 2. 修圖需求模塊

#### 功能清單
- ✅ 新增修圖需求（自動生成編號）
- ✅ 編輯修圖需求
- ✅ 刪除修圖需求
- ✅ 修圖列表
- ✅ 修圖詳情
- ✅ 轉為正式訂單
- ✅ 添加備註

#### 修圖狀態
```
📨 已收到 - 剛收到需求
🔄 處理中 - 正在處理
✅ 已完成 - 處理完成
❌ 已取消 - 客戶取消
📦 已轉訂單 - 已轉為正式訂單
```

#### 編號格式
```
REV-20260107-001
REV-20260107-002
...

格式：REV-日期-流水號
優點：
- 永不重複（有日期）
- 一看就知道什麼時候的
- 刪除後再建也不會衝突
```

#### 轉換為訂單
- 點擊「轉為訂單」按鈕
- 自動帶入客戶名稱
- 自動帶入修改要求到備註
- 需要手動輸入訂單號
- 修圖需求自動標記為「已轉訂單」

### 3. 主頁儀表板

#### 今日待辦
- 顯示所有需要處理的訂單（逾期、待確認）
- 顯示所有需要處理的修圖需求
- 按緊急程度排序

#### 統計卡片
```
訂單統計：
├─ 總訂單數
├─ 進行中訂單
├─ 逾期警報
└─ 本週完成

修圖統計：
├─ 總需求數
├─ 處理中
├─ 逾期警報
└─ 本週完成
```

#### 快速操作
- [+ 新增訂單]
- [+ 新增修圖需求]
- [📥 匯入Excel]

### 4. 報表統計

#### 客戶報表
- 選擇客戶 → 顯示該客戶所有訂單狀況
- 包含：進行中、已完成、逾期情況
- 可匯出為PDF或Excel

#### 統計圖表
- 訂單數量趨勢
- 完成率統計
- 平均處理時間
- 逾期率分析

### 5. 設定功能

#### 提醒規則設定
```
訂單提醒設定：
├─ 圖稿超過 [X] 天標記黃色
├─ 圖稿超過 [Y] 天標記紅色
├─ 打樣超過 [X] 天標記黃色
└─ 打樣超過 [Y] 天標記紅色

修圖提醒設定：
├─ 超過 [X] 天標記黃色
└─ 超過 [Y] 天標記紅色
```

#### 其他設定
- 用戶管理（如果需要多人使用）
- 數據備份
- Excel匯入/匯出

---

## 頁面設計

### 頁面列表（7個核心頁面）

1. **index.html** - 主頁
   - 今日待辦（訂單+修圖）
   - 統計卡片
   - 快速操作按鈕

2. **orders.html** - 訂單列表
   - 表格視圖
   - 篩選器（狀態、客戶、日期）
   - 搜尋功能

3. **order_detail.html** - 訂單詳情
   - 時間軸視圖
   - 快速操作按鈕
   - 備註記錄
   - 圖片上傳（預留）

4. **order_form.html** - 新增/編輯訂單
   - 基本資料表單
   - 日期選擇
   - 狀態選擇

5. **revisions.html** - 修圖需求列表
   - 簡化版表格
   - 狀態篩選

6. **revision_detail.html** - 修圖需求詳情
   - 基本資訊
   - 狀態更新
   - 轉為訂單按鈕
   - 備註記錄

7. **reports.html** - 統計報表
   - 客戶選擇
   - 報表生成
   - 匯出功能

### 可選頁面

8. **settings.html** - 系統設定
   - 提醒規則設定
   - 用戶管理

9. **import.html** - Excel匯入
   - 批量匯入訂單

## 數據庫結構

### 設計原則

採用**主表 + 歷史表**的設計方案：
- ✅ **主表**：只存儲當前狀態（查詢快速）
- ✅ **歷史表**：記錄所有狀態變更（完整追溯）
- ✅ **支援無限次重複**：打樣10次、圖稿改5次都沒問題

### 1. 訂單主表 (orders)

只記錄當前狀態和關鍵信息：

```sql
CREATE TABLE orders (
    -- 主鍵
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    order_number VARCHAR(50) UNIQUE NOT NULL,  -- 訂單號（用戶輸入）
    
    -- 基本資訊
    customer_id INTEGER,                        -- 客戶ID（預留）
    customer_name VARCHAR(100) NOT NULL,        -- 客戶名稱
    order_date DATE NOT NULL,                   -- 接單日期
    
    -- 當前狀態
    current_status VARCHAR(50) NOT NULL,        -- 當前階段
    status_light VARCHAR(10) NOT NULL,          -- 燈號：red/yellow/green
    status_days INTEGER DEFAULT 0,              -- 當前階段等待天數
    last_status_change_date DATE,               -- 最後狀態變更日期
    
    -- 產品資訊
    production_type VARCHAR(100),               -- 生產類型
    product_code VARCHAR(50),                   -- 產品編號
    pattern_code VARCHAR(50),                   -- 花型編號
    
    -- 關鍵日期
    expected_delivery_date DATE,                -- 預計交貨日期
    
    -- 其他
    notes TEXT,                                 -- 當前備註
    from_revision_id VARCHAR(50),               -- 如果從修圖轉來
    
    -- 系統欄位
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_order_number ON orders(order_number);
CREATE INDEX idx_customer_name ON orders(customer_name);
CREATE INDEX idx_current_status ON orders(current_status);
CREATE INDEX idx_status_light ON orders(status_light);
```

**欄位說明**：
- `current_status`：只存當前在哪個階段
- `status_light`：當前燈號（red/yellow/green）
- `status_days`：當前階段已等待多少天
- `last_status_change_date`：最後一次狀態變更的日期

### 2. 狀態歷史表 (status_history)

記錄所有狀態變更：

```sql
CREATE TABLE status_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    
    -- 關聯訂單
    order_id INTEGER NOT NULL,                  -- 訂單ID
    order_number VARCHAR(50) NOT NULL,          -- 訂單號（冗餘，方便查詢）
    
    -- 狀態變更
    from_status VARCHAR(50),                    -- 從哪個狀態
    to_status VARCHAR(50) NOT NULL,             -- 到哪個狀態
    action_date DATE NOT NULL,                  -- 操作日期（用戶可修改）
    
    -- 操作信息
    operator VARCHAR(50),                       -- 操作人
    notes TEXT,                                 -- 備註
    
    -- 系統欄位
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_history_order_id ON status_history(order_id);
CREATE INDEX idx_history_order_number ON status_history(order_number);
CREATE INDEX idx_history_to_status ON status_history(to_status);
CREATE INDEX idx_history_action_date ON status_history(action_date);
```

**使用示例**：

訂單 #1007227 的歷史記錄：
```
id | order_id | from_status    | to_status      | action_date | notes
---|----------|----------------|----------------|-------------|-------
1  | 1       | NULL           | 新訂單          | 2025-12-15  | 接單
2  | 1       | 新訂單          | 圖稿確認中      | 2025-12-22  | 發圖稿
3  | 1       | 圖稿確認中      | 圖稿修改中      | 2025-12-28  | 客戶要改顏色
4  | 1       | 圖稿修改中      | 圖稿確認中      | 2025-12-30  | 修改完成重發
5  | 1       | 圖稿確認中      | 待打樣         | 2026-01-02  | 已確認
6  | 1       | 待打樣          | 打樣中         | 2026-01-03  | 開始打樣
7  | 1       | 打樣中          | 打樣確認中      | 2026-01-05  | 打樣完成
8  | 1       | 打樣確認中      | 打樣修改中      | 2026-01-06  | 客戶不滿意
9  | 1       | 打樣修改中      | 打樣確認中      | 2026-01-07  | 第2次打樣完成
```

**優勢**：
- ✅ 支援無限次重複（打樣10次也沒問題）
- ✅ 完整追溯每次變更
- ✅ 可統計平均時間、重複次數

### 3. 備註表 (notes)

```sql
CREATE TABLE notes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    
    -- 關聯項目
    item_type VARCHAR(20) NOT NULL,             -- 'order' 或 'revision'
    item_id INTEGER NOT NULL,                   -- 訂單ID或修圖ID
    
    -- 備註內容
    content TEXT NOT NULL,
    
    -- 創建信息
    created_by VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_notes_item ON notes(item_type, item_id);
CREATE INDEX idx_notes_created_at ON notes(created_at);
```

### 4. 修圖需求表 (revisions)

```sql
CREATE TABLE revisions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    revision_number VARCHAR(50) UNIQUE NOT NULL, -- REV-20260107-001
    
    -- 基本資訊
    customer_name VARCHAR(100) NOT NULL,
    request_date DATE NOT NULL,
    requirements TEXT,
    
    -- 當前狀態
    current_status VARCHAR(50) NOT NULL,         -- 已收到/處理中/已完成/已取消/已轉訂單
    completed_date DATE,
    
    -- 轉換追蹤
    converted_to_order_id INTEGER,               -- 如果轉成訂單了
    converted_to_order_number VARCHAR(50),
    
    -- 系統欄位
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_revision_number ON revisions(revision_number);
CREATE INDEX idx_revision_customer ON revisions(customer_name);
CREATE INDEX idx_revision_status ON revisions(current_status);
```

### 5. 系統設定表 (settings)

```sql
CREATE TABLE settings (
    key VARCHAR(50) PRIMARY KEY,
    value TEXT NOT NULL,
    description TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**預設設定值**：

```sql
INSERT INTO settings (key, value, description) VALUES
-- 圖稿階段
('draft_yellow_days', '3', '圖稿確認超過X天變黃色'),
('draft_red_days', '5', '圖稿確認超過X天變紅色'),

-- 打樣階段
('sampling_yellow_days', '2', '打樣確認超過X天變黃色'),
('sampling_red_days', '3', '打樣確認超過X天變紅色'),

-- 內部處理
('new_order_yellow_days', '5', '新訂單超過X天未發圖變黃色'),
('new_order_red_days', '7', '新訂單超過X天未發圖變紅色'),
('ready_sample_yellow_days', '5', '待打樣超過X天變黃色'),
('ready_sample_red_days', '7', '待打樣超過X天變紅色'),
('sampling_process_yellow_days', '10', '打樣中超過X天變黃色'),
('ready_production_yellow_days', '3', '待生產超過X天變黃色'),
('ready_production_red_days', '5', '待生產超過X天變紅色'),

-- 交貨期
('delivery_warning_days', '3', '距離交貨少於X天提醒'),

-- 修圖需求
('revision_yellow_days', '3', '修圖超過X天變黃色'),
('revision_red_days', '5', '修圖超過X天變紅色');
```

### 6. 圖片表 (images) - 預留

```sql
CREATE TABLE images (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    item_type VARCHAR(20) NOT NULL,             -- 'order' 或 'revision'
    item_id INTEGER NOT NULL,
    stage VARCHAR(50),                          -- 需求圖/圖稿/打樣/成品
    file_path VARCHAR(255) NOT NULL,
    file_size INTEGER,
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_images_item ON images(item_type, item_id);
```

### 數據庫查詢示例

#### 1. 查詢所有紅燈訂單
```sql
SELECT * FROM orders 
WHERE status_light = 'red' 
AND current_status NOT IN ('已完成', '已取消')
ORDER BY status_days DESC;
```

#### 2. 查詢某訂單的完整歷史
```sql
SELECT * FROM status_history 
WHERE order_number = '1007227'
ORDER BY action_date ASC, created_at ASC;
```

#### 3. 統計打樣次數
```sql
SELECT 
    order_number,
    COUNT(*) as sample_count
FROM status_history 
WHERE to_status = '打樣確認中'
GROUP BY order_number
HAVING sample_count > 1
ORDER BY sample_count DESC;
```

#### 4. 查詢圖稿階段所有訂單
```sql
SELECT * FROM orders 
WHERE current_status IN ('圖稿確認中', '圖稿修改中')
AND current_status NOT IN ('已完成', '已取消')
ORDER BY status_days DESC;
```

#### 5. 統計平均處理時間
```sql
-- 從接單到完成的平均天數
SELECT 
    AVG(JULIANDAY(updated_at) - JULIANDAY(order_date)) as avg_days
FROM orders 
WHERE current_status = '已完成'
AND updated_at >= date('now', '-30 days');
```

---

## 快速更新功能

### 功能概述

快速更新功能讓用戶能在1-5秒內完成訂單狀態更新，支援兩種模式：
- **快速模式**：直接點擊，自動記錄今天日期，不填備註（1秒）
- **完整模式**：Shift+點擊，彈出對話框填寫日期和備註（5秒）

### 操作流程

#### 模式A：快速更新（90%場景）

```
1. 懸停在訂單行上
   ↓
2. 快捷按鈕出現（根據當前階段不同）
   ↓
3. 點擊對應按鈕（例如：✅ 已確認）
   ↓
4. 自動更新：
   ├─ 記錄今天日期
   ├─ 更新訂單狀態
   ├─ 記錄到歷史表
   └─ 顯示成功提示
   ↓
5. 完成（1秒）
```

#### 模式B：完整更新（10%場景）

```
1. 懸停在訂單行上
   ↓
2. 按住 Shift 鍵
   ↓
3. 點擊對應按鈕
   ↓
4. 彈出對話框：
   ┌────────────────────────┐
   │ 圖稿確認中 → 待打樣     │
   │                        │
   │ 日期：[2026-01-07]     │
   │      [✓ 今天]         │
   │                        │
   │ 備註：                  │
   │ [客戶很滿意______]      │
   │                        │
   │  [取消]    [確認]      │
   └────────────────────────┘
   ↓
5. 填寫/修改日期和備註
   ↓
6. 點擊確認
   ↓
7. 完成（5秒）
```

### 每個階段的快捷按鈕

#### 圖稿確認中
```
懸停顯示：
[✅ 已確認]  [🔄 需修改]  [❌ 取消]
    ↓            ↓          ↓
  待打樣     圖稿修改中   已取消
```

#### 圖稿修改中
```
懸停顯示：
[✅ 修改完成]
      ↓
 圖稿確認中
```

#### 待打樣
```
懸停顯示：
[✅ 開始打樣]
      ↓
   打樣中
```

#### 打樣中
```
懸停顯示：
[✅ 打樣完成]
      ↓
 打樣確認中
```

#### 打樣確認中
```
懸停顯示：
[✅ 已確認]  [🔄 需重做]  [❌ 取消]
    ↓            ↓          ↓
  待生產     打樣修改中   已取消
```

#### 打樣修改中
```
懸停顯示：
[✅ 重做完成]
      ↓
 打樣確認中
```

#### 待生產
```
懸停顯示：
[✅ 開始生產]
      ↓
   生產中
```

#### 生產中
```
懸停顯示：
[✅ 生產完成]
      ↓
   已完成
```

### 後端處理邏輯

```python
def quick_update_order(order_id, action, date, notes):
    """
    快速更新訂單狀態
    
    Args:
        order_id: 訂單ID
        action: 操作類型（draft_confirm, sample_done等）
        date: 操作日期
        notes: 備註
    """
    # 1. 獲取訂單
    order = Order.query.get(order_id)
    
    # 2. 確定新狀態
    status_map = {
        'draft_confirm': '待打樣',
        'draft_revise': '圖稿修改中',
        'sample_done': '打樣確認中',
        'sample_confirm': '待生產',
        'sample_revise': '打樣修改中',
        'production_start': '生產中',
        'complete': '已完成',
        'cancel': '已取消'
    }
    new_status = status_map.get(action)
    
    # 3. 記錄歷史
    history = StatusHistory(
        order_id=order.id,
        order_number=order.order_number,
        from_status=order.current_status,
        to_status=new_status,
        action_date=date,
        operator='當前用戶',
        notes=notes
    )
    db.session.add(history)
    
    # 4. 更新訂單主表
    order.current_status = new_status
    order.last_status_change_date = date
    order.status_days = 0  # 重置天數
    order.updated_at = datetime.now()
    
    # 5. 重新計算燈號
    order.status_light = calculate_light(order)
    
    # 6. 保存
    db.session.commit()
    
    return {'success': True, 'new_status': new_status}
```

### 前端交互

```javascript
// 快速更新處理
function handleQuickUpdate(event, button) {
    const orderId = button.dataset.order;
    const action = button.dataset.action;
    const current = button.dataset.current;
    const next = button.dataset.next;
    
    // Shift鍵檢測
    if (event.shiftKey) {
        // 顯示對話框
        showUpdateModal(orderId, current, next, action);
    } else {
        // 直接快速更新
        performQuickUpdate(orderId, action, getTodayDate(), '');
    }
}

// 執行快速更新
function performQuickUpdate(orderId, action, date, notes) {
    fetch('/api/orders/quick-update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            order_id: orderId,
            action: action,
            date: date,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('✅ 更新成功', `訂單已更新為「${data.new_status}」`);
            // 刷新表格
            refreshTable();
        }
    });
}
```

---

## 開發計劃

### 第1天：基礎架構
- [x] Flask框架搭建
- [x] SQLite數據庫設計和初始化
- [x] 基本路由和模板結構
- [x] 訂單CRUD基本功能
- [x] 測試數據準備

**交付物**：
- 完整的項目結構
- 可以新增/查看訂單

### 第2天：訂單管理核心
- [x] 訂單列表頁（篩選、搜尋、排序）
- [x] 訂單詳情頁（時間軸視圖）
- [x] 快速操作按鈕（更新狀態）
- [x] 狀態更新邏輯
- [x] 智能提醒（顏色標記）
- [x] 備註系統

**交付物**：
- 完整的訂單管理功能
- 可以追蹤訂單狀態
- 有逾期提醒

### 第3天：修圖需求管理
- [x] 修圖需求CRUD
- [x] 修圖列表頁
- [x] 修圖詳情頁
- [x] 修圖 → 訂單轉換功能
- [x] 自動編號生成（REV-日期-號碼）
- [x] 修圖狀態管理

**交付物**：
- 完整的修圖需求管理
- 可以轉換為訂單

### 第4天：主頁和統計
- [x] 主頁整合（今日待辦）
- [x] 智能提醒彙總（訂單+修圖）
- [x] 統計卡片（實時數據）
- [x] 報表頁面
- [x] 客戶報表生成
- [x] Excel匯出功能

**交付物**：
- 完整的主頁儀表板
- 統計報表功能

### 第5天：優化和收尾
- [x] UI/UX優化
- [x] 設定頁面（提醒規則）
- [x] Excel匯入功能
- [x] 響應式設計（手機可用）
- [x] 全面測試
- [x] Bug修復
- [x] 部署說明文檔
- [x] 用戶手冊

**交付物**：
- 完整可用的系統
- 啟動腳本（一鍵運行）
- 使用文檔

---

## 技術細節

### 技術棧
- **後端**: Flask (Python 3.8+)
- **資料庫**: SQLite
- **前端**: HTML5 + CSS3 + JavaScript
- **UI框架**: 自定義設計（暗黑主題）
- **字體**: Noto Sans SC (中文), JetBrains Mono (數字)

### 項目結構
```
order_management/
├── app.py                    # Flask主程式
├── database.py               # 數據庫操作
├── models.py                 # 數據模型
├── config.py                 # 配置文件
├── requirements.txt          # Python依賴
├── start.bat                 # Windows啟動腳本
├── start.sh                  # Linux/Mac啟動腳本
│
├── static/                   # 靜態文件
│   ├── css/
│   │   └── style.css        # 主樣式表
│   ├── js/
│   │   └── main.js          # 主JS文件
│   └── images/              # 圖片文件
│
├── templates/                # HTML模板
│   ├── base.html            # 基礎模板
│   ├── index.html           # 主頁
│   ├── orders.html          # 訂單列表
│   ├── order_detail.html    # 訂單詳情
│   ├── order_form.html      # 訂單表單
│   ├── revisions.html       # 修圖列表
│   ├── revision_detail.html # 修圖詳情
│   ├── reports.html         # 報表
│   └── settings.html        # 設定
│
├── uploads/                  # 上傳文件（預留）
└── data/
    └── orders.db            # SQLite數據庫
```

### 部署方式
**本地運行（單機版）**：
1. 安裝Python 3.8+
2. 安裝依賴：`pip install -r requirements.txt`
3. 運行：`python app.py` 或雙擊 `start.bat`
4. 瀏覽器訪問：`http://localhost:5000`

**未來擴展（內網/雲端）**：
- 內網共享：配置Flask綁定內網IP
- 雲端部署：可部署到阿里雲/騰訊雲

---

## 用戶操作流程

### 每日早上的工作流程
```
1. 打開系統（雙擊啟動腳本或訪問網址）
   ↓
2. 主頁顯示「今日待辦」
   ├─ 紅色：緊急訂單（逾期）
   ├─ 黃色：需跟進訂單
   └─ 綠色：進度正常
   ↓
3. 點擊訂單號 → 進入詳情頁
   ↓
4. 查看時間軸，了解當前狀態
   ↓
5. 點擊快速操作按鈕更新狀態
   例如：[✅ 圖稿已確認]
   ↓
6. 自動記錄時間，回到主頁
   ↓
7. 繼續處理下一個訂單

⏱️ 平均每個訂單 5-10秒
```

### 國外詢問某客戶訂單狀況
```
1. 頂部搜尋框輸入客戶名稱
   例如：「SERGIO」
   ↓
2. 系統顯示該客戶所有訂單
   ├─ 進行中的
   ├─ 已完成的
   └─ 逾期的
   ↓
3. 點擊「匯出報表」
   ↓
4. 生成PDF或Excel
   ↓
5. 發給國外

⏱️ 整個流程 < 30秒
```

### 處理修圖需求
```
1. 收到客戶微信修圖需求
   ↓
2. 點擊「+ 新增修圖需求」
   ├─ 輸入客戶名稱
   ├─ 輸入修改要求
   └─ 保存（自動生成編號）
   ↓
3. 中國開始處理
   ↓
4. 完成後：
   ├─ 選項A：標記「已完成」
   └─ 選項B：點「轉為訂單」→ 創建正式訂單
```

---

## 注意事項

### 使用建議
1. ✅ 每天早上第一件事：查看「今日待辦」
2. ✅ 及時更新訂單狀態，保持數據準確
3. ✅ 重要溝通記得加備註
4. ✅ 定期匯出數據備份
5. ✅ 根據實際情況調整提醒天數

### 數據安全
- 💾 數據庫文件：`data/orders.db`
- 💾 定期備份：複製整個項目文件夾
- 💾 圖片文件（未來）：`uploads/` 目錄

### 性能考慮
- 訂單數量 < 10,000：SQLite完全夠用
- 如需要更高性能：可升級到MySQL/PostgreSQL

### 未來擴展預留
1. 🔮 圖片上傳功能（數據庫已預留）
2. 🔮 用戶權限管理
3. 🔮 微信通知整合
4. 🔮 移動端APP
5. 🔮 數據分析和AI預測

---

## 常見問題

### Q1: 訂單號重複怎麼辦？
A: 系統會檢查，如果訂單號已存在會提示錯誤。

### Q2: 修圖需求能改訂單號嗎？
A: 修圖需求轉為訂單時，需要輸入新的訂單號。

### Q3: 刪除訂單會影響統計嗎？
A: 刪除是物理刪除，會影響歷史統計。建議使用「已取消」狀態而非刪除。

### Q4: 可以多人同時使用嗎？
A: 
- 單機版：只能一個人用
- 內網版：可以多人用，但需要配置
- 雲端版：支持多人協作

### Q5: 數據能匯出嗎？
A: 可以匯出為Excel或PDF格式。

### Q6: 手機能用嗎？
A: 響應式設計，手機瀏覽器可以訪問，但建議用電腦操作。

---

## 聯繫方式

**開發者**: Claude (AI Assistant)  
**技術支持**: 通過claude.ai聯繫  

---

## 版本歷史

### v2.0 (2026-01-08) ✅ 當前版本
- ✅ 完整UI設計（Tab + 雙層篩選）
- ✅ 優化數據庫結構（主表 + 歷史表）
- ✅ 快速更新功能（兩種模式）
- ✅ 支援無限次重複操作（打樣、修改）
- ✅ 完整的階段性篩選（燈號系統）

### v1.0 (2026-01-07)
- ✅ 初始版本
- ✅ 訂單管理功能
- ✅ 修圖需求管理
- ✅ 智能提醒系統
- ✅ 統計報表

### 未來版本規劃
- v2.1: 圖片上傳功能
- v2.2: 用戶權限管理
- v2.3: 移動端優化
- v3.0: 微信整合

---

**最後更新**: 2026-01-08  
**文檔狀態**: ✅ 已確認，準備開發
