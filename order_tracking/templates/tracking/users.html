{% extends "base.html" %}

{% block title %}ç”¨æˆ¶ç®¡ç†{% endblock %}

{% block content %}
<div class="user-management-container">
    <!-- é é¢æ¨™é¡Œå’Œæ“ä½œæ¬„ -->
    <div class="page-header">
        <div class="header-left">
            <h1 class="page-title">ç”¨æˆ¶ç®¡ç†</h1>
            <p class="page-subtitle">ç®¡ç†ç³»çµ±ç”¨æˆ¶å¸³è™Ÿå’Œæ¬Šé™ - å…± <strong id="total-count">0</strong> å€‹ç”¨æˆ¶</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openNewUserModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                æ–°å¢ç”¨æˆ¶
            </button>
        </div>
    </div>

    <!-- æœç´¢å’Œç¯©é¸æ¬„ -->
    <div class="filter-bar">
        <div class="search-box">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" id="search-input" placeholder="æœç´¢ç”¨æˆ¶åæˆ–å§“å..." oninput="filterUsers()">
        </div>
        <div class="filter-group">
            <select id="status-filter" class="filter-select" onchange="filterUsers()">
                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                <option value="pending">å¾…å¯©æ ¸</option>
                <option value="active">å·²å¯©æ ¸</option>
                <option value="rejected">å·²æ‹’çµ•</option>
                <option value="suspended">å·²åœæ¬Š</option> 
            </select>
            <select id="role-filter" class="filter-select" onchange="filterUsers()">
                <option value="">æ‰€æœ‰è§’è‰²</option>
                <option value="admin">ä¸»ç®¡</option>
                <option value="sales">æ¥­å‹™å“¡</option>
                <option value="viewer">æŸ¥çœ‹è€…</option>
            </select>
        </div>
    </div>

    <!-- ç”¨æˆ¶åˆ—è¡¨è¡¨æ ¼ -->
    <div class="users-table-wrapper">
        <div class="users-table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">ID</th>
                        <th style="width: 100px;">å“¡å·¥ID</th>
                        <th style="width: 150px;">ç”¨æˆ¶å</th>
                        <th style="width: 120px;">å§“å</th>
                        <th style="width: 100px;">è§’è‰²</th>
                        <th style="width: 100px;">ç‹€æ…‹</th>
                        <th style="width: 160px;">è¨»å†Šæ™‚é–“</th>
                        <th style="width: 220px;">æ“ä½œ</th>
                    </tr>
                </thead>
            <tbody id="users-table-body">
                <tr>
                    <td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-2);">è¼‰å…¥ä¸­...</td>
                </tr>
            </tbody>
            </table>
        </div>
    </div>
</div>

<!-- æ–°å¢/ç·¨è¼¯ç”¨æˆ¶ Modal -->
<div class="modal-overlay" id="newUserModal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="userModalTitle">æ–°å¢ç”¨æˆ¶</h3>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <form id="newUserForm">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ¶åï¼ˆç™»å…¥å¸³è™Ÿï¼‰<span style="color: var(--status-danger);">*</span></label>
                    <input type="text" name="username" class="form-input" required>
                </div>
                <div class="form-group" id="passwordField">
                    <label class="form-label">å¯†ç¢¼ <span style="color: var(--status-danger);">*</span></label>
                    <input type="password" name="password" class="form-input" required minlength="6">
                </div>
                <div class="form-group">
                    <label class="form-label">å§“å <span style="color: var(--status-danger);">*</span></label>
                    <input type="text" name="real_name" class="form-input" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">è§’è‰² <span style="color: var(--status-danger);">*</span></label>
                        <select name="role" class="form-input" id="edit-role">
                            <option value="sales">æ¥­å‹™å“¡ (SALES)</option>
                            <option value="admin">ä¸»ç®¡ (ADMIN)</option>
                            <option value="viewer">æŸ¥çœ‹è€… (VIEWER)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç‹€æ…‹ <span style="color: var(--status-danger);">*</span></label>
                        <select name="status" class="form-input" id="edit-status">
                            <option value="active">å·²å¯©æ ¸</option>
                            <option value="pending">å¾…å¯©æ ¸</option>
                            <option value="rejected">å·²æ‹’çµ•</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="submitUserForm()" id="submitUserBtn">å‰µå»º</button>
        </div>
    </div>
</div>

<!-- å¯©æ ¸ç”¨æˆ¶ Modal -->
<div class="modal-overlay" id="approveUserModal" onclick="if(event.target === this) closeApproveModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h3>å¯©æ ¸ç”¨æˆ¶</h3>
            <button class="modal-close" onclick="closeApproveModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="approve-user-info">
                <div class="info-item">
                    <span class="info-label">ç”¨æˆ¶åï¼š</span>
                    <span class="info-value" id="approve-username">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å§“åï¼š</span>
                    <span class="info-value" id="approve-real-name">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">è¨»å†Šæ™‚é–“ï¼š</span>
                    <span class="info-value" id="approve-created-at">-</span>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">è¨­ç½®è§’è‰² <span style="color: var(--status-danger);">*</span></label>
                <select id="approve-role" class="form-input">
                    <option value="sales">æ¥­å‹™å“¡ (SALES)</option>
                    <option value="admin">ä¸»ç®¡ (ADMIN)</option>
                    <option value="viewer">æŸ¥çœ‹è€… (VIEWER)</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeApproveModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-danger" onclick="confirmRejectUser()" id="reject-btn">æ‹’çµ•</button>
            <button type="button" class="btn btn-primary" onclick="confirmApproveUser()">é€šéå¯©æ ¸</button>
        </div>
    </div>
</div>

<!-- åœæ¬Šç¢ºèª Modal -->
<div class="modal-overlay" id="suspendConfirmModal" onclick="if(event.target === this) closeSuspendConfirmModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px; color: #ef4444;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                ç¢ºèªåœæ¬Šç”¨æˆ¶
            </h3>
            <button class="modal-close" onclick="closeSuspendConfirmModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="confirm-message">
                <p>ç¢ºå®šè¦åœæ¬Šç”¨æˆ¶ <strong id="suspend-username">-</strong> å—ï¼Ÿ</p>
                <p style="color: var(--text-2); margin-top: 0.5rem;">åœæ¬Šå¾Œè©²ç”¨æˆ¶å°‡ç„¡æ³•ç™»å…¥ç³»çµ±</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeSuspendConfirmModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-danger" onclick="confirmSuspendUser()">ç¢ºèªåœæ¬Š</button>
        </div>
    </div>
</div>

<!-- æ¢å¾©ç¢ºèª Modal -->
<div class="modal-overlay" id="restoreConfirmModal" onclick="if(event.target === this) closeRestoreConfirmModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px; color: #2196F3;">
                    <path d="M21 12a9 9 0 11-6.219-8.56"></path>
                    <polyline points="18 4 22 8 18 12"></polyline>
                </svg>
                ç¢ºèªæ¢å¾©ç”¨æˆ¶
            </h3>
            <button class="modal-close" onclick="closeRestoreConfirmModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="confirm-message">
                <p>ç¢ºå®šè¦æ¢å¾©ç”¨æˆ¶ <strong id="restore-username">-</strong> å—ï¼Ÿ</p>
                <p style="color: var(--text-2); margin-top: 0.5rem;">æ¢å¾©å¾Œè©²ç”¨æˆ¶å¯ä»¥æ­£å¸¸ç™»å…¥ç³»çµ±</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeRestoreConfirmModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="confirmRestoreUser()">ç¢ºèªæ¢å¾©</button>
        </div>
    </div>
</div>

<!-- é‡è¨­å¯†ç¢¼ Modal -->
<div class="modal-overlay" id="resetPasswordModal" onclick="if(event.target === this) closeResetPasswordModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px; color: #f59e0b;">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                é‡è¨­å¯†ç¢¼
            </h3>
            <button class="modal-close" onclick="closeResetPasswordModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="reset-password-info">
                <div class="info-item">
                    <span class="info-label">ç”¨æˆ¶åï¼š</span>
                    <span class="info-value" id="reset-username">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å§“åï¼š</span>
                    <span class="info-value" id="reset-real-name">-</span>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">æ–°å¯†ç¢¼ <span style="color: var(--status-danger);">*</span></label>
                <input type="text" id="reset-new-password" class="form-input" placeholder="è‡³å°‘ 6 å€‹å­—ç¬¦" minlength="6">
                <p class="form-hint">ç•™ç©ºå‰‡è‡ªå‹•ç”Ÿæˆéš¨æ©Ÿå¯†ç¢¼</p>
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="reset-require-change" checked>
                    <span>è¦æ±‚ç”¨æˆ¶ä¸‹æ¬¡ç™»å…¥æ™‚ä¿®æ”¹å¯†ç¢¼</span>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeResetPasswordModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="confirmResetPassword()">ç¢ºèªé‡è¨­</button>
        </div>
    </div>
</div>

<link rel="stylesheet" href="{{ url_for('tracking_bp.static', filename='css/user-management.css') }}">
<script src="{{ url_for('tracking_bp.static', filename='js/user-management.js') }}"></script>

<!-- ğŸ”§ å¼·åˆ¶é¡¯ç¤ºæ¬„ä½çš„ä¿®å¾©è…³æœ¬ -->
<script>
(function() {
    'use strict';
    
    console.log('ğŸ”§ [æ¬„ä½ä¿®å¾©] é–‹å§‹ç›£æ§å’Œä¿®å¾©éš±è—æ¬„ä½...');
    
    // ç«‹å³åŸ·è¡Œä¸€æ¬¡ä¿®å¾©
    function forceShowColumns() {
        const table = document.querySelector('.users-table');
        if (!table) return;
        
        let fixedCount = 0;
        
        // å¼·åˆ¶é¡¯ç¤ºæ‰€æœ‰ th å’Œ td
        table.querySelectorAll('th, td').forEach(cell => {
            if (cell.style.display === 'none') {
                cell.style.display = '';
                fixedCount++;
            }
        });
        
        if (fixedCount > 0) {
            console.log(`âœ… [æ¬„ä½ä¿®å¾©] å·²ä¿®å¾© ${fixedCount} å€‹è¢«éš±è—çš„æ¬„ä½`);
        }
    }
    
    // é é¢è¼‰å…¥å¾Œç«‹å³åŸ·è¡Œ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', forceShowColumns);
    } else {
        forceShowColumns();
    }
    
    // å®šæœŸæª¢æŸ¥ï¼ˆé˜²æ­¢è¢«å…¶ä»–è…³æœ¬å†æ¬¡éš±è—ï¼‰
    setInterval(forceShowColumns, 500);
    
    // ç›£è½ DOM è®ŠåŒ–
    const observer = new MutationObserver((mutations) => {
        let needsFix = false;
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const target = mutation.target;
                if ((target.tagName === 'TH' || target.tagName === 'TD') && 
                    target.style.display === 'none' &&
                    target.closest('.users-table')) {
                    needsFix = true;
                }
            }
        });
        
        if (needsFix) {
            console.warn('âš ï¸ [æ¬„ä½ä¿®å¾©] æª¢æ¸¬åˆ°æ¬„ä½è¢«éš±è—ï¼Œæ­£åœ¨ä¿®å¾©...');
            forceShowColumns();
        }
    });
    
    // é–‹å§‹ç›£è½
    const config = { attributes: true, subtree: true, attributeFilter: ['style'] };
    const targetNode = document.body;
    observer.observe(targetNode, config);
    
    console.log('âœ… [æ¬„ä½ä¿®å¾©] ç›£æ§å·²å•Ÿå‹•');
})();
</script>
{% endblock %}