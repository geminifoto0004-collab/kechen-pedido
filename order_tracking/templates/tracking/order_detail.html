{% extends "base.html" %}

{% block title %}è¨‚å–®è©³æƒ… - {{ order.order_number }}{% endblock %}

{% block content %}
<div class="detail-page">
    <div class="page-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>è¨‚å–®è©³æƒ… #{{ order.order_number }}</h1>
                <p class="page-subtitle">{{ order.customer_name }}</p>
            </div>
            <div style="display: flex; gap: 0.75rem;">
                {% if session.get('role') == 'admin' %}
                <button class="btn btn-primary" onclick="editOrderFromDetail()">ç·¨è¼¯</button>
                {% endif %}
                <button class="btn btn-secondary" onclick="openDetailDrawer()">
                    ğŸ“Š è©³ç´°æ­·å²èˆ‡æ“ä½œ
                </button>
            </div>
        </div>
    </div>

    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <div class="section">
        <h2>åŸºæœ¬ä¿¡æ¯</h2>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">è¨‚å–®è™Ÿ</div>
                <div class="info-value">{{ order.order_number }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">å®¢æˆ¶åç¨±</div>
                <div class="info-value">{{ order.customer_name }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">è¨‚å–®æ—¥æœŸ</div>
                <div class="info-value">{{ order.order_date }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">ç•¶å‰ç‹€æ…‹</div>
                <div class="info-value status-badge status-{{ order.current_status }}">
                    <span class="light-emoji">
                        {% if order.status_light == 'red' %}
                            <svg class="status-light-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <circle cx="8" cy="8" r="7" fill="#EF4444" stroke="#DC2626" stroke-width="1"/>
                            </svg>
                        {% elif order.status_light == 'yellow' %}
                            <svg class="status-light-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <circle cx="8" cy="8" r="7" fill="#F59E0B" stroke="#D97706" stroke-width="1"/>
                            </svg>
                        {% else %}
                            <svg class="status-light-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <circle cx="8" cy="8" r="7" fill="#22C55E" stroke="#16A34A" stroke-width="1"/>
                            </svg>
                        {% endif %}
                    </span>
                    {{ order.current_status }}
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">ç­‰å¾…å¤©æ•¸</div>
                <div class="info-value">{{ order.status_days }} å¤©</div>
            </div>
            <div class="info-item">
                <div class="info-label">ç”Ÿç”¢é¡å‹</div>
                <div class="info-value">{{ order.production_type or '-' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">é è¨ˆäº¤è²¨</div>
                <div class="info-value">{{ order.expected_delivery_date or '-' }}</div>
            </div>
        </div>
    </div>

    <!-- æµç¨‹æ™‚é–“è»¸ï¼ˆè¦–è¦ºåŒ–ï¼‰ -->
    <div class="section">
        <h2>æµç¨‹é€²åº¦</h2>
        {% if history %}
        <div class="timeline-horizontal-wrapper">
            <div class="timeline-horizontal" id="processTimeline">
                <!-- ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        {% else %}
        <div class="empty-state">æš«ç„¡æ­·å²è¨˜éŒ„</div>
        {% endif %}
    </div>

    <!-- ç‹€æ…‹æ­·å² -->
    <div class="section">
        <h2>ç‹€æ…‹æ­·å²</h2>
        {% if history %}
        <div class="timeline">
            {% for item in history %}
            <div class="timeline-item">
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                    <div class="timeline-header">
                        <span class="timeline-status">{{ item.to_status }}</span>
                        <span class="timeline-date">{{ item.action_date }}</span>
                    </div>
                    {% if item.notes %}
                    <div class="timeline-notes">{{ item.notes }}</div>
                    {% endif %}
                    {% if item.operator %}
                    <div class="timeline-operator">æ“ä½œäººï¼š{{ item.operator }}</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">æš«ç„¡æ­·å²è¨˜éŒ„</div>
        {% endif %}
    </div>

    <!-- å‚™è¨» -->
    <div class="section">
        <h2>å‚™è¨»</h2>
        {% if notes %}
        <div class="notes-list">
            {% for note in notes %}
            <div class="note-item">
                <div class="note-content">{{ note.content }}</div>
                <div class="note-meta">
                    <span>{{ note.created_by or 'ç³»çµ±' }}</span>
                    <span>{{ note.created_at }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">æš«ç„¡å‚™è¨»</div>
        {% endif %}
    </div>
</div>

<!-- æ•¸æ“š JSON -->
<script id="orderData" type="application/json">
{
    "history": {{ history | tojson }},
    "orderNumber": "{{ order.order_number }}",
    "customerName": "{{ order.customer_name }}",
    "statusDays": {{ order.status_days }},
    "isAdmin": {{ 'true' if session.get('role') == 'admin' else 'false' }}
}
</script>

<script>
/**
 * ä»è®¢å•è¯¦æƒ…é¡µç¼–è¾‘è®¢å•
 */
function editOrderFromDetail() {
    const orderNumber = "{{ order.order_number }}";
    
    // è·å–è®¢å•æ•°æ®
    fetch(`/tracking/api/orders/${encodeURIComponent(orderNumber)}`)
        .then(res => res.json())
        .then(result => {
            if (result.success && result.data) {
                const order = result.data;
                
                // è®¾ç½®æ ‡é¢˜
                const title = document.getElementById('editOrderModalTitle');
                if (title) title.textContent = 'âœï¸ ç¼–è¾‘è®¢å•';
                
                // è®¾ç½®æäº¤æŒ‰é’®æ–‡æœ¬
                const submitBtn = document.getElementById('editOrderSubmitBtn');
                if (submitBtn) submitBtn.textContent = 'ä¿å­˜ä¿®æ”¹ ğŸ’¾';
                
                // å¡«å……è¡¨å•
                const orderNumberInput = document.getElementById('editOrderNumber');
                const orderNumber = order.order_number || '';
                orderNumberInput.value = orderNumber;
                orderNumberInput.readOnly = true;
                orderNumberInput.style.background = '#f3f4f6';
                orderNumberInput.setAttribute('data-original-order-number', orderNumber);
                
                document.getElementById('editCustomerName').value = order.customer_name || '';
                document.getElementById('editOrderDate').value = order.order_date || '';
                document.getElementById('editProductCode').value = order.product_code || '';
                document.getElementById('editQuantity').value = order.quantity || '';
                document.getElementById('editFactory').value = order.factory || '';
                document.getElementById('editExpectedDeliveryDate').value = order.expected_delivery_date || '';
                document.getElementById('editProductionType').value = order.production_type || '';
                document.getElementById('editNotes').value = order.notes || '';
                
                // å¦‚æœæ˜¯ YU å¼€å¤´çš„è®¢å•å·ï¼Œæ˜¾ç¤º"ä¿®æ”¹è®¢å•å·"æŒ‰é’®
                const toggleBtn = document.getElementById('toggleOrderNumberEdit');
                const warning = document.getElementById('editOrderNumberWarning');
                const errorDiv = document.getElementById('editOrderNumberError');
                if (orderNumber.startsWith('YU')) {
                    if (toggleBtn) toggleBtn.style.display = 'block';
                } else {
                    if (toggleBtn) toggleBtn.style.display = 'none';
                }
                if (warning) warning.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'none';
                
                // éšè—æç¤º
                const hint = document.getElementById('editOrderNumberHint');
                if (hint) hint.style.display = 'none';
                
                // æ·»åŠ è®¢å•å·è¾“å…¥ç›‘å¬ï¼ˆç¼–è¾‘æ¨¡å¼ï¼Œä»…åœ¨è§£é”æ—¶éªŒè¯ï¼‰
                setupOrderNumberValidation(orderNumberInput, false);
                
                // æ˜¾ç¤º Modal
                const modal = document.getElementById('editOrderModal');
                if (modal) {
                    modal.classList.add('show');
                    modal.setAttribute('data-mode', 'edit');
                }
            } else {
                if (typeof showToast === 'function') {
                    showToast('é”™è¯¯', 'æ— æ³•åŠ è½½è®¢å•æ•°æ®');
                } else {
                    alert('æ— æ³•åŠ è½½è®¢å•æ•°æ®');
                }
            }
        })
        .catch(err => {
            console.error('åŠ è½½è®¢å•æ•°æ®å¤±è´¥:', err);
            if (typeof showToast === 'function') {
                showToast('é”™è¯¯', 'ç½‘ç»œé”™è¯¯');
            } else {
                alert('ç½‘ç»œé”™è¯¯');
            }
        });
}
</script>

{% endblock %}
