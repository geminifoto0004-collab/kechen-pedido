{% extends "base.html" %}

{% block title %}è®¢å•æµç¨‹è¿½è¹¤ç³»ç»Ÿ{% endblock %}

{% block content %}

{# ====== æ ¹æ®åç«¯èµ„æ–™å…ˆç®—å¥½å„é¡ç»Ÿè®¡ï¼Œæ–¹ä¾¿å¥—é€² v10 ç‰ˆé¢ ====== #}
{# ä½¿ç”¨åç«¯ä¼ å…¥çš„çŠ¶æ€åˆ—è¡¨ï¼Œä¸ STATUS_SYSTEM.js ä¿æŒä¸€è‡´ #}
{% set completed_status = 'å·²å®Œæˆ' %}
{% set cancelled_status = 'å·²å–æ¶ˆ' %}
{% set active_orders = all_orders
    | rejectattr('current_status', 'in', [completed_status, cancelled_status])
    | list %}
{% set completed_orders = all_orders
    | selectattr('current_status', 'equalto', completed_status)
    | list %}
{% set cancelled_orders = all_orders
    | selectattr('current_status', 'equalto', cancelled_status)
    | list %}

{% set draft_orders = all_orders | selectattr('current_status', 'in', draft_statuses) | list %}
{% set sampling_orders = all_orders | selectattr('current_status', 'in', sampling_statuses) | list %}
{% set production_orders = all_orders | selectattr('current_status', 'in', production_statuses) | list %}

<div class="container">
    <!-- ====== ç»Ÿè®¡å€ï¼ˆç‰ˆé¢åŒ v10ï¼‰ ====== -->
    <div class="stats">
        <div class="stat">
            <div class="stat-icon"></div>
            <div>
                <div class="stat-label">è¿›è¡Œä¸­</div>
                <div class="stat-value" id="totalOrders">{{ active_orders|length }}</div>
            </div>
        </div>

        <div class="stat green">
            <div class="stat-icon"></div>
            <div>
                <div class="stat-label">æ­£å¸¸</div>
                <div class="stat-value" id="greenOrders">{{ light_stats.get('green', 0) }}</div>
            </div>
        </div>

        <div class="stat yellow">
            <div class="stat-icon"></div>
            <div>
                <div class="stat-label">éœ€æ³¨æ„</div>
                <div class="stat-value" id="yellowOrders">{{ light_stats.get('yellow', 0) }}</div>
            </div>
        </div>
        
        <div class="stat red">
            <div class="stat-icon"></div>
            <div>
                <div class="stat-label">é€¾æœŸ</div>
                <div class="stat-value" id="redOrders">{{ light_stats.get('red', 0) }}</div>
            </div>
        </div>


        
 
    </div>
    
    <!-- ====== æµç¨‹é˜¶æ®µç­›é€‰åˆ—ï¼ˆç‰ˆé¢åŒ v10ï¼‰ ====== -->
    <div class="stage-filters">
        <button class="stage-btn active" onclick="filterByStageGroup('all', this)">
            å…¨éƒ¨
            <span class="stage-count">{{ active_orders|length }}</span>
        </button>
        
        <!-- æ–°è®¢å•/è¯¢ä»·é˜¶æ®µ -->
        <div class="stage-filter">
            <button class="stage-btn" onclick="toggleSubstatus('new_and_quote', this)">
                æ–°è®¢å•/è¯¢ä»·
                <span class="stage-count" id="newAndQuoteCount">
                </span>
                <span style="font-size: 0.7rem;">â–¼</span>
            </button>
            <div class="substatus-dropdown" id="dropdown-new_and_quote">
                
                <div class="substatus-option active" onclick="filterBySubstatus('new_and_quote', 'all', this)">
                    <span>å…¨éƒ¨</span>
                    <span class="count" id="new_and_quote-all-count">
                        {{ all_orders | selectattr('current_status','in',new_and_quote_statuses) | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('new_and_quote', '{{ STATUS.NEW_ORDER }}', this)">
                    <span>æ–°è®¢å•</span>
                    <span class="count" id="new_and_quote-new-count">
                        {{ all_orders | selectattr('current_status','equalto',STATUS.NEW_ORDER) | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('new_and_quote', 'æŠ¥ä»·å¾…ç¡®è®¤', this)">
                    <span>æŠ¥ä»·å¾…ç¡®è®¤</span>
                    <span class="count" id="new_and_quote-quoting-count">
                        {{ all_orders | selectattr('current_status','equalto','æŠ¥ä»·å¾…ç¡®è®¤') | list | length }}
                    </span>
                </div>
            </div>
        </div>
        
        <!-- å›¾ç¨¿é˜¶æ®µ -->
        <div class="stage-filter">
            <button class="stage-btn" onclick="toggleSubstatus('draft', this)">
                å›¾ç¨¿é˜¶æ®µ
                <span class="stage-count" id="draftCount">
                    {{ all_orders | selectattr('current_status','in',['å›¾ç¨¿åˆ¶ä½œä¸­','å›¾ç¨¿å¾…ç¡®è®¤','å›¾ç¨¿ä¿®æ”¹ä¸­']) | list | length }}
                </span>
                <span style="font-size: 0.7rem;">â–¼</span>
            </button>
            <div class="substatus-dropdown" id="dropdown-draft">
                
                <div class="substatus-option active" onclick="filterBySubstatus('draft', 'all', this)">
                    <span>å…¨éƒ¨</span>
                    <span class="count" id="draft-all-count">
                        {{ all_orders | selectattr('current_status','in',['å›¾ç¨¿åˆ¶ä½œä¸­','å›¾ç¨¿å¾…ç¡®è®¤','å›¾ç¨¿ä¿®æ”¹ä¸­']) | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('draft', 'å›¾ç¨¿åˆ¶ä½œä¸­', this)">
                    <span>å›¾ç¨¿åˆ¶ä½œä¸­</span>
                    <span class="count" id="draft-making-count">
                        {{ all_orders | selectattr('current_status','equalto','å›¾ç¨¿åˆ¶ä½œä¸­') | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('draft', 'å›¾ç¨¿å¾…ç¡®è®¤', this)">
                    <span>å›¾ç¨¿å¾…ç¡®è®¤</span>
                    <span class="count" id="draft-confirm-count">
                        {{ all_orders | selectattr('current_status','equalto','å›¾ç¨¿å¾…ç¡®è®¤') | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('draft', 'å›¾ç¨¿ä¿®æ”¹ä¸­', this)">
                    <span>å›¾ç¨¿ä¿®æ”¹ä¸­</span>
                    <span class="count" id="draft-revise-count">
                        {{ all_orders | selectattr('current_status','equalto','å›¾ç¨¿ä¿®æ”¹ä¸­') | list | length }}
                    </span>
                </div>
            </div>
        </div>

        <!-- æ‰“æ ·é˜¶æ®µ -->
        <div class="stage-filter">
            <button class="stage-btn" onclick="toggleSubstatus('sampling', this)">
                æ‰“æ ·é˜¶æ®µ
                <span class="stage-count" id="samplingCount">
                    {{ all_orders | selectattr('current_status','in',sampling_statuses) | list | length }}
                </span>
                <span style="font-size: 0.7rem;">â–¼</span>
            </button>
            <div class="substatus-dropdown" id="dropdown-sampling">
                
                <div class="substatus-option active" onclick="filterBySubstatus('sampling', 'all', this)">
                    <span>å…¨éƒ¨</span>
                    <span class="count" id="sampling-all-count">{{ all_orders | selectattr('current_status','in',['å¾…æ‰“æ ·','æ‰“æ ·ä¸­','æ‰“æ ·å¾…ç¡®è®¤','æ‰“æ ·ä¿®æ”¹ä¸­']) | list | length }}</span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('sampling', 'å¾…æ‰“æ ·', this)">
                    <span>å¾…æ‰“æ ·</span>
                    <span class="count" id="sampling-pending-count">
                        {{ all_orders | selectattr('current_status','equalto','å¾…æ‰“æ ·') | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('sampling', 'æ‰“æ ·ä¸­', this)">
                    <span>æ‰“æ ·ä¸­</span>
                    <span class="count" id="sampling-making-count">
                        {{ all_orders | selectattr('current_status','equalto','æ‰“æ ·ä¸­') | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('sampling', 'æ‰“æ ·å¾…ç¡®è®¤', this)">
                    <span>æ‰“æ ·å¾…ç¡®è®¤</span>
                    <span class="count" id="sampling-confirm-count">
                        {{ all_orders | selectattr('current_status','equalto','æ‰“æ ·å¾…ç¡®è®¤') | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('sampling', 'æ‰“æ ·ä¿®æ”¹ä¸­', this)">
                    <span>æ‰“æ ·ä¿®æ”¹ä¸­</span>
                    <span class="count" id="sampling-revise-count">
                        {{ all_orders | selectattr('current_status','equalto','æ‰“æ ·ä¿®æ”¹ä¸­') | list | length }}
                    </span>
                </div>
            </div>
        </div>

        <!-- ç”Ÿäº§é˜¶æ®µ -->
        <div class="stage-filter">
            <button class="stage-btn" onclick="toggleSubstatus('production', this)">
                ç”Ÿäº§é˜¶æ®µ
                <span class="stage-count" id="productionCount">{{ all_orders | selectattr('current_status','in',production_statuses) | list | length }}</span>
                <span style="font-size: 0.7rem;">â–¼</span>
            </button>
            <div class="substatus-dropdown" id="dropdown-production">
                
                <div class="substatus-option active" onclick="filterBySubstatus('production', 'all', this)">
                    <span>å…¨éƒ¨</span>
                    <span class="count" id="production-all-count">{{ all_orders | selectattr('current_status','in',production_statuses) | list | length }}</span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('production', 'å¾…ç”Ÿäº§', this)">
                    <span>å¾…ç”Ÿäº§</span>
                    <span class="count" id="production-pending-count">
                        {% set pending_prod_list = [] %}
                        {% if STATUS_KEYS %}{% set _ = pending_prod_list.append(STATUS_KEYS.PENDING_PRODUCTION) %}{% endif %}
                        {% set _ = pending_prod_list.append('å¾…ç”Ÿäº§') %}
                        {{ all_orders | selectattr('current_status','in',pending_prod_list) | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('production', 'ç”Ÿäº§ä¸­', this)">
                    <span>ç”Ÿäº§ä¸­</span>
                    <span class="count" id="production-making-count">
                        {% set producing_list = [] %}
                        {% if STATUS_KEYS %}{% set _ = producing_list.append(STATUS_KEYS.PRODUCING) %}{% endif %}
                        {% set _ = producing_list.append('ç”Ÿäº§ä¸­') %}
                        {{ all_orders | selectattr('current_status','in',producing_list) | list | length }}
                    </span>
                </div>
            </div>
        </div>

        <!-- ç­‰å›½å¤–ç¡®è®¤ / è¯¢ä»· -->
        <button class="stage-btn pending" onclick="filterByStageGroup('waiting_confirm', this)">
             ç­‰å›½å¤–ç¡®è®¤ / è¯¢ä»·
            <span class="stage-count" id="waitingConfirmCount">{{ quote_orders|length }}</span>
        </button>
        
        <!-- å·²å®Œæˆ / å·²å–æ¶ˆ Checkbox -->
        <label class="filter-checkbox">
            <input type="checkbox" id="toggleCompleted" checked
                   onchange="toggleCompletedOrders(this)">
            <span>é¡¯ç¤ºå·²å®Œæˆ (<span id="completedCount">{{ completed_orders|length }}</span>)</span>
        </label>
        
        <label class="filter-checkbox">
            <input type="checkbox" id="toggleCancelled"
                   onchange="toggleCancelledOrders(this)">
            <span>é¡¯ç¤ºå·²å–æ¶ˆ (<span id="cancelledCount">{{ cancelled_orders|length }}</span>)</span>
        </label>
        
        {% if session.get('role') == 'admin' %}
        <div class="search-box" style="flex: 1; min-width: 200px; max-width: 400px;">
            <span></span>
            <input type="text" id="searchInput" placeholder="æœå°‹è®¢å•è™Ÿã€å®¢æˆ·åç§°..." value="">
        </div>
        <button class="btn btn-secondary" onclick="exportData()"> åŒ¯å‡º</button>
        {% else %}
        <div class="search-box" style="flex: 1; min-width: 200px; max-width: 400px; margin-left: auto;">
            <span>ğŸ”</span>
            <input type="text" id="searchInput" placeholder="æœå°‹è®¢å•è™Ÿã€å®¢æˆ·åç§°..." value="">
        </div>
        {% endif %}
    </div>
    
    <!-- ====== ç‡ˆè™Ÿç¯©é¸ï¼ˆç´…ç¶ é»ƒç‡ˆï¼‰ ====== -->
    <div class="light-filters">
        <button class="light-filter-btn" id="lightFilterRed" data-light="red" onclick="toggleLightFilter('red', this)">
            <span class="light-emoji">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <circle cx="8" cy="8" r="7" fill="#EF4444" stroke="#DC2626" stroke-width="1"/>
                </svg>
            </span>
            <span class="light-label">é€¾æœŸ</span>
            <span class="light-count" id="lightCountRed">{{ light_stats.get('red', 0) }}</span>
        </button>
        <button class="light-filter-btn" id="lightFilterYellow" data-light="yellow" onclick="toggleLightFilter('yellow', this)">
            <span class="light-emoji">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <circle cx="8" cy="8" r="7" fill="#F59E0B" stroke="#D97706" stroke-width="1"/>
                </svg>
            </span>
            <span class="light-label">éœ€æ³¨æ„</span>
            <span class="light-count" id="lightCountYellow">{{ light_stats.get('yellow', 0) }}</span>
        </button>
        <button class="light-filter-btn" id="lightFilterGreen" data-light="green" onclick="toggleLightFilter('green', this)">
            <span class="light-emoji">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <circle cx="8" cy="8" r="7" fill="#22C55E" stroke="#16A34A" stroke-width="1"/>
                </svg>
            </span>
            <span class="light-label">æ­£å¸¸</span>
            <span class="light-count" id="lightCountGreen">{{ light_stats.get('green', 0) }}</span>
        </button>
    </div>

    <!-- ====== è®¢å•è¡¨æ ¼ï¼ˆè¡¨é ­é¢¨æ ¼åŒ v10ï¼›èµ„æ–™ä¾†è‡ªåç«¯ï¼‰ ====== -->
    <div class="table-wrapper">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th></th>
                        <th class="sortable" data-sort="order_date">
                            è®¢å•æ—¥æœŸ <span class="sort-icon">â‡…</span>
                        </th>
                        <th class="sortable" data-sort="order_number">
                            è®¢å•è™Ÿ <span class="sort-icon">â‡…</span>
                        </th>
                        <th class="sortable" data-sort="customer_name">
                            å®¢æˆ·åç§° <span class="sort-icon">â‡…</span>
                        </th>
                        <th class="sortable" data-sort="production_type">
                            äº§å“ç±»å‹ <span class="sort-icon">â‡…</span>
                        </th>
                        <th class="sortable" data-sort="product_code">
                            äº§å“ç¼–å· <span class="sort-icon">â‡…</span>
                        </th>
                        <th class="sortable" data-sort="quantity">
                            æ•°é‡ <span class="sort-icon">â‡…</span>
                        </th>
                        <th class="sortable" data-sort="factory">
                            ç”Ÿäº§å·¥å‚ <span class="sort-icon">â‡…</span>
                        </th>
                        <th class="sortable" data-sort="current_status">
                            é˜¶æ®µ / çŠ¶æ€ <span class="sort-icon">â‡…</span>
                        </th>
                        <th class="sortable" data-sort="status_days">
                            ç­‰å¾…å¤©æ•° <span class="sort-icon">â‡…</span>
                        </th>
                        <th class="sortable" data-sort="notes">
                            å¤‡æ³¨ <span class="sort-icon">â‡…</span>
                        </th>
                        {% if session.get('role') == 'admin' %}
                        <th>æ“ä½œ</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    {% for order in all_orders %}
                    <tr class="{{ order.status_light }}"
                        onclick="toggleDetail('{{ order.order_number }}', event)"
                        data-order-number="{{ order.order_number }}"
                        data-customer-name="{{ order.customer_name }}"
                        data-status="{{ order.current_status }}"
                        data-light="{{ order.status_light }}"
                        data-stage-group="{% if order.current_status in new_and_quote_statuses or (STATUS_KEYS and order.current_status == STATUS_KEYS.NEW_ORDER) or (STATUS_KEYS and order.current_status == STATUS_KEYS.QUOTE_CONFIRMING) %}new_and_quote{% elif order.current_status in draft_statuses or (STATUS_KEYS and order.current_status in [STATUS_KEYS.DRAFT_MAKING, STATUS_KEYS.DRAFT_CONFIRMING, STATUS_KEYS.DRAFT_REVISING]) %}draft{% elif order.current_status in sampling_statuses or (STATUS_KEYS and order.current_status in [STATUS_KEYS.PENDING_SAMPLE, STATUS_KEYS.SAMPLING, STATUS_KEYS.SAMPLE_CONFIRMING, STATUS_KEYS.SAMPLE_REVISING]) %}sampling{% elif order.current_status in production_statuses or (STATUS_KEYS and order.current_status in [STATUS_KEYS.PENDING_PRODUCTION, STATUS_KEYS.PRODUCING]) %}production{% elif order.current_status == STATUS.COMPLETED or (STATUS_KEYS and order.current_status == STATUS_KEYS.COMPLETED) %}completed{% elif order.current_status == STATUS.CANCELLED or (STATUS_KEYS and order.current_status == STATUS_KEYS.CANCELLED) %}cancelled{% else %}all{% endif %}">
                        <td class="expand-cell">
                            <span class="expand-btn" id="expand-{{ order.order_number }}">â–¶</span>
                        </td>
                        <td class="light">
                            {% if order.status_light == 'red' %}
                                <svg class="status-light-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <circle cx="8" cy="8" r="7" fill="#EF4444" stroke="#DC2626" stroke-width="1"/>
                                </svg>
                            {% elif order.status_light == 'yellow' %}
                                <svg class="status-light-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <circle cx="8" cy="8" r="7" fill="#F59E0B" stroke="#D97706" stroke-width="1"/>
                                </svg>
                            {% elif order.current_status == STATUS.CANCELLED or (STATUS_KEYS and order.current_status == STATUS_KEYS.CANCELLED) %}
                                <svg class="status-light-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <circle cx="8" cy="8" r="7" fill="#6B7280" stroke="#4B5563" stroke-width="1"/>
                                </svg>
                            {% else %}
                                <svg class="status-light-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <circle cx="8" cy="8" r="7" fill="#22C55E" stroke="#16A34A" stroke-width="1"/>
                                </svg>
                            {% endif %}
                        </td>
                        <td class="order-date">{{ order.order_date }}</td>
                        <td class="order-no">
                            {% if order.order_number.startswith('REV-') %}
                                ğŸ¨ {{ order.order_number }}
                            {% else %}
                                #{{ order.order_number }}
                            {% endif %}
                        </td>
                        <td class="customer">{{ order.customer_name }}</td>
                        <td>{{ order.production_type or '-' }}</td>
                        <td>{{ order.product_code or '-' }}</td>
                        <td>{{ order.quantity or '-' }}</td>
                        <td>{{ order.factory or '-' }}</td>
                        <td>
                            <div class="stage-current" data-status-key="{{ order.current_status }}">
                                {% if STATUS_LABELS and order.current_status in STATUS_LABELS %}
                                    {{ STATUS_LABELS[order.current_status].zh_cn }}
                                {% else %}
                                    {{ order.current_status }}
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="days
                                {% if order.status_light == 'red' %} danger
                                {% elif order.status_light == 'yellow' %} warning
                                {% endif %}">
                                {{ order.status_days }}å¤©
                            </span>
                        </td>
                        <td class="order-notes" data-order-number="{{ order.order_number }}">
                            <div class="notes-container">
                                <button class="notes-edit-btn" 
                                        onclick="toggleNotesEdit('{{ order.order_number }}', this); event.stopPropagation();"
                                        title="ç·¨è¼¯å‚™è¨»">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <div class="notes-display">
                                    {% if order.notes and order.notes.strip() %}
                                        <span class="notes-preview" title="{{ order.notes }}">
                                            {{ order.notes[:30] }}{% if order.notes|length > 30 %}...{% endif %}
                                        </span>
                                    {% else %}
                                        <span class="notes-empty">-</span>
                                    {% endif %}
                                </div>
                                <div class="notes-edit" style="display: none;">
                                    <textarea class="notes-input" rows="2" placeholder="è¼¸å…¥å‚™è¨»...">{{ order.notes or '' }}</textarea>
                                    <div class="notes-edit-actions">
                                        <button class="notes-save-btn" onclick="saveNotes('{{ order.order_number }}', this); event.stopPropagation();">ä¿å­˜</button>
                                        <button class="notes-cancel-btn" onclick="cancelNotesEdit('{{ order.order_number }}', this); event.stopPropagation();">å–æ¶ˆ</button>
                                    </div>
                                </div>
                            </div>
                        </td>

                        {% if session.get('role') == 'admin' %}
                        <td class="actions-cell" data-order-number="{{ order.order_number }}" data-current-status="{{ order.current_status }}">
                            <div class="actions-container">
                                <div class="quick-actions">
                                    <!-- æ‚¬åœæŒ‰é’®å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆï¼ŒåŸºäº STATUS_SYSTEM.js ä¸­çš„ QUICK_ACTIONS -->
                                    <!-- é™¤äº†"å·²å®Œæˆ"ã€"å·²å–æ¶ˆ"å¤–ï¼Œæ‰€æœ‰çŠ¶æ€éƒ½ä¼šæœ‰å¯¹åº”çš„æ‚¬åœæŒ‰é’®ï¼ˆåŒ…æ‹¬"æ–°è®¢å•"ï¼‰ -->
                                </div>
                                <button type="button"
                                        class="quick-btn quick-btn-detail"
                                        onclick="openDetailDrawerFromRow(this); event.stopPropagation();">
                                    â‹¯ è¯¦æƒ…
                                </button>
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="empty-state" id="emptyState"
             style="display: none; padding: 3rem; text-align: center; color: var(--text-2);">
            <p>ğŸ“­ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®¢å•</p>
        </div>
    </div>
</div>

<!-- ====== v10 çš„æ“ä½œ / è©³æƒ… / å¤‡æ³¨ / é€€å› / å–æ¶ˆ ç­‰ Modalï¼ˆID ä¿æŒä¸ tracking.js ä¸€è‡´ï¼‰ ====== -->

<!-- Action Modal -->
<div class="modal-overlay" id="actionModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">ç¡®è®¤æ“ä½œ</div>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <span class="modal-info-text" id="modalInfo">å°‡è®¢å•å¾ "ç•¶å‰çŠ¶æ€" å˜æ›´ç‚º "ä¸‹ä¸€çŠ¶æ€"</span>
            </div>
            
            <div class="modal-label">ğŸ“ å¤‡æ³¨ï¼ˆå¯é¸ï¼‰</div>
            <textarea class="modal-textarea" id="modalNote" placeholder="è®°å½•ç›¸å…³ä¿¡æ¯..."></textarea>
            <div class="modal-hint">ğŸ’¡ å¯ä»¥è®°å½•å®¢æˆ·è¦æ±‚ã€æ³¨æ„äº‹é¡¹ç­‰</div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="modal-btn confirm" id="confirmBtn" onclick="confirmAction()">âœ“ ç¡®è®¤</button>
        </div>
    </div>
</div>

<!-- Quick Action Modal (ç”¨äºæ‚¬åœæŒ‰é’®å¿«é€Ÿæ“ä½œ) -->
<div class="modal-overlay" id="quickActionModal" onclick="if(event.target === this) closeQuickActionModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title" id="quickActionTitle">ç¡®è®¤æ“ä½œ</div>
            <button class="modal-close" onclick="closeQuickActionModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <div class="status-change" style="display: flex; align-items: center; gap: 0.5rem; justify-content: center; padding: 1rem;">
                    <span id="quickActionCurrentStatus" style="font-weight: 600; color: var(--text-1);"></span>
                    <span class="status-arrow" style="font-size: 1.2rem; color: var(--text-2);">â†’</span>
                    <span id="quickActionNextStatus" style="font-weight: 600; color: var(--blue);"></span>
                </div>
                <div style="text-align: center; font-size: 0.85rem; color: var(--text-2); margin-top: 0.5rem;">
                    è®¢å• <strong id="quickActionOrderNumber">#-</strong>
                </div>
            </div>
            
            <div class="modal-label">ğŸ“ å¤‡æ³¨ï¼ˆå¯é¸ï¼‰</div>
            <textarea class="modal-textarea" id="quickActionNote" placeholder="è®°å½•ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šå®¢æˆ·è¦æ±‚ã€æ³¨æ„äº‹é¡¹ç­‰..."></textarea>
            <div class="modal-hint">ğŸ’¡ æ—¥æœŸå°†è‡ªåŠ¨ä½¿ç”¨ä»Šå¤©ï¼š<span id="quickActionDate"></span></div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeQuickActionModal()">å–æ¶ˆ</button>
            <button class="modal-btn confirm" id="quickActionConfirmBtn" onclick="confirmQuickAction()">âœ“ ç¡®è®¤</button>
        </div>
    </div>
</div>

<!-- èˆŠçš„è®¢å•æ“ä½œé¸å–®å·²ç§»é™¤ï¼Œç¾åœ¨ä½¿ç”¨å³å´æŠ½å±œè¿›è¡Œè®¢å•ç®¡ç† -->

<!-- é€€å›æ­¥é©Ÿ Modal -->
<div class="modal-overlay" id="backStepModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">é€‰æ‹©è¦é€€å›çš„æ­¥é©Ÿ</div>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <span class="modal-info-text">ç•¶å‰çŠ¶æ€ï¼š<strong id="currentStatusText">æ ·å“å¾…ç¡®è®¤</strong></span>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <div style="font-size: 0.8rem; color: var(--text-3); margin-bottom: 0.75rem;">é€‰æ‹©è¦é€€å›åˆ°çš„æ­¥é©Ÿï¼š</div>
                
                <label class="back-step-option">
                    <input type="radio" name="backStep" value="æ‰“æ ·ä¸­">
                    <div class="back-step-info">
                        <div class="back-step-name">æ‰“æ ·ä¸­</div>
                        <div class="back-step-desc">é‡æ–°åˆ¶ä½œæ ·å“</div>
                    </div>
                </label>
                
                <label class="back-step-option">
                    <input type="radio" name="backStep" value="å¾…æ‰“æ ·">
                    <div class="back-step-info">
                        <div class="back-step-name">å‡†å¤‡æ‰“æ ·</div>
                        <div class="back-step-desc">é‡æ–°å‡†å¤‡æ‰“æ ·</div>
                    </div>
                </label>
                
                <label class="back-step-option">
                    <input type="radio" name="backStep" value="å›¾ç¨¿åˆ¶ä½œä¸­">
                    <div class="back-step-info">
                        <div class="back-step-name">å›¾ç¨¿åˆ¶ä½œä¸­</div>
                        <div class="back-step-desc">é‡æ–°åˆ¶ä½œå›¾ç¨¿</div>
                    </div>
                </label>
            </div>
            
            <div class="modal-label">ğŸ“ é€€å›åŸå› ï¼ˆå»ºè®®å¡«å†™ï¼‰</div>
            <textarea class="modal-textarea" id="backStepNote" placeholder="èªªæ˜ç‚ºä»€éº¼è¦é€€å›..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal()">â† è¿”å›</button>
            <button class="modal-btn confirm" onclick="confirmBackStep()">âœ“ ç¡®è®¤é€€å›</button>
        </div>
    </div>
</div>

<!-- å¤‡æ³¨ Modal -->
<div class="modal-overlay" id="noteModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">æ·»åŠ å¤‡æ³¨</div>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <span class="modal-info-text">è®¢å• <strong id="noteOrderId">#-</strong></span>
            </div>
            
            <div class="modal-label">ğŸ“ å¤‡æ³¨å…§å®¹</div>
            <textarea class="modal-textarea" id="noteText" placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."></textarea>
            <div class="modal-hint">ğŸ’¡ å¤‡æ³¨ä¼šé¡¯ç¤ºåœ¨æ™‚é–“è»¸ä¸Š</div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal()">â† è¿”å›</button>
            <button class="modal-btn confirm" onclick="confirmAddNote()">âœ“ æ·»åŠ </button>
        </div>
    </div>
</div>

<!-- è¨­å®šäº¤è´§æ—¥æœŸ Modal -->
<div class="modal-overlay" id="deliveryDateModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">è¨­å®šäº¤è´§æ—¥æœŸ</div>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <span class="modal-info-text">è®¢å• <strong id="deliveryOrderId">#-</strong></span>
            </div>
            
            <div class="modal-label">ğŸ“… é¢„è®¡äº¤è´§æ—¥æœŸ</div>
            <input type="date" class="modal-textarea" id="deliveryDate" style="min-height: auto; padding: 0.75rem;">
            <div class="modal-hint">ğŸ’¡ å¯ä»¥éš¨æ™‚ä¿®æ”¹</div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal()">â† è¿”å›</button>
            <button class="modal-btn confirm" onclick="confirmDeliveryDate()">âœ“ è¨­å®š</button>
        </div>
    </div>
</div>

<!-- è·³éæ‰“æ · Modal -->
<div class="modal-overlay" id="skipSamplingModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">âš ï¸ ç¡®è®¤è·³éæ‰“æ ·é˜¶æ®µ</div>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <div style="color: var(--text-2);">
                    å°‡ç›´æ¥å¾ <strong>å›¾ç¨¿å¾…ç¡®è®¤</strong> è¿›å…¥
                    <strong style="color: var(--blue);">å¾…ç”Ÿäº§</strong>
                </div>
            </div>
            
            <div class="modal-label">ğŸ“ è·³è¿‡åŸå› ï¼ˆå¯é€‰ï¼‰</div>
            <textarea class="modal-textarea" id="skipReason" placeholder="ä¾‹å¦‚ï¼šè€å®¢æˆ·é‡è¤‡è®¢å•..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal()">â† è¿”å›</button>
            <button class="modal-btn confirm" onclick="confirmSkipSampling()">âœ“ ç¡®è®¤è·³é</button>
        </div>
    </div>
</div>

<!-- å–æ¶ˆè®¢å• Modal -->
<div class="modal-overlay" id="cancelOrderModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">âš ï¸ ç¡®è®¤å–æ¶ˆè®¢å•</div>
        </div>
        <div class="modal-body">
            <div class="modal-info" style="background: var(--red-bg); border-left: 3px solid var(--red);">
                <span style="color: var(--red); font-weight: 600;">æ­¤æ“ä½œä¸å¯æ¢å¾©ï¼</span>
            </div>
            
            <div class="modal-label">ğŸ“ å–æ¶ˆåŸå› ï¼ˆå¿…å¡«ï¼‰</div>
            <textarea class="modal-textarea" id="cancelReason" placeholder="è¯·èªªæ˜å–æ¶ˆåŸå› ..." required></textarea>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal()">â† è¿”å›</button>
            <button class="modal-btn danger" onclick="confirmCancelOrder()">âŒ ç¡®è®¤å–æ¶ˆè®¢å•</button>
        </div>
    </div>
</div>


{% endblock %}