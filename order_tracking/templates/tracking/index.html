{% extends "base.html" %}

{% block title %}è¨‚å–®æµç¨‹è¿½è¹¤ç³»çµ±{% endblock %}

{% block content %}

{# ====== æ ¹æ“šå¾Œç«¯è³‡æ–™å…ˆç®—å¥½å„é¡çµ±è¨ˆï¼Œæ–¹ä¾¿å¥—é€² v10 ç‰ˆé¢ ====== #}
{% set active_orders = all_orders
    | rejectattr('current_status', 'in', ['å·²å®Œæˆ', 'å·²å–æ¶ˆ'])
    | list %}
{% set completed_orders = all_orders
    | selectattr('current_status', 'equalto', 'å·²å®Œæˆ')
    | list %}
{% set cancelled_orders = all_orders
    | selectattr('current_status', 'equalto', 'å·²å–æ¶ˆ')
    | list %}

{% set draft_statuses = ['æ–°è¨‚å–®', 'åœ–ç¨¿ç¢ºèªä¸­', 'åœ–ç¨¿ä¿®æ”¹ä¸­'] %}
{% set sampling_statuses = ['å¾…æ‰“æ¨£', 'æ‰“æ¨£ä¸­', 'æ‰“æ¨£ç¢ºèªä¸­', 'æ‰“æ¨£ä¿®æ”¹ä¸­'] %}
{% set production_statuses = ['å¾…ç”Ÿç”¢', 'ç”Ÿç”¢ä¸­'] %}

{% set draft_orders = all_orders | selectattr('current_status', 'in', draft_statuses) | list %}
{% set sampling_orders = all_orders | selectattr('current_status', 'in', sampling_statuses) | list %}
{% set production_orders = all_orders | selectattr('current_status', 'in', production_statuses) | list %}
{% set quote_orders = all_orders | selectattr('current_status', 'equalto', 'è©¢åƒ¹ä¸­') | list %}

<div class="container">
    <!-- ====== çµ±è¨ˆå€ï¼ˆç‰ˆé¢åŒ v10ï¼‰ ====== -->
    <div class="stats">
        <div class="stat">
            <div class="stat-icon">ğŸ“¦</div>
            <div>
                <div class="stat-label">é€²è¡Œä¸­</div>
                <div class="stat-value" id="totalOrders">{{ active_orders|length }}</div>
            </div>
        </div>
        
        <div class="stat red">
            <div class="stat-icon">ğŸ”´</div>
            <div>
                <div class="stat-label">é€¾æœŸ</div>
                <div class="stat-value" id="redOrders">{{ light_stats.get('red', 0) }}</div>
            </div>
        </div>

        <div class="stat yellow">
            <div class="stat-icon">ğŸŸ¡</div>
            <div>
                <div class="stat-label">éœ€æ³¨æ„</div>
                <div class="stat-value" id="yellowOrders">{{ light_stats.get('yellow', 0) }}</div>
            </div>
        </div>
        
        <div class="stat green">
            <div class="stat-icon">âœ…</div>
            <div>
                <div class="stat-label">æ­£å¸¸ï¼ˆç¶ ç‡ˆï¼‰</div>
                <div class="stat-value" id="greenOrders">{{ light_stats.get('green', 0) }}</div>
            </div>
        </div>
    </div>
    
    <!-- ====== æµç¨‹éšæ®µç¯©é¸åˆ—ï¼ˆç‰ˆé¢åŒ v10ï¼‰ ====== -->
    <div class="stage-filters">
        <button class="stage-btn active" onclick="filterByStageGroup('all', this)">
            ğŸ“‹ å…¨éƒ¨
            <span class="stage-count">{{ active_orders|length }}</span>
        </button>
        
        <!-- åœ–ç¨¿éšæ®µ -->
        <div class="stage-filter">
            <button class="stage-btn" onclick="toggleSubstatus('draft', this)">
                ğŸ“„ åœ–ç¨¿éšæ®µ
                <span class="stage-count" id="draftCount">{{ draft_orders|length }}</span>
                <span style="font-size: 0.7rem;">â–¼</span>
            </button>
            <div class="substatus-dropdown" id="dropdown-draft">
                <div class="substatus-label">åœ–ç¨¿å°ç‹€æ…‹</div>
                <div class="substatus-option active" onclick="filterBySubstatus('draft', 'all', this)">
                    <span>å…¨éƒ¨</span>
                    <span class="count" id="draft-all-count">{{ draft_orders|length }}</span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('draft', 'æ–°è¨‚å–®', this)">
                    <span>æ–°è¨‚å–®</span>
                    <span class="count" id="draft-new-count">
                        {{ all_orders | selectattr('current_status','equalto','æ–°è¨‚å–®') | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('draft', 'åœ–ç¨¿ç¢ºèªä¸­', this)">
                    <span>åœ–ç¨¿ç¢ºèªä¸­</span>
                    <span class="count" id="draft-confirm-count">
                        {{ all_orders | selectattr('current_status','equalto','åœ–ç¨¿ç¢ºèªä¸­') | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('draft', 'åœ–ç¨¿ä¿®æ”¹ä¸­', this)">
                    <span>åœ–ç¨¿ä¿®æ”¹ä¸­</span>
                    <span class="count" id="draft-revise-count">
                        {{ all_orders | selectattr('current_status','equalto','åœ–ç¨¿ä¿®æ”¹ä¸­') | list | length }}
                    </span>
                </div>
            </div>
        </div>

        <!-- æ‰“æ¨£éšæ®µ -->
        <div class="stage-filter">
            <button class="stage-btn" onclick="toggleSubstatus('sampling', this)">
                ğŸ§ª æ‰“æ¨£éšæ®µ
                <span class="stage-count" id="samplingCount">{{ sampling_orders|length }}</span>
                <span style="font-size: 0.7rem;">â–¼</span>
            </button>
            <div class="substatus-dropdown" id="dropdown-sampling">
                <div class="substatus-label">æ‰“æ¨£å°ç‹€æ…‹</div>
                <div class="substatus-option active" onclick="filterBySubstatus('sampling', 'all', this)">
                    <span>å…¨éƒ¨</span>
                    <span class="count" id="sampling-all-count">{{ sampling_orders|length }}</span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('sampling', 'å¾…æ‰“æ¨£', this)">
                    <span>å¾…æ‰“æ¨£</span>
                    <span class="count" id="sampling-pending-count">
                        {{ all_orders | selectattr('current_status','equalto','å¾…æ‰“æ¨£') | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('sampling', 'æ‰“æ¨£ä¸­', this)">
                    <span>æ‰“æ¨£ä¸­</span>
                    <span class="count" id="sampling-making-count">
                        {{ all_orders | selectattr('current_status','equalto','æ‰“æ¨£ä¸­') | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('sampling', 'æ‰“æ¨£ç¢ºèªä¸­', this)">
                    <span>æ‰“æ¨£ç¢ºèªä¸­</span>
                    <span class="count" id="sampling-confirm-count">
                        {{ all_orders | selectattr('current_status','equalto','æ‰“æ¨£ç¢ºèªä¸­') | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('sampling', 'æ‰“æ¨£ä¿®æ”¹ä¸­', this)">
                    <span>æ‰“æ¨£ä¿®æ”¹ä¸­</span>
                    <span class="count" id="sampling-revise-count">
                        {{ all_orders | selectattr('current_status','equalto','æ‰“æ¨£ä¿®æ”¹ä¸­') | list | length }}
                    </span>
                </div>
            </div>
        </div>

        <!-- ç”Ÿç”¢éšæ®µ -->
        <div class="stage-filter">
            <button class="stage-btn" onclick="toggleSubstatus('production', this)">
                ğŸ­ ç”Ÿç”¢éšæ®µ
                <span class="stage-count" id="productionCount">{{ production_orders|length }}</span>
                <span style="font-size: 0.7rem;">â–¼</span>
            </button>
            <div class="substatus-dropdown" id="dropdown-production">
                <div class="substatus-label">ç”Ÿç”¢å°ç‹€æ…‹</div>
                <div class="substatus-option active" onclick="filterBySubstatus('production', 'all', this)">
                    <span>å…¨éƒ¨</span>
                    <span class="count" id="production-all-count">{{ production_orders|length }}</span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('production', 'å¾…ç”Ÿç”¢', this)">
                    <span>å¾…ç”Ÿç”¢</span>
                    <span class="count" id="production-pending-count">
                        {{ all_orders | selectattr('current_status','equalto','å¾…ç”Ÿç”¢') | list | length }}
                    </span>
                </div>
                <div class="substatus-option" onclick="filterBySubstatus('production', 'ç”Ÿç”¢ä¸­', this)">
                    <span>ç”Ÿç”¢ä¸­</span>
                    <span class="count" id="production-making-count">
                        {{ all_orders | selectattr('current_status','equalto','ç”Ÿç”¢ä¸­') | list | length }}
                    </span>
                </div>
            </div>
        </div>

        <!-- è©¢åƒ¹ / ç­‰åœ‹å¤–ç¢ºèª -->
        <button class="stage-btn pending" onclick="filterByStageGroup('quote', this)">
            â³ ç­‰åœ‹å¤–ç¢ºèª / è©¢åƒ¹
            <span class="stage-count" id="quoteCount">{{ quote_orders|length }}</span>
        </button>
        
        <!-- Divider -->
        <div style="width: 1px; height: 30px; background: var(--border); margin: 0 0.5rem;"></div>
        
        <!-- å·²å®Œæˆ / å·²å–æ¶ˆ Checkbox -->
        <label class="filter-checkbox">
            <input type="checkbox" id="toggleCompleted" checked
                   onchange="toggleCompletedOrders(this)">
            <span>é¡¯ç¤ºå·²å®Œæˆ (<span id="completedCount">{{ completed_orders|length }}</span>)</span>
        </label>
        
        <label class="filter-checkbox">
            <input type="checkbox" id="toggleCancelled"
                   onchange="toggleCancelledOrders(this)">
            <span>é¡¯ç¤ºå·²å–æ¶ˆ (<span id="cancelledCount">{{ cancelled_orders|length }}</span>)</span>
        </label>
        
        {% if session.get('role') == 'admin' %}
        <div style="margin-left: auto; display: flex; align-items: center; gap: 1rem;">
            <div class="search-box">
                <span>ğŸ”</span>
                <input type="text" id="searchInput" placeholder="æœå°‹è¨‚å–®è™Ÿã€å®¢æˆ¶åç¨±..." value="">
            </div>
            <button class="btn btn-secondary" onclick="exportData()">ğŸ“¤ åŒ¯å‡º</button>
        </div>
        {% else %}
        <div style="margin-left: auto;">
            <div class="search-box">
                <span>ğŸ”</span>
                <input type="text" id="searchInput" placeholder="æœå°‹è¨‚å–®è™Ÿã€å®¢æˆ¶åç¨±..." value="">
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ====== è¨‚å–®è¡¨æ ¼ï¼ˆè¡¨é ­é¢¨æ ¼åŒ v10ï¼›è³‡æ–™ä¾†è‡ªå¾Œç«¯ï¼‰ ====== -->
    <div class="table-wrapper">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th></th>
                        <th>è¨‚å–®æ—¥æœŸ</th>
                        <th>è¨‚å–®è™Ÿ</th>
                        <th>å®¢æˆ¶åç¨±</th>
                        <th>ç”¢å“ç·¨è™Ÿ</th>
                        <th>æ•¸é‡</th>
                        <th>ç”Ÿç”¢å·¥å» </th>
                        <th>éšæ®µ / ç‹€æ…‹</th>
                        <th>ç­‰å¾…å¤©æ•¸</th>
                        <th>ç”¢å“é¡å‹</th>
                        <th>å‚™è¨»</th>
                        {% if session.get('role') == 'admin' %}
                        <th>æ“ä½œ</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    {% for order in all_orders %}
                    <tr class="{{ order.status_light }}"
                        onclick="toggleDetail('{{ order.order_number }}', event)"
                        data-order-number="{{ order.order_number }}"
                        data-customer-name="{{ order.customer_name }}"
                        data-status="{{ order.current_status }}"
                        data-light="{{ order.status_light }}"
                        data-stage-group="{% if order.current_status in draft_statuses %}draft{% elif order.current_status in sampling_statuses %}sampling{% elif order.current_status in production_statuses %}production{% elif order.current_status == 'è©¢åƒ¹ä¸­' or order.order_number.startswith('REV-') %}quote{% elif order.current_status == 'å·²å®Œæˆ' %}completed{% elif order.current_status == 'å·²å–æ¶ˆ' %}cancelled{% else %}all{% endif %}">
                        <td class="expand-cell">
                            <span class="expand-btn" id="expand-{{ order.order_number }}">â–¶</span>
                        </td>
                        <td class="light">
                            {% if order.status_light == 'red' %}
                                ğŸ”´
                            {% elif order.status_light == 'yellow' %}
                                ğŸŸ¡
                            {% elif order.current_status == 'å·²å–æ¶ˆ' %}
                                âš«
                            {% else %}
                                ğŸŸ¢
                            {% endif %}
                        </td>
                        <td class="order-date">{{ order.order_date }}</td>
                        <td class="order-no">
                            {% if order.order_number.startswith('REV-') %}
                                ğŸ¨ {{ order.order_number }}
                            {% else %}
                                #{{ order.order_number }}
                            {% endif %}
                        </td>
                        <td class="customer">{{ order.customer_name }}</td>
                        <td>{{ order.product_code or '-' }}</td>
                        <td>{{ order.quantity or '-' }}</td>
                        <td>{{ order.production_type or '-' }}</td>
                        <td>
                            <div class="stage-info">
                                <div class="stage-major">
                                    {% if order.current_status in draft_statuses %}
                                        ğŸ“„ åœ–ç¨¿éšæ®µ
                                    {% elif order.current_status in sampling_statuses %}
                                        ğŸ§ª æ‰“æ¨£éšæ®µ
                                    {% elif order.current_status in production_statuses %}
                                        ğŸ­ ç”Ÿç”¢éšæ®µ
                                    {% elif order.current_status == 'å·²å®Œæˆ' %}
                                        âœ… å·²å®Œæˆ
                                    {% elif order.current_status == 'å·²å–æ¶ˆ' %}
                                        âŒ å·²å–æ¶ˆ
                                    {% else %}
                                        ğŸ“‹ å…¶ä»–
                                    {% endif %}
                                </div>
                                <div class="stage-current">{{ order.current_status }}</div>
                            </div>
                        </td>
                        <td>
                            <span class="days
                                {% if order.status_light == 'red' %} danger
                                {% elif order.status_light == 'yellow' %} warning
                                {% endif %}">
                                {{ order.status_days }}å¤©
                            </span>
                        </td>
                        <td>{{ order.product_name or '-' }}</td>
                        <td>{{ order.notes or '-' }}</td>

                        {% if session.get('role') == 'admin' %}
                        <td class="actions-cell">
                            <div class="actions-container">
                                <div class="quick-actions">
                                    {% set current = order.current_status %}

                                    {% if current == 'è©¢åƒ¹ä¸­' %}
                                    <button class="quick-btn quick-btn-confirm"
                                            data-order="{{ order.order_number }}"
                                            data-action="quote_complete"
                                            data-current="è©¢åƒ¹ä¸­"
                                            data-next="å·²å®Œæˆ"
                                            onclick="handleQuickUpdate(event, this)">
                                        âœ… å®Œæˆ
                                    </button>
                                    <button class="quick-btn quick-btn-cancel"
                                            data-order="{{ order.order_number }}"
                                            data-action="cancel"
                                            data-current="è©¢åƒ¹ä¸­"
                                            data-next="å·²å–æ¶ˆ"
                                            onclick="handleQuickUpdate(event, this)">
                                        âŒ å–æ¶ˆ
                                    </button>

                                    {% elif current == 'æ–°è¨‚å–®' %}
                                    <button class="quick-btn quick-btn-confirm"
                                            data-order="{{ order.order_number }}"
                                            data-action="draft_sent"
                                            data-current="æ–°è¨‚å–®"
                                            data-next="åœ–ç¨¿ç¢ºèªä¸­"
                                            onclick="handleQuickUpdate(event, this)">
                                        âœ… å·²ç™¼åœ–ç¨¿
                                    </button>
                                    <button class="quick-btn quick-btn-cancel"
                                            data-order="{{ order.order_number }}"
                                            data-action="cancel"
                                            data-current="æ–°è¨‚å–®"
                                            data-next="å·²å–æ¶ˆ"
                                            onclick="handleQuickUpdate(event, this)">
                                        âŒ å–æ¶ˆ
                                    </button>

                                    {% elif current == 'åœ–ç¨¿ç¢ºèªä¸­' %}
                                    <button class="quick-btn quick-btn-confirm"
                                            data-order="{{ order.order_number }}"
                                            data-action="draft_confirm"
                                            data-current="åœ–ç¨¿ç¢ºèªä¸­"
                                            data-next="å¾…æ‰“æ¨£"
                                            onclick="handleQuickUpdate(event, this)">
                                        âœ… å·²ç¢ºèª
                                    </button>
                                    <button class="quick-btn quick-btn-revise"
                                            data-order="{{ order.order_number }}"
                                            data-action="draft_revise"
                                            data-current="åœ–ç¨¿ç¢ºèªä¸­"
                                            data-next="åœ–ç¨¿ä¿®æ”¹ä¸­"
                                            onclick="handleQuickUpdate(event, this)">
                                        ğŸ”„ éœ€ä¿®æ”¹
                                    </button>

                                    {% elif current == 'åœ–ç¨¿ä¿®æ”¹ä¸­' %}
                                    <button class="quick-btn quick-btn-confirm"
                                            data-order="{{ order.order_number }}"
                                            data-action="draft_modified"
                                            data-current="åœ–ç¨¿ä¿®æ”¹ä¸­"
                                            data-next="åœ–ç¨¿ç¢ºèªä¸­"
                                            onclick="handleQuickUpdate(event, this)">
                                        âœ… ä¿®æ”¹å®Œæˆ
                                    </button>

                                    {% elif current == 'å¾…æ‰“æ¨£' %}
                                    <button class="quick-btn quick-btn-confirm"
                                            data-order="{{ order.order_number }}"
                                            data-action="sample_start"
                                            data-current="å¾…æ‰“æ¨£"
                                            data-next="æ‰“æ¨£ä¸­"
                                            onclick="handleQuickUpdate(event, this)">
                                        âœ… é–‹å§‹æ‰“æ¨£
                                    </button>

                                    {% elif current == 'æ‰“æ¨£ä¸­' %}
                                    <button class="quick-btn quick-btn-confirm"
                                            data-order="{{ order.order_number }}"
                                            data-action="sample_done"
                                            data-current="æ‰“æ¨£ä¸­"
                                            data-next="æ‰“æ¨£ç¢ºèªä¸­"
                                            onclick="handleQuickUpdate(event, this)">
                                        âœ… æ‰“æ¨£å®Œæˆ
                                    </button>

                                    {% elif current == 'æ‰“æ¨£ç¢ºèªä¸­' %}
                                    <button class="quick-btn quick-btn-confirm"
                                            data-order="{{ order.order_number }}"
                                            data-action="sample_confirm"
                                            data-current="æ‰“æ¨£ç¢ºèªä¸­"
                                            data-next="å¾…ç”Ÿç”¢"
                                            onclick="handleQuickUpdate(event, this)">
                                        âœ… å·²ç¢ºèª
                                    </button>
                                    <button class="quick-btn quick-btn-revise"
                                            data-order="{{ order.order_number }}"
                                            data-action="sample_revise"
                                            data-current="æ‰“æ¨£ç¢ºèªä¸­"
                                            data-next="æ‰“æ¨£ä¿®æ”¹ä¸­"
                                            onclick="handleQuickUpdate(event, this)">
                                        ğŸ”„ éœ€é‡åš
                                    </button>

                                    {% elif current == 'æ‰“æ¨£ä¿®æ”¹ä¸­' %}
                                    <button class="quick-btn quick-btn-confirm"
                                            data-order="{{ order.order_number }}"
                                            data-action="sample_modified"
                                            data-current="æ‰“æ¨£ä¿®æ”¹ä¸­"
                                            data-next="æ‰“æ¨£ç¢ºèªä¸­"
                                            onclick="handleQuickUpdate(event, this)">
                                        âœ… é‡åšå®Œæˆ
                                    </button>

                                    {% elif current == 'å¾…ç”Ÿç”¢' %}
                                    <button class="quick-btn quick-btn-confirm"
                                            data-order="{{ order.order_number }}"
                                            data-action="production_start"
                                            data-current="å¾…ç”Ÿç”¢"
                                            data-next="ç”Ÿç”¢ä¸­"
                                            onclick="handleQuickUpdate(event, this)">
                                        âœ… é–‹å§‹ç”Ÿç”¢
                                    </button>

                                    {% elif current == 'ç”Ÿç”¢ä¸­' %}
                                    <button class="quick-btn quick-btn-confirm"
                                            data-order="{{ order.order_number }}"
                                            data-action="complete"
                                            data-current="ç”Ÿç”¢ä¸­"
                                            data-next="å·²å®Œæˆ"
                                            onclick="handleQuickUpdate(event, this)">
                                        âœ… ç”Ÿç”¢å®Œæˆ
                                    </button>
                                    {% endif %}

                                    <button type="button"
                                            class="quick-btn quick-btn-detail"
                                            onclick="showDetailsMenu('#{{ order.order_number }}')">
                                        â‹¯ è©³æƒ…
                                    </button>
                                </div>
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="empty-state" id="emptyState"
             style="display: none; padding: 3rem; text-align: center; color: var(--text-2);">
            <p>ğŸ“­ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</p>
        </div>
    </div>
</div>

<!-- ====== v10 çš„æ“ä½œ / è©³æƒ… / å‚™è¨» / é€€å› / å–æ¶ˆ ç­‰ Modalï¼ˆID ä¿æŒèˆ‡ tracking.js ä¸€è‡´ï¼‰ ====== -->

<!-- Action Modal -->
<div class="modal-overlay" id="actionModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">ç¢ºèªæ“ä½œ</div>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <span class="modal-info-text" id="modalInfo">å°‡è¨‚å–®å¾ "ç•¶å‰ç‹€æ…‹" è®Šæ›´ç‚º "ä¸‹ä¸€ç‹€æ…‹"</span>
            </div>
            
            <div class="modal-label">ğŸ“ å‚™è¨»ï¼ˆå¯é¸ï¼‰</div>
            <textarea class="modal-textarea" id="modalNote" placeholder="è¨˜éŒ„ç›¸é—œä¿¡æ¯..."></textarea>
            <div class="modal-hint">ğŸ’¡ å¯ä»¥è¨˜éŒ„å®¢æˆ¶è¦æ±‚ã€æ³¨æ„äº‹é …ç­‰</div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="modal-btn confirm" id="confirmBtn" onclick="confirmAction()">âœ“ ç¢ºèª</button>
        </div>
    </div>
</div>

<!-- è¨‚å–®æ“ä½œé¸å–® Modal -->
<div class="modal-overlay" id="detailsModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">è¨‚å–®æ“ä½œé¸å–®</div>
        </div>
        <div class="modal-body">
            <div class="menu-option" onclick="showNoteModal()">
                <div class="menu-icon">ğŸ“</div>
                <div class="menu-text">
                    <div class="menu-label">æ·»åŠ å‚™è¨»</div>
                    <div class="menu-desc">è¨˜éŒ„ç›¸é—œä¿¡æ¯</div>
                </div>
            </div>
            
            <div class="menu-option" onclick="showDeliveryDateModal()">
                <div class="menu-icon">ğŸ“…</div>
                <div class="menu-text">
                    <div class="menu-label">è¨­å®šäº¤è²¨æ—¥æœŸ</div>
                    <div class="menu-desc">è¨­å®šæˆ–ä¿®æ”¹é è¨ˆäº¤è²¨æ™‚é–“</div>
                </div>
            </div>
            
            <div class="menu-option" id="skipSamplingOption" style="display:none;" onclick="showSkipSamplingModal()">
                <div class="menu-icon">âš¡</div>
                <div class="menu-text">
                    <div class="menu-label">è·³éæ‰“æ¨£ï¼Œç›´é€šç”Ÿç”¢</div>
                    <div class="menu-desc">é©åˆè€å®¢æˆ¶é‡è¤‡è¨‚å–®</div>
                </div>
            </div>
            
            <div class="menu-option" onclick="showBackStepModal()">
                <div class="menu-icon">ğŸ”„</div>
                <div class="menu-text">
                    <div class="menu-label">é€€å›åˆ°ä¹‹å‰æ­¥é©Ÿ</div>
                    <div class="menu-desc">é¸æ“‡è¦é€€å›çš„ç‹€æ…‹</div>
                </div>
            </div>
            
            <div class="menu-option danger" onclick="showCancelOrderModal()">
                <div class="menu-icon">âŒ</div>
                <div class="menu-text">
                    <div class="menu-label">å–æ¶ˆè¨‚å–®</div>
                    <div class="menu-desc">çµ‚æ­¢æ­¤è¨‚å–®</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal()">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- é€€å›æ­¥é©Ÿ Modal -->
<div class="modal-overlay" id="backStepModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">é¸æ“‡è¦é€€å›çš„æ­¥é©Ÿ</div>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <span class="modal-info-text">ç•¶å‰ç‹€æ…‹ï¼š<strong id="currentStatusText">æ¨£å“å¾…ç¢ºèª</strong></span>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <div style="font-size: 0.8rem; color: var(--text-3); margin-bottom: 0.75rem;">é¸æ“‡è¦é€€å›åˆ°çš„æ­¥é©Ÿï¼š</div>
                
                <label class="back-step-option">
                    <input type="radio" name="backStep" value="æ‰“æ¨£è£½ä½œä¸­">
                    <div class="back-step-info">
                        <div class="back-step-name">æ‰“æ¨£è£½ä½œä¸­</div>
                        <div class="back-step-desc">é‡æ–°è£½ä½œæ¨£å“</div>
                    </div>
                </label>
                
                <label class="back-step-option">
                    <input type="radio" name="backStep" value="æº–å‚™æ‰“æ¨£">
                    <div class="back-step-info">
                        <div class="back-step-name">æº–å‚™æ‰“æ¨£</div>
                        <div class="back-step-desc">é‡æ–°æº–å‚™æ‰“æ¨£</div>
                    </div>
                </label>
                
                <label class="back-step-option">
                    <input type="radio" name="backStep" value="åœ–ç¨¿å¾…ç¢ºèª">
                    <div class="back-step-info">
                        <div class="back-step-name">åœ–ç¨¿å¾…ç¢ºèª</div>
                        <div class="back-step-desc">éœ€è¦é‡æ–°åšåœ–</div>
                    </div>
                </label>
            </div>
            
            <div class="modal-label">ğŸ“ é€€å›åŸå› ï¼ˆå»ºè­°å¡«å¯«ï¼‰</div>
            <textarea class="modal-textarea" id="backStepNote" placeholder="èªªæ˜ç‚ºä»€éº¼è¦é€€å›..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="backToDetailsMenu()">â† è¿”å›</button>
            <button class="modal-btn confirm" onclick="confirmBackStep()">âœ“ ç¢ºèªé€€å›</button>
        </div>
    </div>
</div>

<!-- å‚™è¨» Modal -->
<div class="modal-overlay" id="noteModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">æ·»åŠ å‚™è¨»</div>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <span class="modal-info-text">è¨‚å–® <strong id="noteOrderId">#-</strong></span>
            </div>
            
            <div class="modal-label">ğŸ“ å‚™è¨»å…§å®¹</div>
            <textarea class="modal-textarea" id="noteText" placeholder="è¼¸å…¥å‚™è¨»ä¿¡æ¯..."></textarea>
            <div class="modal-hint">ğŸ’¡ å‚™è¨»æœƒé¡¯ç¤ºåœ¨æ™‚é–“è»¸ä¸Š</div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="backToDetailsMenu()">â† è¿”å›</button>
            <button class="modal-btn confirm" onclick="confirmAddNote()">âœ“ æ·»åŠ </button>
        </div>
    </div>
</div>

<!-- è¨­å®šäº¤è²¨æ—¥æœŸ Modal -->
<div class="modal-overlay" id="deliveryDateModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">è¨­å®šäº¤è²¨æ—¥æœŸ</div>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <span class="modal-info-text">è¨‚å–® <strong id="deliveryOrderId">#-</strong></span>
            </div>
            
            <div class="modal-label">ğŸ“… é è¨ˆäº¤è²¨æ—¥æœŸ</div>
            <input type="date" class="modal-textarea" id="deliveryDate" style="min-height: auto; padding: 0.75rem;">
            <div class="modal-hint">ğŸ’¡ å¯ä»¥éš¨æ™‚ä¿®æ”¹</div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="backToDetailsMenu()">â† è¿”å›</button>
            <button class="modal-btn confirm" onclick="confirmDeliveryDate()">âœ“ è¨­å®š</button>
        </div>
    </div>
</div>

<!-- è·³éæ‰“æ¨£ Modal -->
<div class="modal-overlay" id="skipSamplingModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">âš ï¸ ç¢ºèªè·³éæ‰“æ¨£éšæ®µ</div>
        </div>
        <div class="modal-body">
            <div class="modal-info">
                <div style="color: var(--text-2);">
                    å°‡ç›´æ¥å¾ <strong>åœ–ç¨¿å¾…ç¢ºèª</strong> é€²å…¥
                    <strong style="color: var(--blue);">æº–å‚™ç”Ÿç”¢</strong>
                </div>
            </div>
            
            <div class="modal-label">ğŸ“ è·³éåŸå› ï¼ˆå¯é¸ï¼‰</div>
            <textarea class="modal-textarea" id="skipReason" placeholder="ä¾‹å¦‚ï¼šè€å®¢æˆ¶é‡è¤‡è¨‚å–®..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="backToDetailsMenu()">â† è¿”å›</button>
            <button class="modal-btn confirm" onclick="confirmSkipSampling()">âœ“ ç¢ºèªè·³é</button>
        </div>
    </div>
</div>

<!-- å–æ¶ˆè¨‚å–® Modal -->
<div class="modal-overlay" id="cancelOrderModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">âš ï¸ ç¢ºèªå–æ¶ˆè¨‚å–®</div>
        </div>
        <div class="modal-body">
            <div class="modal-info" style="background: var(--red-bg); border-left: 3px solid var(--red);">
                <span style="color: var(--red); font-weight: 600;">æ­¤æ“ä½œä¸å¯æ¢å¾©ï¼</span>
            </div>
            
            <div class="modal-label">ğŸ“ å–æ¶ˆåŸå› ï¼ˆå¿…å¡«ï¼‰</div>
            <textarea class="modal-textarea" id="cancelReason" placeholder="è«‹èªªæ˜å–æ¶ˆåŸå› ..." required></textarea>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="backToDetailsMenu()">â† è¿”å›</button>
            <button class="modal-btn danger" onclick="confirmCancelOrder()">âŒ ç¢ºèªå–æ¶ˆè¨‚å–®</button>
        </div>
    </div>
</div>

<!-- ====== æ–°å¢è¨‚å–® / å¿«é€Ÿæ›´æ–° Modalï¼šä¿ç•™åŸæœ‰åŠŸèƒ½ï¼Œèˆ‡ v10 ç‰ˆé¢ç›¸å®¹ ====== -->

<!-- æ–°å¢è¨‚å–® Modal -->
<div class="modal-overlay" id="newOrderModal">
    <div class="modal modal-center new-order-modal">
        <div class="modal-header">
            <div class="modal-title">â• æ–°å¢è¨‚å–®/è©¢åƒ¹</div>
            <button class="modal-close" onclick="closeNewOrderModal()">âœ•</button>
        </div>
        
        <div class="progress-steps">
            <div class="progress-step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">åŸºæœ¬ä¿¡æ¯</div>
            </div>
            <div class="progress-step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">ç”¢å“è©³æƒ…</div>
            </div>
            <div class="progress-step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">ç”Ÿç”¢è¨­ç½®</div>
            </div>
            <div class="progress-step" data-step="4">
                <div class="step-circle">4</div>
                <div class="step-label">ç¢ºèªæäº¤</div>
            </div>
        </div>
        
        <div class="modal-body">
            <form id="newOrderForm" onsubmit="event.preventDefault(); submitNewOrder();">
                <!-- Step 1 -->
                <div class="form-step active" data-step="1">
                    <div class="step-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                è¨‚å–®æ—¥æœŸ <span class="required">*</span>
                            </label>
                            <input type="date" name="order_date" id="newOrderDate" class="form-input" required>
                            <span class="form-error">è«‹é¸æ“‡è¨‚å–®æ—¥æœŸ</span>
                        </div>

                        <div class="form-group" style="position: relative;">
                            <label class="form-label">
                                è¨‚å–®è™Ÿ
                            </label>
                            <input type="text" name="order_number" id="newOrderNumber" class="form-input"
                                   placeholder="ç•™ç©ºå‰‡å‰µå»ºè©¢åƒ¹/ä¿®åœ–éœ€æ±‚ï¼ˆè‡ªå‹•ç”ŸæˆYUç·¨è™Ÿï¼‰"
                                   onblur="checkOrderNumber()">
                            <span class="form-hint">ğŸ’¡ ä¸å¡«è¨‚å–®è™Ÿå°‡å‰µå»ºè©¢åƒ¹/ä¿®åœ–éœ€æ±‚</span>
                            <span id="orderNumberError" class="form-error" style="display: none;"></span>
                        </div>
                        
                        <div class="form-group full-width" style="position: relative;">
                            <label class="form-label">
                                å®¢æˆ¶åç¨± <span class="required">*</span>
                            </label>
                            <input type="text" name="customer_name" id="newCustomerName" class="form-input" required
                                   autocomplete="off"
                                   oninput="searchCustomers(this.value)"
                                   onfocus="searchCustomers(this.value)"
                                   onblur="hideCustomerSuggestions()"
                                   placeholder="è¼¸å…¥å®¢æˆ¶åç¨±">
                            <div id="customerSuggestions" class="customer-suggestions" style="display: none;"></div>
                            <span class="form-error">å®¢æˆ¶åç¨±ä¸èƒ½ç‚ºç©º</span>
                        </div>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="form-step" data-step="2">
                    <div class="step-title">ğŸ¨ ç”¢å“è©³æƒ…</div>
                    
                    <div id="productList">
                        <div class="product-item">
                            <div class="product-item-header">
                                <div class="product-item-title">ç”¢å“ #1</div>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">
                                        ç”¢å“é¡å‹ <span class="required">*</span>
                                    </label>
                                    <select name="product_type[]" class="form-select" required>
                                        <option value="">è«‹é¸æ“‡</option>
                                        <option value="æ•¸ç¢¼å°èŠ±">æ•¸ç¢¼å°èŠ±</option>
                                        <option value="æ´»æ€§å°èŠ±">æ´»æ€§å°èŠ±</option>
                                        <option value="å†°çµ²å°èŠ±">å†°çµ²å°èŠ±</option>
                                        <option value="å†°çµ²ç¢ºå‰ªç¢¼å°èŠ±">å†°çµ²ç¢ºå‰ªç¢¼å°èŠ±</option>
                                    </select>
                                    <span class="form-error">è«‹é¸æ“‡ç”¢å“é¡å‹</span>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        ç”¢å“ç·¨è™Ÿ
                                    </label>
                                    <input type="text" name="product_code[]" class="form-input" placeholder="PRD-2026-XXX">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        æ•¸é‡
                                    </label>
                                    <input type="text" name="quantity[]" class="form-input" placeholder="ä¾‹å¦‚ï¼š500 ç¢¼">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        å–®ä½
                                    </label>
                                    <select name="unit[]" class="form-select">
                                        <option value="ç¢¼">ç¢¼</option>
                                        <option value="ç±³">ç±³</option>
                                        <option value="ä»¶">ä»¶</option>
                                        <option value="æ‰“">æ‰“</option>
                                    </select>
                                </div>

                                <div class="form-group full-width">
                                    <label class="form-label">
                                        ç”¢å“å‚™è¨»
                                    </label>
                                    <textarea name="product_notes[]" class="form-textarea" placeholder="ç”¢å“ç›¸é—œçš„ç‰¹æ®Šè¦æ±‚æˆ–å‚™è¨»"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="add-product-btn" onclick="addProduct()">
                        â• æ·»åŠ æ›´å¤šç”¢å“
                    </button>
                </div>
                
                <!-- Step 3 -->
                <div class="form-step" data-step="3">
                    <div class="step-title">ğŸ­ ç”Ÿç”¢è¨­ç½®</div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                ç”Ÿç”¢å·¥å» ï¼ˆç”Ÿç”¢é¡å‹ï¼‰
                            </label>
                            <input type="text" name="production_type" id="newProductionType" class="form-input" placeholder="ä¾‹å¦‚ï¼šå»£å·å·¥å» ">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                èŠ±å‹ç·¨è™Ÿ
                            </label>
                            <input type="text" name="pattern_code" id="newPatternCode" class="form-input" placeholder="èŠ±å‹ç·¨è™Ÿ">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                é è¨ˆäº¤è²¨æ—¥æœŸ
                            </label>
                            <input type="date" name="expected_delivery_date" id="newExpectedDeliveryDate" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                æ˜¯å¦éœ€è¦æ‰“æ¨£ï¼Ÿ
                            </label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" name="needSampling" id="needSamplingYes" value="yes" checked>
                                    <label for="needSamplingYes" class="radio-label">éœ€è¦æ‰“æ¨£</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" name="needSampling" id="needSamplingNo" value="no">
                                    <label for="needSamplingNo" class="radio-label">ç›´æ¥ç”Ÿç”¢</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group full-width">
                            <label class="form-label">
                                è¨‚å–®å‚™è¨»
                            </label>
                            <textarea name="notes" id="newNotes" class="form-textarea"
                                      placeholder="è¼¸å…¥è¨‚å–®ç›¸é—œçš„ç‰¹æ®Šè¦æ±‚ã€æ³¨æ„äº‹é …ç­‰"></textarea>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <div class="info-box-title">ğŸ’¡ æç¤º</div>
                        <div class="info-box-content">
                            â€¢ é¸æ“‡ã€Œç›´æ¥ç”Ÿç”¢ã€å°‡è·³éæ‰“æ¨£éšæ®µ<br>
                            â€¢ ä¸å¡«è¨‚å–®è™Ÿå°‡å‰µå»ºè©¢åƒ¹/ä¿®åœ–éœ€æ±‚ï¼ˆè‡ªå‹•ç”ŸæˆYUç·¨è™Ÿï¼‰<br>
                            â€¢ é è¨ˆäº¤è²¨æ—¥æœŸå¯ä»¥åœ¨å¾ŒçºŒèª¿æ•´
                        </div>
                    </div>
                </div>
                
                <!-- Step 4 -->
                <div class="form-step" data-step="4">
                    <div class="step-title">âœ… ç¢ºèªè¨‚å–®ä¿¡æ¯</div>
                    
                    <div class="order-summary">
                        <div class="summary-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>
                        <div class="summary-row">
                            <span class="summary-label">è¨‚å–®è™Ÿ</span>
                            <span class="summary-value" id="summaryOrderNumber">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">è¨‚å–®æ—¥æœŸ</span>
                            <span class="summary-value" id="summaryOrderDate">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">å®¢æˆ¶åç¨±</span>
                            <span class="summary-value" id="summaryCustomer">-</span>
                        </div>
                    </div>
                    
                    <div class="order-summary" style="margin-top: 1rem;">
                        <div class="summary-title">ğŸ¨ ç”¢å“ä¿¡æ¯</div>
                        <div id="summaryProducts">
                            <!-- å‹•æ…‹ç”Ÿæˆç”¢å“æ‘˜è¦ -->
                        </div>
                    </div>
                    
                    <div class="order-summary" style="margin-top: 1rem;">
                        <div class="summary-title">ğŸ­ ç”Ÿç”¢è¨­ç½®</div>
                        <div class="summary-row">
                            <span class="summary-label">ç”Ÿç”¢å·¥å» </span>
                            <span class="summary-value" id="summaryProductionType">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">èŠ±å‹ç·¨è™Ÿ</span>
                            <span class="summary-value" id="summaryPatternCode">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">é è¨ˆäº¤è²¨æ—¥æœŸ</span>
                            <span class="summary-value" id="summaryDeliveryDate">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">æ˜¯å¦æ‰“æ¨£</span>
                            <span class="summary-value" id="summarySampling">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">å‚™è¨»</span>
                            <span class="summary-value" id="summaryNotes">-</span>
                        </div>
                    </div>
                    
                    <div class="checkbox-group" style="margin-top: 1rem;">
                        <input type="checkbox" id="confirmCheck">
                        <label for="confirmCheck" class="checkbox-label">
                            æˆ‘å·²ç¢ºèªä»¥ä¸Šä¿¡æ¯ç„¡èª¤ï¼Œå¯ä»¥æäº¤è¨‚å–®
                        </label>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="modal-footer">
            <div class="footer-left">
                <button type="button" class="modal-btn cancel" onclick="closeNewOrderModal()">å–æ¶ˆ</button>
            </div>
            <div class="footer-right">
                <button type="button" class="modal-btn prev" id="prevBtn" onclick="prevStep()" style="display: none;">
                    â† ä¸Šä¸€æ­¥
                </button>
                <button type="button" class="modal-btn next" id="nextBtn" onclick="nextStep()">
                    ä¸‹ä¸€æ­¥ â†’
                </button>
                <button type="button" class="modal-btn submit" id="submitBtn" onclick="submitNewOrder()" style="display: none;">
                    âœ“ æäº¤è¨‚å–®
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å¿«é€Ÿæ›´æ–°å°è©±æ¡† -->
<div class="modal-overlay" id="updateModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">å¿«é€Ÿæ›´æ–°è¨‚å–®</div>
            <button class="modal-close" onclick="closeUpdateModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="status-change">
                <span id="currentStage"></span>
                <span class="status-arrow">â†’</span>
                <span class="status-new" id="nextStage"></span>
            </div>
            <div class="form-group">
                <label class="form-label">æ›´æ–°æ—¥æœŸ</label>
                <div style="display: flex; align-items: center;">
                    <input type="date" class="form-input" id="updateDate">
                    <button class="date-today-btn" onclick="setToday()">âœ“ ä»Šå¤©</button>
                </div>
                <div class="form-hint">è¨˜éŒ„æ­¤æ“ä½œçš„æ—¥æœŸï¼ˆä¾‹å¦‚ï¼šåœ–ç¨¿ç¢ºèªæ—¥æœŸï¼‰</div>
            </div>
            <div class="form-group">
                <label class="form-label">å‚™è¨»ï¼ˆå¯é¸ï¼‰</label>
                <textarea class="form-textarea" id="updateNotes" placeholder="æ·»åŠ å‚™è¨»èªªæ˜...ä¾‹å¦‚ï¼šå®¢æˆ¶å¾ˆæ»¿æ„ï¼Œç›´æ¥é€²å…¥æ‰“æ¨£"></textarea>
                <div class="form-hint">å¯ä»¥ç•™ç©ºï¼Œç³»çµ±æœƒè‡ªå‹•è¨˜éŒ„ç‹€æ…‹è®Šæ›´</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeUpdateModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="confirmUpdate()">ğŸ’¾ ç¢ºèªæ›´æ–°</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}{% endblock %}
